"use strict";(this.webpackChunk_hz_project_x=this.webpackChunk_hz_project_x||[]).push([[15957],{257e3:(e,t,r)=>{var s=r(501158).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(413209),n=r(617750),i=r(123e3),a=r(436246),d=r(251890);function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=c(o),h=c(i);const u={ACCESS_CHECK:"http://ns.adobe.com/adobecloud/rel/ac/check",ACL_POLICY:"http://ns.adobe.com/adobecloud/rel/ac/policy",ANNOTATIONS:"http://ns.adobe.com/adobecloud/rel/annotations",APP_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/application",BASE_DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory/base",BLOCK_DOWNLOAD:"http://ns.adobe.com/adobecloud/rel/download",BLOCK_EXTEND:"http://ns.adobe.com/adobecloud/rel/block/extend",BLOCK_FINALIZE:"http://ns.adobe.com/adobecloud/rel/block/finalize",BLOCK_TRANSFER:"http://ns.adobe.com/adobecloud/rel/block/transfer",BLOCK_UPLOAD_INIT:"http://ns.adobe.com/adobecloud/rel/block/init",BULK_REQUEST:"http://ns.adobe.com/adobecloud/rel/bulk",COMPONENT:"http://ns.adobe.com/adobecloud/rel/component",CREATE:"http://ns.adobe.com/adobecloud/rel/create",DESCRIBED_BY:"describedBy",DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory",DISCARD:"http://ns.adobe.com/adobecloud/rel/discard",EFFECTIVE_PRIVILAGES:"http://ns.adobe.com/adobecloud/rel/ac/effective",EMBEDDED_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/embedded",ID:"http://ns.adobe.com/adobecloud/rel/id",MANIFEST:"http://ns.adobe.com/adobecloud/rel/manifest",PAGE:"http://ns.adobe.com/adobecloud/rel/page",PATH:"http://ns.adobe.com/adobecloud/rel/path",PRIMARY:"http://ns.adobe.com/adobecloud/rel/primary",RENDITION:"http://ns.adobe.com/adobecloud/rel/rendition",REPO_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/repository",REPO_OPS:"http://ns.adobe.com/adobecloud/rel/ops",REPOSITORY:"http://ns.adobe.com/adobecloud/rel/repository",RESOLVE_BY_ID:"http://ns.adobe.com/adobecloud/rel/resolve/id",RESOLVE_BY_PATH:"http://ns.adobe.com/adobecloud/rel/resolve/path",RESTORE:"http://ns.adobe.com/adobecloud/rel/restore",VERSION_HISTORY:"version-history"};var p,_,f,m,g,E,A;function y(e){return a.isObject(e)&&["headers","responseType","statusCode","xhr"].every((t=>t in e))}function D(e){return a.isObject(e)&&y(e.response)}function C(e){return a.isObject(e)&&D(e)&&"result"in e}function I(e){return a.isObject(e)&&a.isAnyFunction(e.slice)}function v(e){return a.isObject(e)&&"resolvePullWithBranch"in e}function T(e){return a.isObject(e)&&(a.isObject(e.links)||"string"==typeof e.repositoryId&&("string"==typeof e.path||"string"==typeof e.assetId))}function b(e){return"undefined"!=typeof Blob&&e instanceof Blob}function P(e){return a.isObject(e)&&("string"==typeof e.repositoryId&&"string"==typeof e.path||"string"==typeof e.assetId)}function R(e){return a.isObject(e)&&("AdobeHTTPService"===e.name||a.isAnyFunction(e.invoke))}function w(e){return a.isObject(e)&&R(e.service)}function O(e){if(!a.isObject(e))return!1;const r=e[t.Properties.LINKS];return!!a.isObject(r)&&!!(r[u.BLOCK_TRANSFER]&&r[u.BLOCK_EXTEND]&&r[u.BLOCK_FINALIZE])}function S(e){return t=>{const r={};for(const e in t)r[e.toLowerCase()]=t[e];for(const t of e)r.hasOwnProperty(t.toLowerCase())&&delete r[t.toLowerCase()];return r}}t.Properties=void 0,(p=t.Properties||(t.Properties={})).DC_FORMAT="dc:format",p.DC_TITLE="dc:title",p.LINKS="_links",p.PAGE="_page",p.CHILDREN="children",p.EMBEDDED="_embedded",p.REPO_REPRESENTATIONS="repo:representations",p.REPO_ASSET_ID="repo:assetId",p.REPO_REPOSITORY_ID="repo:repositoryId",p.REPO_REPOSITORY_TYPE="repo:repositoryType",p.REPO_BASE_ASSET_ID="repo:baseAssetId",p.REPO_SIZE="repo:size",p.REPO_NAME="repo:name",p.REPO_PATH="repo:path",p.REPO_ASSET_CLASS="repo:assetClass",p.REPO_CREATE_DATE="repo:createDate",p.REPO_MODIFY_DATE="repo:modifyDate",p.REPO_DISCARD_DATE="repo:discardDate",p.REPO_ETAG="repo:etag",p.REPO_CREATED_BY="repo:createdBy",p.REPO_MODIFIED_BY="repo:modifiedBy",p.REPO_DISCARDED_BY="repo:discardedBy",p.REPO_DEVICE_CREATE_DATE="storage:deviceCreateDate",p.REPO_DEVICE_MODIFY_DATE="storage:deviceModifyDate",p.REPO_DEFAULT_SCHEDULED_DELETION_DURATION="repo:defaultScheduledDeletionDuration",p.REPO_ASSET_TYPE="repo:assetType",p.REPO_ASSET_SUB_TYPE="repo:assetSubType",p.STORAGE_LES="storage:les",p.REPO_SCHEDULED_DELETION_DATE="repo:scheduledDeletionDate",p.REPO_VERSION="repo:version",p.REPO_STATE="repo:state",p.REPO_AVAILABLE_REGIONS="repo:availableRegions",p.REPO_REGIONS="repo:regions",p.REPO_OWNER="repo:owner",p.REPO_OWNER_ID="id",p.REPO_OWNER_TYPE="type",p.REPO_CONTRIBUTORS="repo:contributors",p.REPO_MODIFIED_BY_CLIENT_ID="repo:modifiedByClientId",p.REPO_MODIFIED_BY_CLIENT_AGENT="repo:modifiedByClientAgent",p.REPO_MODIFIED_BY_IP_ADDRESS="repo:modifiedByIpAddress",p.STORAGE_ASSIGNEE="storage:assignee",p.STORAGE_ASSIGNEE_ID="id",p.STORAGE_ASSIGNEE_TYPE="type",p.STORAGE_REGION="storage:region",p.IMAGE_LENGTH="tiff:imageLength",p.IMAGE_WIDTH="tiff:imageWidth",p.NUM_OF_PAGES="xmpTPg:NPages",p.PAGE_START="start",p.PAGE_ORDER_BY="orderBy",p.PAGE_NEXT="next",p.PAGE_COUNT="count",p.PAGE_LIMIT="limit",p.REPO_PINNED_VERSION="repo:pinnedVersion",p.REPO_PINNED_VERSION_MODIFY_DATE="repo:pinnedVersionModifyDate",t.VersionProperties=void 0,(_=t.VersionProperties||(t.VersionProperties={})).REPO_ID="repo:id",_.CREATED="created",_.CREATED_BY="created_by",_.MILESTONE="milestone",_.VERSION="version",_.CONTRIBUTORS="contributors",_.TOTAL_CHILDREN="total_children",_.PINNED_VERSION="v:pinned",t.PolicyProperties=void 0,(f=t.PolicyProperties||(t.PolicyProperties={})).REPO_ACL="repo:acl",f.REPO_PRINCIPLE="repo:principal",f.REPO_MODIFIER="repo:modifier",f.REPO_PRIVILEGES="repo:privileges",f.REPO_RELATIONS="repo:relations",f.REPO_INHERITANCE="repo:inheritance",t.PolicyPrincipalProperties=void 0,(m=t.PolicyPrincipalProperties||(t.PolicyPrincipalProperties={})).XDM_PROVIDER="xdm:provider",m.ID="@id",m.TYPE="@type",t.XDMProviderProperties=void 0,(t.XDMProviderProperties||(t.XDMProviderProperties={})).ID="@id",t.EmbeddedMetadataMediaTypes=void 0,(g=t.EmbeddedMetadataMediaTypes||(t.EmbeddedMetadataMediaTypes={})).XML="application/rdf+xml",g.JSON="application/ld+json",t.BlockTransferProperties=void 0,(E=t.BlockTransferProperties||(t.BlockTransferProperties={})).REPO_SIZE="repo:size",E.REPO_BLOCK_SIZE="repo:blocksize",E.REPO_REL_TYPE="repo:reltype",E.COMPONENT_ID="component_id",E.DC_FORMAT="dc:format",E.REPO_MD5="repo:md5",E.REPO_EXPIRES="repo:expires",E.REPO_IF_MATCH="repo:if-match",E.MAX_SINGLE_TRANSFER_SIZE="repo:maxSingleTransferSize",E.REPO_MIN_BLOCK_TRANSFER_SIZE="repo:minBlockTransferSize",t.Constants=void 0,(A=t.Constants||(t.Constants={})).DEVICE_MODIFY_DATE="deviceModifyDate",A.REPO_META_PATCH="repoMetaPatch",A.RESPOND_WITH="respondWith";const k=n.newDebug("dcx:assets:service"),N=e=>w(e)?e.service:e,L=e=>w(e)?e.cache:void 0;function M(e,t){k("constructServiceEndpoint()",e);const r=t._repoAPIBaseUrl;return r&&(e=`${r.endsWith("/")?r.substr(0,r.length-1):r}${e}`),k("cSE()",e),e}const X={Asset:"asset",Composite:"composite",File:"file",Directory:"directory",Version:"version"};var x,B;t.HeaderKeys=void 0,(x=t.HeaderKeys||(t.HeaderKeys={})).CONTENT_ID="content-id",x.CONTENT_LENGTH="content-length",x.CONTENT_RANGE="content-range",x.CONTENT_TYPE="content-type",x.IF_MATCH="if-match",x.IF_NONE_MATCH="if-none-match",x.AUTHORIZATION="authorization",x.X_API_KEY="x-api-key",x.X_CONTRIBUTORS="x-contributors",x.LES_SEQUENCE_NUMBER="les-sequence-number",x.PREFER="prefer",x.DIRECTIVE="directive",t.HTTPMethods=void 0,(B=t.HTTPMethods||(t.HTTPMethods={})).GET="GET",B.PUT="PUT",B.PATCH="PATCH",B.HEAD="HEAD",B.POST="POST",B.DELETE="DELETE";const j="application/vnd.adobecloud.directory+json",U="application/vnd.adobe.dcx-manifest+json",V="application/json",H="application/problem+json",F="application/json-patch+json",Y="application/vnd.adobecloud.bulk-transfer+json",W="application/vnd.adobe.asset-operation+json",z=["buffer","arraybuffer","string","text","blob","json","stream","defaultbuffer"];function G(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}function q(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}function K(e){return this instanceof K?(this.v=e,this):new K(e)}const $=(e,t,r)=>{if(null==t&&null==r&&null==e)return o._defaultStatusValidator;const s=r||{},n=t||{},i=e||[];return(e,t)=>{var r,a;if(!e||!t)return new l.default(o.ErrorCodes.NETWORK_ERROR,"Invalid or missing status code",void 0,t);if(i.includes(e))return!0;const d=n[e]||(null===(r=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===r?void 0:r.message)||"Unexpected response",c=s[e]||(null===(a=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===a?void 0:a.code),h=o._defaultStatusValidator(e,t);return!0===h&&null==c||(o.isAdobeDCXError(h)?h:!!c&&new l.default(c,d,void 0,t))}},J=(e,t=[],r,s)=>{if(!a.isObject(e))throw new l.default(r||l.default.INVALID_PARAMS,s||"Missing or invalid links on Asset");t.map((t=>{if(!(t in e)||!a.isObject(e[t]))throw new l.default(r||l.default.INVALID_PARAMS,s||`Missing required link: ${t}`)}))},Z=(e={},t=[])=>{if(0!==t.length){for(let r=0;r<t.length;r++){const s=t[r];if(s in e&&a.isObject(e[s]))return s}throw new l.default(l.default.INVALID_PARAMS,`Missing links, one required: ${t.join(", ")}`)}},Q=(e,t,r,s)=>{const o=a.getLinkProperty(e,t,r);if(!o)throw new l.default(l.default.INVALID_DATA,`Missing ${r} param on Link`);if(o!==s)throw new l.default(l.default.INVALID_DATA,`Invalid ${r} param on Link, expected ${s}`)},ee=(e,t=[])=>{try{J(e,t)}catch(e){return!1}return!0},te=(e,t=[])=>!!a.isObject(e)&&ee(e.links||e._links,t);function re(e){if(!P(e))throw new l.default(l.default.INVALID_PARAMS,"Asset must contain links or repositoryId + path or assetId to be resolved.")}function se(e,t,r){if(!a.isObject(e))throw new l.default(l.default.INVALID_PARAMS,`Invalid parameter. Expected object, encountered "${null===e?"null":typeof e}".`);if(!(t in e))throw new l.default(l.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${String(t)}".`);if(r)try{a.validateParam(t,e[t],r)}catch(s){throw new l.default(l.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${String(t)}" with type "${r}", encountered type "${typeof e[t]}".`)}}function oe(e,t,r){if(!(t.length<1)){for(const s of t)try{return void se(e,s,r)}catch(e){}throw new l.default(l.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing one of [${t.join(", ")}]`+(r?` with type ${r}, encountered types [${t.map((t=>typeof e[t])).join(", ")}].`:"."))}}const ne=n.newDebug("dcx:assets:util:http");function ie(e,r,s,o=!1){return ne("headHTTPResource()"),N(e).invoke(t.HTTPMethods.HEAD,r,s,void 0,{isStatusValid:$(),skipLinksDirective:o})}function ae(e,r,s,o){return N(e).invoke(t.HTTPMethods.GET,r,s,void 0,{isStatusValid:$(),responseType:o})}const de=n.newDebug("dcx:assets:util:serialization");function ce(e,r){de("deserializeAsset()");const s={};s.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],s.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],s.name=e.name||e[t.Properties.REPO_NAME],s.size=null!=e.size?e.size:e[t.Properties.REPO_SIZE],s.path=e.path||e[t.Properties.REPO_PATH],s.assetClass=e.etag||e[t.Properties.REPO_ASSET_CLASS],s.etag=e.etag||e[t.Properties.REPO_ETAG],s.version=e.version||e[t.Properties.REPO_VERSION],s.format=e.format||e[t.Properties.DC_FORMAT],s.md5=e.md5,s.createDate=e.createDate||e[t.Properties.REPO_CREATE_DATE],s.modifyDate=e.modifyDate||e.modifiedDate||e[t.Properties.REPO_MODIFY_DATE],s.discardDate=e.discardDate||e[t.Properties.REPO_DISCARD_DATE],s.createdBy=e.createdBy||e[t.Properties.REPO_CREATED_BY],s.modifiedBy=e.modifiedBy||e[t.Properties.REPO_MODIFIED_BY],s.discardedBy=e.discardedBy||e[t.Properties.REPO_DISCARDED_BY],s.deviceCreateDate=e.deviceCreateDate||e[t.Properties.REPO_DEVICE_CREATE_DATE],s.deviceModifyDate=e.deviceModifyDate||e[t.Properties.REPO_DEVICE_MODIFY_DATE],s.defaultScheduledDeletionDuration=e.defaultScheduledDeletionDuration||e[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION],s.scheduledDeletionDate=e.scheduledDeletionDate||e[t.Properties.REPO_SCHEDULED_DELETION_DATE],s.assetType=e.assetType||e[t.Properties.REPO_ASSET_TYPE],s.assetSubType=e.assetSubType||e[t.Properties.REPO_ASSET_SUB_TYPE],s.les=e.les||e[t.Properties.STORAGE_LES],s.region=e.region||e[t.Properties.STORAGE_REGION],s.baseAssetId=e.baseAssetId||e[t.Properties.REPO_BASE_ASSET_ID],s.state=e.state||e[t.Properties.REPO_STATE],s.links=e.links||e[t.Properties.LINKS],s.representations=e.representations||e[t.Properties.REPO_REPRESENTATIONS],s.contributors=e.contributors||e[t.Properties.REPO_CONTRIBUTORS],s.width=e.width||e[t.Properties.IMAGE_WIDTH],s.length=e.length||e[t.Properties.IMAGE_LENGTH],s.pinnedVersion=e.pinnedVersion||e[t.Properties.REPO_PINNED_VERSION],s.pinnedVersionModifyDate=e.pinnedVersionModifyDate||e[t.Properties.REPO_PINNED_VERSION_MODIFY_DATE];const o=[r,e._embedded].flat();return s.embedded=Object.entries({EffectivePrivileges:u.EFFECTIVE_PRIVILAGES,RepositoryResource:u.REPOSITORY,AppMetadata:u.APP_METADATA}).reduce(((e,[t,r])=>(o.filter((e=>e&&r in e)).forEach((s=>a.merge(e,{[t]:r===u.REPOSITORY?le(s):s}))),e)),{}),a.pruneUndefined(s)}function le(e={}){de("deserializeRepository()");const r=e[u.REPOSITORY]?e[u.REPOSITORY]:e;return{repositoryId:r[t.Properties.REPO_REPOSITORY_ID],repositoryType:r[t.Properties.REPO_REPOSITORY_TYPE],owner:r[t.Properties.REPO_OWNER],createDate:r[t.Properties.REPO_CREATE_DATE],title:r[t.Properties.DC_TITLE],availableRegions:r[t.Properties.REPO_AVAILABLE_REGIONS]}}function he(e){const r=[];return e.assetType&&r.push({op:"add",path:`/${[t.Properties.REPO_ASSET_TYPE]}`,value:e.assetType}),e.assetSubType&&r.push({op:"add",path:`/${[t.Properties.REPO_ASSET_SUB_TYPE]}`,value:e.assetSubType}),r}const ue=n.newDebug("dcx:assets:util:link");function pe(e,t){ue("getIndexLinks()");const r=N(e),s=L(e);if(s){const e=s.getIndexLinks();if(e)return h.default.resolve(e);s.setPending("INDEX")}return ie(r,M("/",r),t,!0).then((e=>fe(e))).then((e=>(s&&s.setIndexLinks(e),e))).catch((e=>{throw s&&s.delete("INDEX"),e}))}function _e(e,r){ue("getIndexDocument()");const s=N(e),o=L(e);if(o){const e=o.getIndexRepository();if(e)return h.default.resolve(e)}const n=M("/",s);return s.invoke(t.HTTPMethods.GET,n,r,void 0,{responseType:"json",isStatusValid:$(),skipLinksDirective:!0}).then((e=>{const r=fe(e),s=e.response,n={};for(const e in s.children){const r=s.children[e],o=r[t.Properties.LINKS];switch(r[t.Properties.REPO_PATH]){case"/Index.json":n.indexLinks=o;break;case"/Assets.json":n.assetLinks=o;break;case"/Repositories.json":n.repositoryLinks=o}}return o&&(o.setIndexLinks(r),o.setIndexRepository(n)),n}))}function fe(e){if(!e.headers)throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, missing headers");const t=e.headers.link||e.headers["api-link"];if(!t)throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, missing link header");return me(t)}function me(e){try{const r=a.parse(e),s={};for(const e in r.refs){const o=r.refs[e],{rel:n,uri:i,templated:d,type:c,width:l,height:h}=o,u=G(o,["rel","uri","templated","type","width","height"]),p=a.pruneUndefined({href:i,templated:d?"true"===d:void 0,type:c,width:l,height:h,[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE]:u[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE.toLowerCase()],[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE]:u[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE.toLowerCase()]});["width","height"].filter((e=>e in p)).forEach((e=>{const t=parseInt(p[e],10);isNaN(t)||(p[e]=t)}));const _=s[n];Array.isArray(_)?_.push(p):s[n]=_?[_,p]:p}return Object.assign({},s)}catch(e){throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, invalid link header",e)}}function ge(e,t){if(a.isObject(this)){if("string"==typeof this.opsHref)return h.default.resolve(this.opsHref);if(a.isAnyFunction(this.opsHref))return h.default.resolve(this.opsHref())}return pe(e,t).then((e=>{try{return a.getLinkHref(e,u.REPO_OPS)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ops href.",e)}}))}const Ee=n.newDebug("dcx:assets:operations"),Ae=n.newDebug("dcx:assets:operations:builder");function ye(e,t,r,s,o,n,i,d){Ee("copyAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0],["manifestPatch",i,["object","string"],!0]),oe(t,["repo:path","path","assetId","repo:assetId"],"string"),oe(r,["repo:path","path","assetId","repo:assetId"],"string");const c=Be("copy",r,t,{overwriteExisting:o,createIntermediates:s},a.pruneUndefined({"repo:manifestPatch":JSON.stringify(i),nameConflictPolicy:d})),l=N(e);return ge.call(this,e).then((e=>we(l,e,c,n))).then(Le.bind(void 0,r)).then(Me)}const De=e=>"string"==typeof e?{reltype:e,component_id:"",revision:""}:e;function Ce(e,t,r,s,o,n,i){Ee("moveAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0]),oe(t,["repo:path","path","assetId","repo:assetId"],"string"),oe(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Be("move",r,t,{createIntermediates:s,overwriteExisting:o},a.pruneUndefined({nameConflictPolicy:i})),c=N(e);return ge.call(this,e).then((e=>we(c,e,d,n))).then(Le.bind(void 0,r)).then(Me)}function Ie(e,t,r,s,o){Ee("discardAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["etag",r,"string",!0],["recursive",s,"boolean",!0]);const n=N(e);oe(t,["repo:path","path","assetId","repo:assetId"],"string");const i=Be("discard",Object.assign(Object.assign({},t),{etag:r}),void 0,{recursive:s});return ge.call(this,e).then((e=>we(n,e,i,o))).then(Xe)}const ve=d.telemetrySpan("AdobeDCX.deleteAsset",(function(e,r,s="*",o,n){Ee("deleteAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0],["recursive",o,"boolean",!0]),d.setTracingSpanAttribute("mediaType",r.format),d.setTracingSpanAttribute("assetId",r.assetId);const i=N(e);if(r.format===j&&null==o)throw new l.default(l.default.INVALID_PARAMS,"Recursive flag is required for directory assets.");if(!o&&te(r,[u.REPO_METADATA])){const e=a.getLinkHrefTemplated(r,u.REPO_METADATA,{version:r.version||t.VersionProperties.PINNED_VERSION});return i.invoke("DELETE",e,{[t.HeaderKeys.IF_MATCH]:s},void 0,{isStatusValid:$()}).then(Xe)}oe(r,["repo:path","path","assetId","repo:assetId"],"string");const c=Object.create(Object.getPrototypeOf(r),Object.getOwnPropertyDescriptors(r));c.etag=s;const h=Be("delete",c,void 0,{recursive:o});return ge.call(this,e).then((e=>we(i,e,h,n))).then(Xe)}));function Te(e,t,r,s){Ee("restoreAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const o=N(e);oe(t,["assetId","repo:assetId"],"string");const n=Be("restore",t,void 0,void 0,{nameConflictPolicy:s});return ge.call(this,e).then((e=>we(o,e,n,r))).then(Le.bind(void 0,t)).then(Me)}function be(e,t,r,s,o,n){var i;Ee("packageAssets()"),a.validateParams(["svc",e,"object"],["destination",r,"object"]),a.validateParam("sources",t,["object","object[]"]),t=a.isArray(t)?t:[t],i=["repo:path","path","assetId","repo:assetId"],t.map((e=>oe(e,i,"string"))),oe(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Be("package",r,t,{createIntermediates:s,overwriteExisting:o}),c=N(e);return ge.call(this,e).then((e=>we(c,e,d,n))).then(Le.bind(void 0,r)).then(Xe)}function Pe(e){return{result:(a.isArray(e.response)?e.response:[e.response]).map(Re),response:e}}function Re(e){if(!e.error)return e;const t=Object.assign({},e),r=$()(e.error.status);return t.error=o.isAdobeDCXError(r)?r:new l.default(l.default.UNEXPECTED,"Unexpected response"),t._additionalData=e.error,t.error._message=e.error.title,t}function we(e,t,r,s,n=!1){return Ee("doOperation()"),a.validateParams(["svc",e,"object"],["opsEndpoint",t,"string"],["operationDocument",r,["string","object"]],["additionalHeaders",s,"object",!0]),Ne(e,t,r,s,n).then(o._handleErrorResponsePayload)}class Oe{constructor(){this.opBatchLimit=100,this._docs=[]}getDocumentEntry(e){return this._docs[e]}getDocument(){return this._docs}get entryCount(){return this._docs.length}copyResources(e,t,r,s,o,n){Ae("copyResource()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const i=this._docs.find(function(e,t){return function(r){return"copy_resources"===r.op&&ke(r.source,e)&&ke(r.target,t)}}(e,t));if(i)return i.resources=i.resources.concat(r),o&&(i["repo:manifestPatch"]=JSON.stringify(o)),void 0!==s&&(i.intermediates=s),this;const a=Be("copy_resources",t,e,{createIntermediates:s},{resources:r,"repo:manifestPatch":JSON.stringify(o),additionalHeaders:n});return this._docs.push(a),this}copy(e,t,r,s,o){Ae("copy()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=Be("copy",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}move(e,t,r,s,o){Ae("move()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=Be("move",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}package(e,t,r,s,o){Ae("package()"),this._assertUnderLimit(),(e=a.isArray(e)?e:[e]).map((e=>{this._checkSourceType(e)})),this._checkTargetType(t);const n=Be("package",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}discard(e,t,r){Ae("discard()"),this._assertUnderLimit(),this._checkTargetType(e);const s=Be("discard",e,void 0,{recursive:t},r);return this._docs.push(s),this}restore(e,t){Ae("restore()"),this._assertUnderLimit(),oe(e,["assetId","repo:assetId"],"string"),this._checkTargetType(e);const r=Be("restore",e,void 0,void 0,t);return this._docs.push(r),this}delete(e,t,r){Ae("delete()"),this._assertUnderLimit(),this._checkTargetType(e);const s=Be("delete",e,void 0,{recursive:t},r);return this._docs.push(s),this}_assertUnderLimit(){if(this._docs.length>=this.opBatchLimit)throw new l.default(l.default.INVALID_STATE,`Exceeds limit of ${this.opBatchLimit} operations in a single batch.`)}_checkTargetType(e){this._checkSourceOrTargetType(e,"Target")}_checkSourceType(e){this._checkSourceOrTargetType(e,"Source")}_checkSourceOrTargetType(e,t){if(0===[!!e.assetId||!!e["repo:assetId"],!!e.path||!!e["repo:path"]].filter((e=>e)).length)throw new l.default(l.default.INVALID_PARAMS,`${t} identifier is underspecified. Exactly one of [href, repo:path, repo:assetId] required.`);const r=this._getSourceType(e),s="Source"===t?this._batchSourceType:this._batchTargetType;if(s){if(r!==s)throw new l.default(l.default.INVALID_PARAMS,`Operation ${t.toLowerCase()} types must all be the same type. Expected ${s}, encountered ${r}.`)}else"Source"===t?this._batchSourceType=r:this._batchTargetType=r}_getSourceType(e){return e.assetId||e["repo:assetId"]?"id":e.path||e["repo:path"]?e.baseAssetId||e["repo:baseAssetId"]?"pathAndBaseAssetId":"path":void 0}}function Se(){return new Oe}function ke(e,r){var s,o;return e[t.Properties.REPO_ASSET_ID]===(null!==(s=r[t.Properties.REPO_ASSET_ID])&&void 0!==s?s:r.assetId)&&e[t.Properties.REPO_REPOSITORY_ID]===(null!==(o=r[t.Properties.REPO_REPOSITORY_ID])&&void 0!==o?o:r.repositoryId)}function Ne(e,r,s,o={},n=!1){return e.invoke(t.HTTPMethods.POST,r,Object.assign({[t.HeaderKeys.CONTENT_TYPE]:W},o),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:$(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"get",modifyHeadersCallback:S([t.HeaderKeys.PREFER]),skipPollingTimeout:n}})}function Le(e,t){return t.response.asset=Object.assign(Object.assign({},t.response.asset||{}),{repositoryId:e.repositoryId||e["repo:repositoryId"]}),t}function Me(e){return{response:e,result:ce(e.response.asset)}}function Xe(e){return{response:e,result:{success:e.statusCode>199&&e.statusCode<400}}}function xe(e,r,s){if(Ee("_convertToACPSource()"),"object"!=typeof r)return;const o={"repo:repositoryId":r.repositoryId||r["repo:repositoryId"],"repo:path":r.path||r["repo:path"],"repo:assetId":r.assetId||r["repo:assetId"],"repo:baseAssetId":r.baseAssetId||r["repo:baseAssetId"]};return"string"==typeof o.href?(delete o["repo:path"],delete o["repo:assetId"],delete o["repo:baseAssetId"]):"string"==typeof o["repo:assetId"]&&(delete o["repo:path"],delete o["repo:baseAssetId"]),"target"===e?!0===s?o[t.HeaderKeys.IF_MATCH]=r.format!==X.Directory&&r["dc:format"]!==X.Directory&&r.etag||"*":!1===s?o[t.HeaderKeys.IF_NONE_MATCH]="*":r.format!==X.Directory&&r["dc:format"]!==X.Directory&&(o[t.HeaderKeys.IF_MATCH]=r.etag):r.format!==X.Directory&&r["dc:format"]!==X.Directory&&(o[t.HeaderKeys.IF_MATCH]=r.etag||"*"),r.version&&(o["repo:version"]=r.version),o["repo:path"]&&se(o,"repo:repositoryId","string"),Ee("_cTACPS() out",o),a.pruneUndefined(o)}function Be(e,t,r,s={},o={}){Ee("_buildOperationDoc()");const n=a.pruneUndefined({op:e,target:t,source:a.isArray(r)?[]:r?{}:void 0}),{overwriteExisting:i,createIntermediates:d,recursive:c}=s;if(n.source&&(n.source=a.isArray(r)?r.map((e=>xe("source",e,i))).filter((e=>null!=e)):xe("source",r,i)),"object"==typeof t){const e=xe("target",t,i);e&&(n.target=e)}return null==n.target["repo:assetId"]&&null!=d&&(n.intermediates=d),null!=c&&(n.recursive=c),Object.assign(n,o),Ee("_OD() doc",n),n}function je(e,t,r,s,o,n,i){if(a.validateParams(["resources",s,"array",!1]),s.length<=500){const a=Se().copyResources(t,r,s,o,n).getDocument();return ge(e).then((t=>we(N(e),t,a,i,!0))).then((e=>{const{asset:t,source:r,target:s,resources:o}=e.response[0];return{result:{source:ce(r),target:ce(s),resources:o,asset:t?ce(t):void 0},response:e}}))}return function(e,t,r,s,o,n,i,d){a.validateParams(["resources",s,"array",!1]);const c=[];for(let e=0;e<s.length;e+=500)c.push(s.slice(e,e+500));let u;function p(s,o){const a=Se().copyResources(t,r,o,n,i).getDocument();return ge(e).then((t=>we(N(e),t,a,d,!0))).then((e=>{u?u.response[0].resources.push(...e.response[0].resources):u=e;const{asset:t,source:r,target:o,resources:n}=e.response[0],i={source:ce(r),target:ce(o),resources:n,asset:t?ce(t):void 0};return Object.assign(Object.assign({},i),{resources:[...null==s?void 0:s.resources,...i.resources],asset:i.asset||s.asset})}))}let _=h.default.resolve({resources:[],source:{},target:{}});for(const e of c)_=_.then((t=>p(t,e)));return _.then((e=>{if(!u)throw new l.default(l.default.UNEXPECTED_RESPONSE,"No response received from copy resources operation");return{result:e,response:u}}))}(e,t,r,s,0,o,n,i)}var Ue;t.BlockTransferStates=void 0,(Ue=t.BlockTransferStates||(t.BlockTransferStates={})).NOT_INITIALIZED="NOT_INITIALIZED",Ue.INITIALIZING="INITIALIZING",Ue.INITIALIZED="INITIALIZED",Ue.WAITING="WAITING",Ue.STARTED="STARTED",Ue.PAUSING="PAUSING",Ue.PAUSED="PAUSED",Ue.CANCELED="CANCELED",Ue.ERROR="ERROR",Ue.FINALIZING="FINALIZING",Ue.COMPLETE="COMPLETE";const Ve=new class{constructor(){this._uploads=[],this._downloads=[],this._pendingUploadRequests=[],this._pendingDownloadRequests=[],this._downloadChunkSize=10485760}get downloads(){return this._downloads}get uploads(){return this._uploads}set downloadChunkSize(e){a.validateParams(["downloadChunkSize",e,"+number"]),this._downloadChunkSize=e}get downloadChunkSize(){return this._downloadChunkSize}get pendingUploadRequests(){return this._pendingUploadRequests}get pendingDownloadRequests(){return this._pendingDownloadRequests}resetUploads(){this._uploads=[],this._pendingUploadRequests=[]}addAndStartUpload(e){return this._addAndStart("upload",e)}addAndStartDownload(e){return e.state!==t.BlockTransferStates.INITIALIZED?Promise.resolve(e):this._addAndStart("download",e)}startNextWaiting(e){const r="upload"===e?this._uploads:this._downloads,s=[];let o=!1;for(const e of r)!o&&e&&e.state===t.BlockTransferStates.WAITING?(e.start(),o=!0):e.state!==t.BlockTransferStates.CANCELED&&e.state!==t.BlockTransferStates.ERROR&&e.state!==t.BlockTransferStates.FINALIZING&&e.state!==t.BlockTransferStates.COMPLETE||s.push(e);const n=r.filter((e=>!s.includes(e)));"download"===e?this._downloads=n:this._uploads=n}_addAndStart(e,r){const s="upload"===e?this._uploads:this._downloads;return 0===s.filter((e=>e&&(e.state===t.BlockTransferStates.NOT_INITIALIZED||e.state===t.BlockTransferStates.INITIALIZED||e.state===t.BlockTransferStates.INITIALIZING||e.state===t.BlockTransferStates.STARTED))).length?r.start():r._setWaiting(),s.push(r),r.promise}},He=n.newDebug("dcx:assets:blockdownload"),Fe=n.newDebug("dcx:assets:blockdownload:leaf"),Ye=function*(){let e=0;for(;;)yield e++}();class We extends a.EventEmitter{constructor(e,r,s={}){super(["stateChanged"]),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._cachedBlocks=new Map,this._blockRequestIndex=0,this._blockHandledIndex=0,this._currentByteRange=[void 0,void 0],this._pending=[],He("constructor");const{startByte:o,blockSize:n,endByte:i,url:d,totalSize:c,maxConcurrentRequests:l}=Object.assign({blockSize:Ve.downloadChunkSize,maxConcurrentRequests:4},a.pruneUndefined(s));a.validateParams(["svc",e,"object"],["responseType",r,"enum",!1,["buffer"]],["blockSize",n,"+number"],["url",d,"string",!0],["startByte",o,"number",!0],["endByte",i,"number",!0],["totalSize",c,"number",!0],["maxConcurrentRequests",l,"+number"]),this._dbgId=Ye.next().value,this._maxConcurrentRequests=l,this._blockSize=Math.round(n),this._service=e,this._url=d,this._startByte=o,this._endByte=i,this._totalSize=c,this._bytes=new Uint8Array,this._promise=new h.default(((e,t)=>{this._resolve=()=>{He(this._dbgId,"resolving"),this.removeAllHandlers(),e(this)},this._reject=e=>{He(this._dbgId,"rejecting: ",e),this.removeAllHandlers(),t(e)}}))}get contentType(){var e;return null!==(e=this._contentType)&&void 0!==e?e:""}get totalSize(){return this._totalSize}get buffer(){return this._bytes}get state(){return this._state}get promise(){return this._promise}_requestBlock(e,r,s,o){He(this._dbgId,"_requestBlock(): ",e,r,s,o);const n=Ke(e,r);return this._service.invoke(t.HTTPMethods.GET,this._url,n,void 0,{responseType:"defaultbuffer",isStatusValid:$(),isExternalRequest:!0}).then((e=>({response:e,index:s,lane:o}))).catch(this._handleErrorAndThrow.bind(this))}init(e=this._url,r=this._totalSize){if(He(this._dbgId,"init(): ",e,r),this._state===t.BlockTransferStates.INITIALIZED&&e===this._url&&r===this._totalSize)return h.default.resolve(this);if(this._assertStateIsValid("init"),this._shiftState(t.BlockTransferStates.INITIALIZING),this._url=e,this._initByteRange(r),this._totalSize!==1/0||null==this._currentByteRange[0])return this._shiftState(t.BlockTransferStates.INITIALIZED),h.default.resolve(this);const{startByte:s,endByte:o,blockIndex:n}=this._nextBlockData();let i=t.BlockTransferStates.INITIALIZED;return this._requestBlock(s,o,n,0).then((e=>(this._updateTotalSize(e),(!o||o>this._endByte)&&(i=t.BlockTransferStates.FINALIZING),e))).then(this._handleBlock.bind(this)).then((()=>this._shiftState(i))).catch(this._handleErrorAndThrow.bind(this))}start(){if(He(this._dbgId,"start()"),this._assertStateIsValid("start"),this._shiftState(t.BlockTransferStates.STARTED),null!=this._currentByteRange[0])return this._start(),this._promise;const[e,r]=this._currentByteRange,s=this._blockRequestIndex;return this._blockRequestIndex+=1,this._currentByteRange=[r+1,r],this._requestBlock(e,r,s,0).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this)),this._promise}pause(){return He(this._dbgId,"pause()"),this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),h.default.allSettled(this._pending).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),Ve.startNextWaiting("download"),this)))}resume(){return He(this._dbgId,"resume()"),this.state===t.BlockTransferStates.PAUSED&&(this._shiftState(t.BlockTransferStates.STARTED),this._start()),this}cancel(){return He(this._dbgId,"cancel()"),this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),this._reject(new l.default(l.default.ABORTED,"BlockDownload aborted.")),Ve.startNextWaiting("download"),this._promise}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}_start(){He(this._dbgId,"_start()");for(let e=0;e<this._maxConcurrentRequests;e++)this._loop(e).catch(this._handleError.bind(this))}get _loopShouldContinue(){const e=this._state===t.BlockTransferStates.STARTED&&this._currentByteRange[0]<=this._endByte;return He(this._dbgId,"_loopShouldContinue() ",e,this._currentByteRange,this._endByte),e}_loop(e){return q(this,void 0,void 0,(function*(){He(this._dbgId,"_loop(): ",e);let r=!1;for(;this._loopShouldContinue&&!r;){const{startByte:t,endByte:s,blockIndex:o,done:n}=this._nextBlockData();r=n;const i=this._requestBlock(t,s,o,e).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this));this._pending[e]=i,yield i}He(this._dbgId,`_loop(${e}) done, ${r}`),r&&(He(this._dbgId,`_loop(${e}) finalize`),this._shiftState(t.BlockTransferStates.FINALIZING))}))}_nextBlockData(){He(this._dbgId,"_nextBlockData()");const e=this._blockRequestIndex;this._blockRequestIndex+=1;const[t,r]=this._currentByteRange;return this._currentByteRange[0]+=this._blockSize,this._currentByteRange[1]=Math.min(this._currentByteRange[1]+this._blockSize,this._endByte),{startByte:t,endByte:r,blockIndex:e,done:r>=this._endByte}}_initByteRange(e=this._totalSize){if(He(this._dbgId,"_initByteRange(): ",e),this._totalSize=e,null!=this._totalSize&&this._totalSize<0)throw new l.default(l.default.INVALID_PARAMS,"Total size must be positive.");if(this._totalSize||(this._totalSize=1/0),this._endByte||(this._endByte=this._totalSize),!this._startByte&&this._endByte===this._totalSize)return this._startByte=0,void(this._currentByteRange=[0,this._blockSize-1]);if(!this._startByte&&this._endByte<0&&this._totalSize!==1/0?(this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize):!this._startByte&&this._endByte>0&&(this._startByte=0),null!=this._startByte&&(this._currentByteRange[0]=Math.max(this._startByte,0)),(null==this._endByte||this._endByte>0)&&(this._currentByteRange[1]=Math.min(this._endByte,(this._startByte||0)+this._blockSize-1)),null!=this._startByte||this._endByte===1/0)return;if(this._totalSize===1/0){if(-this._endByte>this._blockSize)throw new l.default(l.default.INVALID_PARAMS,"Cannot download last N bytes without a total size.");return void(this._currentByteRange=[void 0,this._endByte])}this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize;const t=Math.min(this._startByte+this._blockSize-1,this._endByte);this._currentByteRange=[this._startByte,t]}_finalize(){return He(this._dbgId,"_finalize() start"),Ve.startNextWaiting("download"),h.default.allSettled(this._pending).then((()=>{this._checkCachedBlocks(),this._shiftState(t.BlockTransferStates.COMPLETE)}))}_updateTotalSize(e){if(He(this._dbgId,"_updateTotalSize()"),null==this._totalSize||this._totalSize===1/0)try{const t=e.response.headers["content-range"],r=parseInt(t.split("/")[1]);a.assert((()=>!isNaN(r)),"Invalid number."),this._totalSize=r,this._endByte===1/0&&(this._endByte=this._totalSize)}catch(t){throw new l.default(l.default.INVALID_DATA,"Could not determine total size.",t,e.response)}return He(this._dbgId,"_uTS(): ",this._totalSize,this._endByte),e}_handleError(e){He(this._dbgId,"_handleError(): ",e),this._shiftState(t.BlockTransferStates.ERROR),this._error=e,o.isAdobeDCXError(e)||(this._error=new l.default(l.default.UNEXPECTED,"An unexpected error occurred.",e)),this._reject(this._error)}_handleErrorAndThrow(e){throw this._handleError(e),this._error}_handleBlock(e){this._endByte===1/0&&this._updateTotalSize(e);const{index:t,response:r}=e;if(He(this._dbgId,`_handleBlock(${t})`),t!==this._blockHandledIndex)return He(this._dbgId,`_handleBlock(${t}) cached`),void this._cachedBlocks.set(t,e);He(this._dbgId,`_handleBlock(${t}) handled`),this._pushBlockData(r),this._markCurrentBlockHandled()}_markCurrentBlockHandled(){this._cachedBlocks.delete(this._blockHandledIndex),this._blockHandledIndex+=1,this._checkCachedBlocks()}_checkCachedBlocks(){const e=this._cachedBlocks.get(this._blockHandledIndex);e&&this._handleBlock(e)}_pushBlockData(e){if(this._state===t.BlockTransferStates.ERROR)return;this._contentType=this._contentType||e.headers[t.HeaderKeys.CONTENT_TYPE];const r=void 0!==s&&e.response instanceof s?e.response:new Uint8Array(e.response);this._bytes=a.concatUint8Arrays(this._bytes,r)}_shiftState(e){return He(this._dbgId,"_shiftState(): ",e),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state,this]),e===t.BlockTransferStates.FINALIZING&&this._finalize(),e===t.BlockTransferStates.COMPLETE&&Promise.all(this._pending).then(this._resolve.bind(this))),this}_assertStateIsValid(e,r=this._state){He(this._dbgId,"_assertStateIsValid() ",e,r);let s=!1;const o="Invalid state transition.";switch(e){case"init":r===t.BlockTransferStates.NOT_INITIALIZED&&(s=!0);break;case"start":r!==t.BlockTransferStates.INITIALIZED&&r!==t.BlockTransferStates.WAITING&&r!==t.BlockTransferStates.STARTED||(s=!0);break;case"pause":r!==t.BlockTransferStates.INITIALIZING&&r!==t.BlockTransferStates.STARTED||(s=!0);break;case"cancel":s=!0}if(!s)throw He(this._dbgId,"_aSIV() throw ",o),new l.default(l.default.INVALID_STATE,o,void 0,void 0,{method:e,currentState:r})}}function ze(e,t,r){return new We(e,t,r)}function Ge(e,r,s,o,n="defaultbuffer",i,d,c){Fe("_doBlockDownload()");const u="stream"===n?void 0:ze(e,"buffer",{startByte:s,endByte:o});(null!=this?this:{}).blockDownload=u;let p=h.default.resolve(r,void 0!==this?this:{});return i||(p=p.then((()=>e.invoke(t.HTTPMethods.GET,r,Object.assign({priority:"u=1"},c),void 0,{responseType:"text",isStatusValid:$(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}}))).then((e=>{const t=e.response.indexOf("href")>0?a.getFirstRegexpCapture(e.response,'"href":\\s*"([^;"]*)"'):"";if("string"!=typeof t||""===t)throw new l.default(l.default.UNEXPECTED_RESPONSE,"No block download href found in response.",void 0,e);return d=d||parseInt(a.getFirstRegexpCapture(e.response,'"size":\\s*(\\d+)')),t}))),p.then((r=>q(this,void 0,void 0,(function*(){return u?Promise.race([u.init(r,d).then((()=>Ve.addAndStartDownload(u))),u.promise]).then((()=>({statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:u.contentType,[t.HeaderKeys.CONTENT_LENGTH]:u.totalSize}),responseType:n,response:qe(u.buffer,n,u.contentType),message:"OK"}))):e.invoke(t.HTTPMethods.GET,r,Ke(s,o),void 0,{responseType:"stream",isExternalRequest:!0})}))))}function qe(e,t,r){if("defaultbuffer"===t||"buffer"===t||"arraybuffer"===t)return e.buffer;if("blob"===t)return new Blob([e],{type:r});const s=a.arrayBufferToString(e);if("text"===t)return s;try{return JSON.parse(s)}catch(e){return s}}function Ke(e,t){return null==e&&null==t?{}:{range:`bytes=${null!=e?e:null!=t&&t>0?"0":""}-${null!=t?Math.abs(t):""}`}}const $e=n.newDebug("dcx:assets:private");function Je(e,r,s,n,i="defaultbuffer",d,c,l={},p=!1){let _;$e("_getUrlFallbackDirect()");const f=void 0!==this?this:{};return h.default.resolve(void 0,f).then((()=>e.invoke(t.HTTPMethods.GET,s,Object.assign({priority:"u=1"},l),void 0,{responseType:i,isStatusValid:$([400])}))).then((e=>($e("_gUFD() status code",e.statusCode),_=e,400===e.statusCode&&e.xhr?e.xhr.getResponseDataAsJSON():e))).then((e=>{const t=a.isObject(e)&&(400===_.statusCode||400===e.status)&&e.type===o.ProblemTypes.RESPONSE_TOO_LARGE;if($e("_gUFD() do direct",t),!t&&400===_.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,_);return t})).then((s=>{if(!s)return _;if(!("location"in _.headers)||"string"!=typeof _.headers.location||"location"in _.headers&&_.headers.location.includes("platform")){if(!ee(r.links,[u.BLOCK_DOWNLOAD]))throw new o.DCXError(o.DCXError.INVALID_DATA,"Resource too large and missing download link.");const s=a.pruneUndefined({reltype:n,component_id:d,revision:c}),h=a.getLinkHrefTemplated(r.links,u.BLOCK_DOWNLOAD,{resource:n?JSON.stringify(s):void 0,version:r.version||t.VersionProperties.PINNED_VERSION});return p?{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:_.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:_.headers["content-length"]}),responseType:i,response:{href:h},message:"OK"}:Ge.call(f,e,h,void 0,void 0,i,!1,void 0,l)}return p?{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:_.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:_.headers["content-length"]}),responseType:i,response:{href:_.headers.location},message:"OK"}:Ge.call(f,e,_.headers.location,void 0,void 0,i,!0,void 0,l)}))}function Ze({additionalHeaders:e={},asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:l,relation:h,service:u},p=!1){if($e("_doUpload()"),a.validateParams(["service",u,"object"],["asset",r,"object"],["href",c,"string"],["headHref",d,"string"],["contentType",s,"string",!0],["maybeIsNew",l,"boolean",!0],["etag",i,"string",!0],["isRetry",p,"boolean",!0],["additionalHeaders",e,"object",!0]),null==l)return u.invoke(t.HTTPMethods.HEAD,d,e,void 0,{isStatusValid:$([404])}).then((t=>{const o=200!==t.statusCode;return Ze({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:o,relation:h,service:u},p)}));const _=l;return _?delete e[t.HeaderKeys.IF_MATCH]:e[t.HeaderKeys.IF_MATCH]=i||"*",s&&(e[t.HeaderKeys.CONTENT_TYPE]=s),u.invoke(t.HTTPMethods.PUT,c,e,n,{isStatusValid:$([404,409,412]),retryOptions:{pollHeader:"location",pollCodes:[202]}}).then((t=>{const a=t.statusCode;if(a>400&&!p){if(null!=i)throw $()(a,t);if(!_&&404===a)return Ze({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:!0,relation:h,service:u},!0);if(404===a)throw new o.DCXError(o.DCXError.NOT_FOUND,"Unexpected response",void 0,t);if(409===a||412===a)return Ze({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:void 0,relation:h,service:u},!0)}return t}))}const Qe=n.newDebug("dcx:assets:bulk");function et(e,r){const s="\r\n";let o=Uint8Array.from([]);for(let n=0;n<e.length;n++){const i=e[n];o=0===n?a.concatUint8Arrays(o,a.stringToBuffer(`--${r}${s}`)):a.concatUint8Arrays(o,a.stringToBuffer(`${s}--${r}${s}`)),o=a.concatUint8Arrays(o,a.stringToBuffer(`${[t.HeaderKeys.CONTENT_TYPE]}: application/http${s}`)),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${i.method} ${i.href}`));let d=!1;for(const e in i.headers){const t=e.toLowerCase();"content-length"===t&&(d=!0),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${t}: ${i.headers[e]}`))}if(i.body){const e=tt(i.body);d||(o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}content-length: ${e.length}`))),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${s}`)),o=a.concatUint8Arrays(o,e)}}return o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}--${r}--${s}`)),o}function tt(e){if("string"==typeof e)return a.stringToBuffer(e);if(a.isArrayBuffer(e))return new Uint8Array(e);if(I(e))return e;throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Bulk subrequest body expecting string | ArrayBuffer | Buffer")}function rt(e,r){const s=e.headers[t.HeaderKeys.CONTENT_TYPE];if(!s)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,"Missing boundary header in multipart response");const n=s.split("=")[1],i=function(e,t){const r=new Uint8Array(e),s=a.stringToBuffer(`--${t}`);return ot(r,st(r,s),s.byteLength).map((e=>nt(e,!0)))}(e.response,n);if(r&&i.length!==r)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,`Unexpected number of parts; Expected ${r}, Received ${i.length}`);return i}function st(e,t){const r=new Array(256).fill(-1),s=[];for(let e=0;e<t.length;e++)r[t[e]]=e;let o=0;for(;o<=e.length-t.length;){let n=t.length-1;for(;n>=0&&t[n]===e[o+n];)n--;n<0?(s.push(o),o+=o+t.length<e.length?t.length-r[e[o+t.length]]:1):o+=Math.max(1,n-r[e[o+n]])}return s}function ot(e,t,r,s=!1){let o=s?0:void 0;const n=[];for(const s of t)void 0!==o&&n.push(e.subarray(o,s)),o=s+r;return s&&n.push(e.subarray(o)),n}function nt(e,r=!1){const s=a.stringToBuffer("\r\n\r\n"),o=st(e,s).slice(0,2),n=a.stringToBuffer("\n\n"),i=ot(e,...o.length>0?[o,s.byteLength]:[st(e,n).slice(0,2),n.byteLength],!0),d=i.slice(0,r||i.length>1?2:1).reduce(((e,t)=>Object.assign(e,a.parseHeaders(a.arrayBufferToString(t)))),{}),c=i.length>1?i[i.length-1]:void 0,l=parseInt(a.arrayBufferToString(i[r?1:0]).split("\r\n",1)[0].split(" ")[1]),h=parseInt(d["content-length"],10);let u;return u=isNaN(h)?0===(null==c?void 0:c.length)?new Uint8Array([]):c:0===h?new Uint8Array([]):null==c?void 0:c.subarray(0,h),{headers:d,response:d[t.HeaderKeys.CONTENT_TYPE]===H&&void 0!==u?JSON.parse(a.arrayBufferToString(u)):u,statusCode:l}}function it(e){if(e.length>10)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A single bulk request can only contain a maximum of 10 sub-requests.");const{writeOperations:r,readOperations:s}=e.reduce(((e,r)=>{if("string"!=typeof r.href)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing an href");if("string"!=typeof r.method)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing the HTTP method");const s=r.method.toUpperCase();if(!Object.values(t.HTTPMethods).includes(s))throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation includes an invalid HTTP method");return[t.HTTPMethods.GET,t.HTTPMethods.HEAD].includes(s)?e.readOperations.push(r):e.writeOperations.push(r),e}),{readOperations:[],writeOperations:[]});if(r.length>0&&s.length>0)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Cannot mix READ and WRITE operations in bulk sub requests.")}function at(e,t,r,s="id",o={},n=!1){return Qe("performBulkRequest()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["requests",r,"array"],["linkMode",s,"string",!0,["id","path"]]),J(t.links,[u.BULK_REQUEST]),it(r),dt(e,t,r,s,o).then((({response:i,subresponses:a})=>q(this,void 0,void 0,(function*(){const d=ct(a,r);return{result:n?yield lt(e,t,d,s,o,a):a,response:i}}))))}function dt(e,r,s,o="id",n={}){const i=`boundary-${Date.now()}`,d=et(s,i),c=Object.assign(Object.assign({},n),{[t.HeaderKeys.CONTENT_TYPE]:`multipart/mixed;boundary=${i}`}),l=a.getLinkHrefTemplated(r.links,u.BULK_REQUEST,{},o);return e.invoke(t.HTTPMethods.POST,l,c,d,{isStatusValid:$(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}}).then((e=>({response:e,subresponses:rt(e,s.length)})))}function ct(e,t){return e.filter((({statusCode:e})=>a.checkRetriable(e))).map((e=>t.find((({href:t})=>t===e.headers["content-id"])))).filter((e=>e))}function lt(e,r,s,o="id",n={},i,a=5){return q(this,void 0,void 0,(function*(){if(0===s.length||a<=0)return i;if(1===s.length){const[r]=s,o=yield N(e).invoke(r.method,r.href,r.headers,r.body,{isStatusValid:$(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}});return o.headers["content-id"]=r.href,i.map((e=>"content-id"in e.headers&&e.headers["content-id"]===o.headers["content-id"]?o:e))}const d=yield dt(e,r,s,o,n).then((t=>q(this,void 0,void 0,(function*(){const i=ct(t.subresponses,s);return i.length?yield lt(e,r,i,o,n,t.subresponses,a-1):t.subresponses}))));return i.map((e=>d.find((t=>t.headers["content-id"]===e.headers["content-id"]))||e))}))}const ht=n.newDebug("dcx:assets:asset"),ut=n.newDebug("dcx:assets:asset:leaf");class pt{constructor(e,t,r={}){this.type=X.Asset,this._data={},this._data=ce(e),this._svc=N(t),this._cache=L(t),this._links=a.merge({},e.links||{},e._links||{},r)}setLinks(e){this._links=e,this._updateCachedLinks()}get links(){return this._links}set links(e){this.setLinks(e)}setLink(e,t){this._links[e]=t,this._updateCachedLinks()}getLink(e){return this._links[e]}removeLink(e){delete this._links[e],this._updateCachedLinks()}_updateCachedLinks(){this._cache&&this._cache.setValueWithAsset(this.links,this.asset)}getLinkProperty(e,t,r="id"){return ht("getLinkProperty()"),a.getLinkProperty({_links:this._links},e,t,r)}getLinkHrefTemplated(e,t,r="id"){return ht("getLinkHrefTemplated()"),a.getLinkHrefTemplated({_links:this._links},e,t,r)}getLinkHref(e,t="id"){return ht("getLinkHref()"),a.getLinkHref({_links:this._links},e,t)}get asset(){return Object.assign(Object.assign({},this._data),this.links)}get serviceConfig(){return{service:this._svc,cache:this._cache}}get repositoryId(){return this._data.repositoryId}set repositoryId(e){this._data.repositoryId=e}get assetId(){return this._data.assetId}set assetId(e){this._data.assetId=e}get path(){return this._data.path}set path(e){this._data.path=e}get name(){return this._data.name}get etag(){return this._data.etag}set etag(e){this._data.etag=e}get version(){return this._data.version}set version(e){this._data.version=e}get format(){return this._data.format}set format(e){this._data.format=e}get assetClass(){return this._data.assetClass}get createDate(){return this._data.createDate}get modifyDate(){return this._data.modifyDate}get discardDate(){return this._data.discardDate}get createdBy(){return this._data.createdBy}get modifiedBy(){return this._data.modifiedBy}get discardedBy(){return this._data.discardedBy}get deviceCreateDate(){return this._data.deviceCreateDate}get deviceModifyDate(){return this._data.deviceModifyDate}get baseAssetId(){return this._data.baseAssetId}set baseAssetId(e){this._data.baseAssetId=e}get state(){return this._data.state}get size(){return this._data.size}set size(e){this._data.size=e}get md5(){return this._data.md5}set defaultScheduledDeletionDuration(e){this._data.defaultScheduledDeletionDuration=e}get defaultScheduledDeletionDuration(){return this._data.defaultScheduledDeletionDuration}set scheduledDeletionDate(e){this._data.scheduledDeletionDate=e}get scheduledDeletionDate(){return this._data.scheduledDeletionDate}get assetType(){return this._data.assetType}set assetType(e){this._data.assetType=e}get assetSubType(){return this._data.assetSubType}set assetSubType(e){this._data.assetSubType=e}get representations(){return this._data.representations}get contributors(){return this._data.contributors}get les(){return this._data.les}get region(){return this._data.region}set width(e){this._data.width=e}get width(){return this._data.width}set length(e){this._data.length=e}get length(){return this._data.length}get pinnedVersion(){return this._data.pinnedVersion}set pinnedVersion(e){this._data.pinnedVersion=e}get pinnedVersionModifyDate(){return this._data.pinnedVersionModifyDate}set pinnedVersionModifyDate(e){this._data.pinnedVersionModifyDate=e}fetchLinksIfMissing(e=[],t){return ht("fetchLinksIfMissing()"),xt(this.serviceConfig,this,e,void 0,t).then((({result:e,response:t})=>(this._updateDataWithResponse(t),this)))}useLinkOrResolveResource(e,t,r){return ht("useLinkOrResolveResource()"),Lt(this.serviceConfig,this,e,t,r).then((e=>(this._updateDataWithResponse(e.response),this.setLinks(a.merge(this.links,e.result.links)),e)))}headPrimaryResource(e){return ht("headPrimaryResource()"),this.fetchLinksIfMissing([u.PRIMARY],e).then((()=>ft(this.serviceConfig,this,e))).then((e=>(this._updateDataWithResponse(e),e)))}getRepresentation(e){return this._data.representations?this._data.representations[e]:void 0}getRepoMetadata(e){return ht("getRepoMetadata()"),this.useLinkOrResolveResource(u.REPO_METADATA,"json").then((e=>{this._data=a.merge(this._data,e.result,ce(e.response.response));const t=e.response.response;return t&&t._links&&this.setLinks(a.merge(this.links,t._links)),{result:this._data,response:e.response}}))}updateRepoMetadata(e){return ht("updateRepoMetadata()"),this.fetchLinksIfMissing([u.REPO_METADATA],e).then((()=>Ct(this._svc,this,e)))}headAppMetadata(e){return ht("headAppMetadata()"),this.fetchLinksIfMissing([u.APP_METADATA],e).then((()=>Tt(this.serviceConfig,this,e)))}getAppMetadata(e,t){return ht("getAppMetadata()"),a.validateParams(["etag",e,"string",!0]),this.fetchLinksIfMissing([u.APP_METADATA],t).then((()=>bt(this._svc,this,e,t)))}putAppMetadata(e,t,r){return ht("putAppMetadata()"),a.validateParams(["etag",t,"string",!0],["metadata",e,["object","string"]]),this.fetchLinksIfMissing([u.APP_METADATA],r).then((()=>Pt(this._svc,this,e,t,r)))}patchAppMetadata(e,t,r){return ht("patchAppMetadata()"),a.validateParams(["patchDoc",e,["string","object[]"]],["etag",t,"string"]),this.fetchLinksIfMissing([u.APP_METADATA],r).then((()=>Rt(this._svc,this,e,t,r)))}getBaseDirectoryMetadata(){return ht("getBaseDirectoryMetadata()"),It(this._svc)}getLinks(e){return ht("getLinks()"),a.isObject(this.links)&&Object.keys(this.links).length>0?h.default.resolve(this.links):yt(this._svc,this,e).then((e=>(this.setLinks(e),e)))}getRepositoryResource(e){return ht("getRepositoryResource()"),this.fetchLinksIfMissing([u.REPOSITORY],e).then((()=>vt(this._svc,this,e))).then((e=>(this.repositoryId=e.result["repo:repositoryId"],e)))}getEffectivePrivileges(e){return ht("getEffectivePrivileges()"),this.fetchLinksIfMissing([u.EFFECTIVE_PRIVILAGES],e).then((()=>wt(this._svc,this)))}performBulkRequest(e,t,r){return ht("performBulkRequest()"),a.validateParams(["requests",e,"array"],["linkMode",t,"string",!0,["id","path"]]),this.fetchLinksIfMissing([u.BULK_REQUEST],r).then((()=>at(this._svc,this,e,t,r)))}getACLPolicy(e){return ht("getACLPolicy()"),this.fetchLinksIfMissing([u.ACL_POLICY],e).then((()=>Ot(this._svc,this)))}checkACLPrivilege(e,t,r){return ht("checkACLPrivilege()"),a.validateParams(["privilege",e,"string"],["relation",t,"string"]),this.fetchLinksIfMissing([u.ACCESS_CHECK],r).then((()=>St(this._svc,this,e,t)))}patchACLPolicy(e,t,r){return ht("patchACLPolicy()"),a.validateParams(["policy",e,["string","object"]]),this.fetchLinksIfMissing([u.ACL_POLICY],r).then((()=>kt(this._svc,this,e,t)))}deleteACLPolicy(e){return ht("deleteACLPolicy()"),this.fetchLinksIfMissing([u.ACL_POLICY],e).then((()=>Nt(this._svc,this)))}getPrimaryResource(e,t){ht("getPrimaryResource()"),a.validateParams(["responseType",e,"string"]);const r={};return this._withSourcePromise(r).then((()=>this.fetchLinksIfMissing([u.PRIMARY],t))).then((()=>_t.call(r,this._svc,this,e,t)))}copy(e,t,r,s,o,n){return ht("copy()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"],["manifestPatch",o,["object","string"],!0]),ye(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s,o,n).then((({response:e,result:t})=>({response:e,result:new pt(t,this.serviceConfig)})))}copyResources(e,t,r,s,o){return ht("copyResources()"),a.validateParams(["targetAsset",e,"object"],["resources",t,"array"],["manifestPatch",s,["object","string"],!0],["intermediates",r,"boolean",!0]),je(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path,version:this.version},e,t,r,s,o)}move(e,t,r,s,o){return ht("move()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),Ce(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s,o).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{response:e,result:this})))}delete(e,t=!1,r){return ht("delete()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),ve(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r).then((e=>(this._data.state="DELETED",e)))}discard(e,t=!1,r){return ht("discard()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),Ie(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r).then((e=>(this._data.state="DISCARDED",e)))}package(e,t,r,s){return ht("package()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),be(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s)}restore(e,t){return ht("restore()"),Te(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId},e,t).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{state:"ACTIVE"}),{response:e,result:this})))}_updateDataWithResponse(e){return e?(this._data.etag=e.headers.etag||this._data.etag,this._data.version=e.headers.version||this._data.version,this._data.assetId=e.headers["asset-id"]||this._data.assetId,this._data.md5=e.headers["content-md5"]||this._data.md5,this._data.repositoryId=e.headers["repository-id"]||this._data.repositoryId,e):e}_withSourcePromise(e){return h.default.resolve(void 0,e)}}function _t(e,r,s,o){ht("getPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["responseType",s,"enum",!0,z]),J(r.links,[u.PRIMARY]);const n=a.getLinkHrefTemplated(r.links,u.PRIMARY,{version:r.version||t.VersionProperties.PINNED_VERSION});return Je.call({},e,r,n,u.PRIMARY,s,void 0,void 0,o)}function ft(e,r,s){ht("headPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.PRIMARY]);const o=a.getLinkHrefTemplated(r.links,u.PRIMARY,{version:r.version||void 0});return N(e).invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:$()}).then((t=>{const s=fe(t);r.links=a.merge(s,r.links||{});const o=L(e);return o&&o.setValueWithAsset(r.links||{},r),t}))}function mt(e,t,r="id",s,o){ut("getResolveLinkForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!1,["id","path"]],["resource",s,["string","object"],!0]),re(t);const n={repositoryId:t.repositoryId,id:t.assetId,path:t.path,mode:r,resource:a.isObject(s)?JSON.stringify(s):s},i=N(e),d=M(t.assetId?"/content/directory/resolve{?repositoryId,id,resource,mode}":"/content/directory/resolve{?repositoryId,path,resource,mode}",i);return h.default.resolve(a.expandURITemplate(d,a.pruneUndefined(n)))}function gt(e,t,r="id",s,o,n){ut("resolveAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!0,["id","path"]],["resource",s,["string","object"],!0]),re(t);const i=N(e),d=L(e),c=d&&t.assetId&&t.repositoryId&&"id"===r;return c&&(ut("rA() set pending"),d.setPending(t.assetId,t.repositoryId)),mt(e,t,r,s).then((e=>null==s?ie(i,e,n):ae(i,e,n,o))).then((e=>({response:e,result:jt(t,e,"id"===r,d)}))).catch((e=>{throw c&&d.deleteWithAsset(t),e}))}function Et(e,t,r){return ut("fetchLinksForAsset()"),At(e,t,r).then((e=>e.result.links))}function At(e,r,s){if(ut("fetchAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),P(r))return gt(e,r,"id",void 0,void 0,s).then((e=>e));let n;try{n=Z(r.links,[u.ID,u.REPO_METADATA,u.PRIMARY,u.PATH])}catch(e){throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repositoryId & path, assetId, or links.",e)}const i=a.getLinkHrefTemplated(r.links,n,{}),d=N(e),c=L(e);return d.invoke(t.HTTPMethods.HEAD,i,s,void 0,{isStatusValid:$()}).then((e=>({result:jt(r,e,n===u.ID,c),response:e})))}function yt(e,r,s){ut("getLinksForAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]);const o=r.links||r[t.Properties.LINKS];if(a.isObject(o)&&0!==Object.keys(o).length)return h.default.resolve(o);const n=L(e);if(n){const e=n.getValueWithAsset(r);if(e)return h.default.resolve(e)}return Et(e,r,s)}function Dt(e,r,s){ut("getRepoMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.REPO_METADATA]);const o=a.getLinkHrefTemplated(r.links,u.REPO_METADATA,{version:r.version||t.VersionProperties.PINNED_VERSION});return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:$()}).then((e=>{const r=fe(e),s=e.response;return s[t.Properties.LINKS]=a.merge({},s[t.Properties.LINKS],r),{result:s,response:e}}))}function Ct(e,r,s){ut("updateRepoMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.REPO_METADATA]);const o=a.getLinkHrefTemplated(r.links,u.REPO_METADATA,{}),n=Object.assign({[t.HeaderKeys.CONTENT_TYPE]:F},s),i=he(r);return e.invoke(t.HTTPMethods.PATCH,o,n,JSON.stringify(i),{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function It(e,t){throw ut("getBaseDirectoryMetadata()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}function vt(e,r,s){ut("getRepositoryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.REPOSITORY]);const o=a.getLinkHrefTemplated(r.links,u.REPOSITORY,{});return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function Tt(e,r,s){ht("headAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.APP_METADATA]);const o=a.getLinkHrefTemplated(r.links,u.APP_METADATA,{version:r.version||void 0});return N(e).invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:$()}).then((t=>{const s=fe(t);r.links=a.merge(s,r.links||{});const o=L(e);return o&&o.setValueWithAsset(r.links,r),t}))}function bt(e,r,s,o={}){ut("getAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0]);const n=a.getLinkHrefTemplated(r.links,u.APP_METADATA,{version:r.version||t.VersionProperties.PINNED_VERSION}),i=Object.assign({},o);return s&&(i[t.HeaderKeys.IF_NONE_MATCH]=s),e.invoke(t.HTTPMethods.GET,n,i,void 0,{responseType:"json",isStatusValid:$([304])}).then((e=>{let t=e.response,r=e.headers.etag;return 304===e.statusCode&&(t=null,r=s),{result:t,response:e,etag:r}}))}function Pt(e,r,s,o,n={}){ut("putAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object","string"]],["etag",o,"string",!0]),J(r.links,[u.APP_METADATA]);const i=a.getLinkHrefTemplated(r.links,u.APP_METADATA,{});return e.invoke(t.HTTPMethods.PUT,i,a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:V})),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:$()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function Rt(e,r,s,o,n={}){ut("patchAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object[]","string"]],["etag",o,"string"]),J(r.links,[u.APP_METADATA]);const i=a.getLinkHrefTemplated(r.links,u.APP_METADATA,{});return e.invoke(t.HTTPMethods.PATCH,i,a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:F})),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:$()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function wt(e,r,s){ut("getEffectivePrivileges()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.EFFECTIVE_PRIVILAGES]);const o=a.getLinkHrefTemplated(r.links,u.EFFECTIVE_PRIVILAGES,{});return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function Ot(e,r,s){ut("getACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.ACL_POLICY]);const o=a.getLinkHrefTemplated(r.links,u.ACL_POLICY,{});return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function St(e,r,s,o,n={}){ut("checkACLPrivilege()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["privilege",s,"string",!1,["ack","read","write","delete"]]),J(r.links,[u.ACCESS_CHECK]);const i=a.getLinkHrefTemplated(r.links,u.ACCESS_CHECK,{privilege:s.toString(),relation:o});return e.invoke(t.HTTPMethods.GET,i,Object.assign({directive:"acl-check-no-body"},n),void 0,{responseType:"json",isStatusValid:$([403])}).then((e=>({result:403!==e.statusCode,response:e})))}function kt(e,r,s,o,n={}){ut("patchACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["policy",s,["string","object"]],["etag",o,"string",!0]),J(r.links,[u.ACL_POLICY]);const i=a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.CONTENT_TYPE]:F,[t.HeaderKeys.IF_MATCH]:o})),d=a.getLinkHrefTemplated(r.links,u.ACL_POLICY,{});return N(e).invoke(t.HTTPMethods.PATCH,d,i,"string"==typeof s?s:JSON.stringify(s),{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function Nt(e,r,s={}){ut("deleteACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.ACL_POLICY]);const o=a.getLinkHrefTemplated(r.links,u.ACL_POLICY,{});return N(e).invoke(t.HTTPMethods.DELETE,o,s,void 0,{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function Lt(e,r,s,n,i){ut("useLinkOrResolveResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["resource",s,"string"]);const d=N(e);let c;try{c=a.getLinkHrefTemplated(r.links,s,{version:r.version||t.VersionProperties.PINNED_VERSION})}catch(e){}return h.default.resolve(c).then((t=>{if("string"==typeof t)return ut("uLORR() asset has link"),t;const o=L(e);return Bt(r,o,[s])})).then((e=>{if("string"==typeof e)return e;try{return a.getLinkHrefTemplated(e,s,{version:r.version||t.VersionProperties.PINNED_VERSION})}catch(e){return}})).then((a=>{if("string"==typeof a)return ut("uLORR() cache or asset had link"),d.invoke(t.HTTPMethods.GET,a,i,void 0,{isStatusValid:$(),responseType:n});if(!P(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repository ID + path/id or links.");return gt(e,r,"id",s,n,i)})).then((e=>C(e)?e:{result:r,response:e}))}function Mt(e,t,r=[],s=!1,o){return xt(e,t,r,s,o).then((({result:e})=>e))}const Xt=new Set([u.BASE_DIRECTORY,u.RESOLVE_BY_ID,u.RESOLVE_BY_PATH,u.REPO_OPS,u.REPOSITORY,u.DIRECTORY,u.DISCARD,u.RESTORE,u.PATH,u.ANNOTATIONS]);function xt(e,r,s=[],n=!1,i){if(ut("fetchLinksIfMissing()",s),a.validateParams(["svc",e,"object"],["asset",r,"object"],["linksToPopulate",s,"string[]"],["suppressMissingErrors",n,"boolean",!0]),ee(r.links,s))return ut("fLIM() links exist"),h.default.resolve({result:r.links});const d=L(e);return Bt(r,d,s,!0).then((o=>o||(function(e,t){return"string"==typeof e.assetId&&e.assetId.length>0&&t.every((e=>!Xt.has(e)))}(r,s)?function(e,r,s){const o=function(e,t){ut("getLinksAPIUrlForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const r=M("/links{?assetId,repositoryId,clientRegion}",N(e)),{assetId:s,repositoryId:o,contentRegion:n}=t,i=a.pruneUndefined({assetId:s,repositoryId:o,contentRegion:n});return a.expandURITemplate(r,i)}(e,r);return N(e).invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json"}).then((t=>{const s=L(e);return r.links=Object.assign({},r.links,t.response._links),null==s||s.setValueWithAsset(r.links,r),{response:t,result:r}}))}(e,r,i):(ut("fLIM() fetching links"),At(e,r,i))))).then((t=>{let i,d,c=t;if(C(t)&&(i=t.response,c=t.result.links,d=t.result),r.links!==c){r.links=a.merge(r.links||{},c);const t=L(e);t&&t.setValueWithAsset(r.links,r)}if(!n&&!ee(c,s))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Required links could not be fetched for asset.",void 0,i,a.pruneUndefined({required:s,asset:d}));return ut("fLIM() fetchedOCached exists"),{result:c||r.links,response:i}}))}function Bt(e,t,r,s){if(ut("getLinksFromCache()"),!t)return h.default.resolve(void 0);const o=t.getValueWithAsset(e);return null==o?(s&&t.setPending(e.assetId,e.repositoryId),h.default.resolve(void 0)):h.default.resolve(o).then((o=>r?ee(o,r)?o:void(s&&t.setPending(e.assetId,e.repositoryId)):o))}function jt(e,r,s,o){const n=fe(r),i=Object.assign(Object.assign(Object.assign({},function(e){return a.isObject(e.asset)?e.asset:e}(e)),a.pruneUndefined({assetId:r.headers["asset-id"]||r.headers["x-resource-id"],format:r.headers[t.HeaderKeys.CONTENT_TYPE],md5:r.headers["content-md5"],etag:r.headers.etag,version:r.headers.version,repositoryId:r.headers["repository-id"]})),{links:n});return s&&n&&Object.keys(n).length>0&&o&&o.setValueWithAsset(n,i),i}const Ut="use-block-store",Vt=n.newDebug("dcx:assets:block_transfer"),Ht=10485760,Ft=52428800,Yt=Ht/4;let Wt=Ft;function zt(e,r){const s=function(e){return Gt(e,t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE)}(e);if(s&&r<s)return!1;const o=qt(e);return!!(o&&r>o)||r>Ht}function Gt(e,t){if(!ee(e.links,[u.BLOCK_UPLOAD_INIT]))return;const r=a.getLinkProperty(e.links,u.BLOCK_UPLOAD_INIT,t);return r?parseInt(r):void 0}function qt(e){return Gt(e,t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE)}const Kt=e=>"string"==typeof e?e.length>=Yt?a.stringToBuffer(e).byteLength:e.length:"size"in e?e.size:e.byteLength,$t=(e,t)=>{if(!a.isAnyFunction(e))return e;if(e.length<2)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"GetSliceCallback is expected to accept 2 parameters");if(void 0===t||isNaN(t)||t<0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Size parameter should indicate total number of bytes to be read from GetSliceCallback");return{getSlice:e,size:t}},Jt=()=>Wt;function Zt(e,t,r,s){const o=a.parseHeaders(s);return{id:t,length:r,type:e,links:me(o.link||o["api-link"]),etag:o.etag,location:o.location,version:o.version,revision:o.revision,md5:o["content-md5"]}}function Qt(e){return new Promise((t=>{let r;e.finally((()=>{clearTimeout(r),t(void 0)})),function s(){["blockUpload","blockDownload"].forEach((o=>{if(a.isObject(e[o]))return clearTimeout(r),t(e[o]);clearTimeout(r),r=setTimeout(s,1)}))}()}))}const er=n.newDebug("dcx:assets:blockupload"),tr=n.newDebug("dcx:assets:blockupload:leaf");class rr extends a.EventEmitter{constructor(e,r,s,n,i,d,c,l,p,_,f,m,g,E,A,y){let D;super(["stateChanged"]),this._internalBlockUploadId=a.generateUuid(),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._currentBlockIndex=0,this._pendingBlockRequests=new Map,this._bytesUploaded=0,this._indeterminateTransfer=!1,this._maxConcurrentRequests=4,this._retryQueue=new Set,this._activeBlockIndex=0,this._lastExtendTime=0,this._uploadedBlocksURLs=[],this._useBlockStoreDirective=!1,this._service=e,this._getSliceCallback=r;let C=y;"string"==typeof n?D=n:"object"==typeof n&&(C=n),O(s)?(a.validateParams([t.BlockTransferProperties.REPO_SIZE,s[t.BlockTransferProperties.REPO_SIZE],"number"]),this._blockTransferDocument=s,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][u.BLOCK_TRANSFER],this._dataSize=this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],this._relationType=this._blockTransferDocument[t.BlockTransferProperties.REPO_REL_TYPE],this._shiftState(t.BlockTransferStates.INITIALIZED),er(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`)):(a.validateParams(["relationType",D,"string"],["dataSize",i,"number"],["contentType",d,"string"],["componentId",c,"string",!0],["etag",p,"string",!0]),this._asset=s,J(this._asset.links,[u.BLOCK_UPLOAD_INIT],o.DCXError.UNEXPECTED,"/rel/block/init missing from BlockTransferDocument."),this._relationType=D,this._dataSize=i,this._contentType=d,this._componentId=c,this._md5=l,this._ifMatch=p),this._relPath=_,this._createIntermediates=f,this._respondWith=m,this._repoMetaPatch=g,this._maxConcurrentRequests=E||4,this._nameConflictPolicy=A,(null==C?void 0:C.useBlockStoreDirective)&&(er("USE_BLOCK_STORE_DIRECTIVE enabled via constructor options."),this._useBlockStoreDirective=!0),this._promise=new h.default(((e,t)=>{this._reject=t,this._resolve=e})),Ve.uploads.push(this)}init(e){if(this._assertStateIsValid("init"),!this._blockTransferDocument||!this._blockTransferDocument[t.Properties.LINKS]){this._shiftState(t.BlockTransferStates.INITIALIZING);const r=a.pruneUndefined(Object.assign({[t.BlockTransferProperties.REPO_REL_TYPE]:this._relationType,[t.BlockTransferProperties.REPO_IF_MATCH]:this._ifMatch,[t.BlockTransferProperties.REPO_SIZE]:this._dataSize,[t.BlockTransferProperties.DC_FORMAT]:this._contentType,[t.BlockTransferProperties.COMPONENT_ID]:this._componentId,[t.BlockTransferProperties.REPO_MD5]:this._md5},this._blockTransferDocument)),s=Object.assign({},e||{});return this._useBlockStoreDirective&&!(t.HeaderKeys.DIRECTIVE in s)&&(s[t.HeaderKeys.DIRECTIVE]=Ut,er("BlockUpload.init(): Injected USE_BLOCK_STORE_DIRECTIVE into headers")),sr(this._service,this._asset,r,s).then((e=>(this._blockTransferDocument=e.result,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][u.BLOCK_TRANSFER],this._shiftState(t.BlockTransferStates.INITIALIZED),er(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`),this)))}return h.default.resolve(this)}get state(){return this._state}get promise(){return this._promise}start(){return this._assertStateIsValid("start"),Ve.uploads[0]!==this||this._state!==t.BlockTransferStates.INITIALIZED&&this._state!==t.BlockTransferStates.PAUSED||(er(`Starting the transfer of BlockUpload: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.STARTED),this._uploadLoop()),this._promise}pause(){return this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),h.default.allSettled([...this._pendingBlockRequests.values()]).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),er(`BlockUploading has been paused.  BlockUploadId: ${this._internalBlockUploadId}`),this)))}resume(){return this._assertStateIsValid("resume"),er(`BlockUploading has been resumed.  BlockUploadId: ${this._internalBlockUploadId}`),this.start(),this}cancel(){this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),er(`A BlockUpload has been canceled... BlockUploadId: ${this._internalBlockUploadId}`),this._promise.cancel(),this._cancel()}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}uploadNextBlock(e){if(this._assertStateIsValid("uploadNextBlock"),this._isEmptyBlock(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Trying to upload empty data block.");const r=this._activeBlockIndex,s=Date.now(),n=this._blockTransferDocument[t.Properties.LINKS][u.BLOCK_TRANSFER][r].href;let i;er(`Uploading a block... BlockUploadId: ${this._internalBlockUploadId}`);const a=Kt(e),d=this._uploadBlock(e,n).then((e=>(this._uploadedBlocksURLs[r]={href:n},this._updateProgress(a),i(),er(`A block has completed... ${this._pendingBlocksCount} requests still active. BlockUploadId: ${this._internalBlockUploadId}`),e))).catch((e=>{var d;return i(),this._useBlockStoreDirective&&412===(null===(d=null==e?void 0:e.response)||void 0===d?void 0:d.statusCode)?(er(`Received 412 for block ${r}. Treating as success. BlockUploadId: ${this._internalBlockUploadId}`),this._uploadedBlocksURLs[r]={href:n},this._updateProgress(a),h.default.resolve(e.response)):this._isTransferUrlExpiredError(e)?(er(`A block with index as ${r} has FAILED due to Transfer Expiry!! ${this._pendingBlocksCount} requests still active. BlockUploadId: ${this._internalBlockUploadId}`),this._retryQueue.add(r),s<=this._lastExtendTime?(er(`Skipping extend for block ${r} \u2014 request started after last extend.`),this._maybePauseForRetry().then((()=>h.default.reject(t.BlockTransferStates.PAUSED)))):this._maybeExtendWithPauseResume().catch((e=>(er(`Extend flow failed for block ${r}`,e),h.default.reject(e))))):(er(`A block upload has failed. BlockUploadId: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.ERROR),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"A block has failed during upload",e,e.response)),this.cancel(),h.default.reject(e))}));return i=this._pushPendingBlockRequest(r,d),d}get _pendingBlocksCount(){return Ve.pendingUploadRequests.filter((e=>!!e)).length}_nextBlockLock(){return this._pendingBlocksCount<this._maxConcurrentRequests?Promise.resolve():Promise.race(Ve.pendingUploadRequests.filter((e=>!!e)))}_handleAssetMoved(e){throw er("_handleAssetMoved"),this._pendingBlockRequests.forEach((e=>{e.abort()})),this._pendingBlockRequests.clear(),this._uploadedBlocksURLs.length=0,this._transferBlockLinks.length=0,this._asset.links=Object.assign(Object.assign({},this._asset.links),fe(e.response)),this._retryQueue.clear(),this._activeBlockIndex=0,this._lastExtendTime=0,this._currentBlockIndex=0,this._bytesUploaded=0,this._state=t.BlockTransferStates.NOT_INITIALIZED,this._blockTransferDocument[t.Properties.LINKS]=void 0,this.init().then((()=>this.start())),t.BlockTransferStates.INITIALIZING}_getNextUploadBlockData(){if(this._retryQueue.size>0){const[e]=this._retryQueue;this._retryQueue.delete(e),this._activeBlockIndex=e}else this._activeBlockIndex=this._currentBlockIndex;return this._getBlockAtIndex(this._activeBlockIndex)}_uploadLoop(){this._nextBlockLock().then((()=>{if(this._state===t.BlockTransferStates.FINALIZING||this._state===t.BlockTransferStates.COMPLETE)throw t.BlockTransferStates.COMPLETE;if(this._state===t.BlockTransferStates.PAUSING||this._state===t.BlockTransferStates.PAUSED)throw t.BlockTransferStates.PAUSED;if(this._state===t.BlockTransferStates.CANCELED)throw t.BlockTransferStates.CANCELED;if(this._state===t.BlockTransferStates.ERROR)throw t.BlockTransferStates.ERROR})).then((()=>this._getNextUploadBlockData())).then((e=>this._isEmptyBlock(e)?(er(`No more blocks.  BlockUploadId: ${this._internalBlockUploadId}`),Promise.all([...this._pendingBlockRequests.values()]).then(this._finalize.bind(this))):e&&Kt(e)>0&&this._activeBlockIndex>=this._transferBlockLinks.length?this._extend().then((()=>e)):e)).then((e=>{if(!e)throw t.BlockTransferStates.COMPLETE;this.uploadNextBlock(e),this._activeBlockIndex===this._currentBlockIndex&&this._currentBlockIndex++})).then((()=>{this._uploadLoop()})).catch((e=>{if("string"!=typeof e&&(this._continueBlockUploads(),this._reject(e)),e!==t.BlockTransferStates.INITIALIZING)if(e!==t.BlockTransferStates.COMPLETE){if(e!==t.BlockTransferStates.PAUSED)return e===t.BlockTransferStates.CANCELED?(er(`BlockUpload loop is terminated due to the upload being canceled. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):e===t.BlockTransferStates.ERROR?(er(`BlockUpload loop is terminated due to error state. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):void 0;er(`BlockUpload loop is terminated due to paused state. BlockUploadId: ${this._internalBlockUploadId}`)}else er(`BlockUpload loop is complete. BlockUploadId: ${this._internalBlockUploadId}`);else er(`BlockUpload loop must be re-started due to assetmoved BlockUploadId: ${this._internalBlockUploadId}`)}))}_getBlockAtIndex(e){er(`_getBlockAtIndex(${e})`);const r=Math.min(this._dataSize,this._blockTransferDocument[t.BlockTransferProperties.REPO_BLOCK_SIZE]);if(this._state===t.BlockTransferStates.STARTED){const t=e*r;return er("calling _getSliceCallback",t,t+r),this._getSliceCallback(t,t+r).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"The getSliceCallback threw an unexpected error.",e)}))}}_uploadBlock(e,r){return this._service.invoke(t.HTTPMethods.PUT,r,void 0,e,{isStatusValid:$(),isExternalRequest:!0})}_isEmptyBlock(e){return"string"==typeof e?0===e.length:b(e)?0===e.size:!e||0===e.byteLength}_extend(e=!0){J(this._blockTransferDocument[t.Properties.LINKS],[u.BLOCK_EXTEND],o.DCXError.UNEXPECTED,"The transfer document does not contain an extend href");const r=this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],s=e?Math.ceil(1.5*r):r,n=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],u.BLOCK_EXTEND,{size:s}),i={};return this._useBlockStoreDirective&&(i[t.HeaderKeys.DIRECTIVE]=Ut),this._service.invoke(t.HTTPMethods.POST,n,i,void 0,{isStatusValid:$(),responseType:"json"}).then((r=>(this._indeterminateTransfer=!0,this._blockTransferDocument=r.response,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][u.BLOCK_TRANSFER],er(`Transfer document extended (${e?"size increased":"URL refresh only"}): ${this._transferBlockLinks.length} transfer links. BlockUploadId: ${this._internalBlockUploadId}`),r))).catch((e=>{throw o.isAdobeDCXError(e)&&e.problemType===o.ProblemTypes.ASSET_MOVED&&this._handleAssetMoved(e),new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An unexpected error occurred while extending the block transfer document.",e,e.response)}))}_maybeExtendWithPauseResume(){if(this._extendPromise)return er("Reusing in-progress extend (with pause/resume)"),h.default.reject(t.BlockTransferStates.PAUSED);er("[_maybeExtendWithPauseResume] Setting state to PAUSED and triggering extend"),this._shiftState(t.BlockTransferStates.PAUSED);const e=h.default.resolve().then((()=>(er("[_maybeExtendWithPauseResume] Pause done, calling _extend()"),this._extend(!1)))).then((e=>(this._lastExtendTime=Date.now(),er("[_maybeExtendWithPauseResume] Extend done, calling resume()"),h.default.resolve(this.resume()).then((()=>(er("[_maybeExtendWithPauseResume] Resume done"),e))))));return this._extendPromise=e.finally((()=>{this._extendPromise=void 0})),h.default.reject(t.BlockTransferStates.PAUSED)}_maybePauseForRetry(){return this._state===t.BlockTransferStates.PAUSED||this._state===t.BlockTransferStates.PAUSING?(er("[_maybePauseForRetry] Already in PAUSED or PAUSING state \u2014 skipping."),h.default.resolve()):(er("[_maybePauseForRetry] Shifting to PAUSED state to trigger retry mechanism."),this._shiftState(t.BlockTransferStates.PAUSED),er("[_maybePauseForRetry] Calling resume() to restart upload loop for retries."),this.resume(),h.default.resolve())}_isTransferUrlExpiredError(e){var t,r;const s=null===(t=null==e?void 0:e.response)||void 0===t?void 0:t.statusCode,o=null==e?void 0:e.code,n=(null===(r=null==e?void 0:e.response)||void 0===r?void 0:r.response)||"";return er(`[TransferExpiryCheck] StatusCode: ${s}`),er(`[TransferExpiryCheck] Code: ${o}`),er(`[TransferExpiryCheck] RawResponse: ${n}`),!(403!==s&&"FORBIDDEN"!==o||"string"!=typeof n||!n.toLowerCase().includes("request has expired"))}_pushPendingBlockRequest(e,t){this._pendingBlockRequests.set(e,t);const r=Ve.pendingUploadRequests.push(t);return()=>{this._pendingBlockRequests.delete(e),delete Ve.pendingUploadRequests[r-1]}}_updateProgress(e){if(er("_updateProgress()",e),"number"==typeof e&&(this._bytesUploaded+=e),this.onProgress&&a.isAnyFunction(this.onProgress))try{this.onProgress(this._bytesUploaded,Math.max(this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],this._bytesUploaded),this._indeterminateTransfer)}catch(e){console.error("Error in onProgress callback",e)}}_cancel(){this._pendingBlockRequests.forEach((e=>{null==e||e.cancel()})),this._state!==t.BlockTransferStates.ERROR&&this._resolve(this)}_assertStateIsValid(e,r){const s=r||this._state;switch(e){case"init":if(s!==t.BlockTransferStates.NOT_INITIALIZED&&s!==t.BlockTransferStates.INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"BlockUpload has already been initialized");break;case"start":if(s===t.BlockTransferStates.NOT_INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Please call init before starting the block upload");break;case"uploadNextBlock":if(s===t.BlockTransferStates.PAUSED||s===t.BlockTransferStates.CANCELED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Cannot add block when Paused or Cancelled");break;case"getBlockAtIndex":if(s!==t.BlockTransferStates.STARTED)throw new o.DCXError(o.DCXError.INVALID_STATE,`Cannot fetch block while in the ${s} state`);break;case"cancel":if(s!==t.BlockTransferStates.STARTED&&s!==t.BlockTransferStates.FINALIZING&&s!==t.BlockTransferStates.PAUSING&&s!==t.BlockTransferStates.PAUSED&&s!==t.BlockTransferStates.ERROR)throw new o.DCXError(o.DCXError.INVALID_STATE,`Trying to cancel while in an invalid state ${s}`)}}_continueBlockUploads(){if(er("continueBlockUploads()"),Ve.uploads[0]===this)if(Ve.uploads.shift(),Ve.uploads.length>0){const e=Ve.uploads[0];er("Another block upload found in the queue, starting..."),e.start()}else 0===this._pendingBlocksCount&&(er("There are no more pending block transfers.. Clean up blockUploadManager.."),Ve.resetUploads())}_finalize(){er(`Finalizing block transfer.  BlockUploadId: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.FINALIZING);const e=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],u.BLOCK_FINALIZE,a.pruneUndefined({path:this._relPath,intermediates:this._createIntermediates,respondWith:a.isObject(this._respondWith)?JSON.stringify(this._respondWith):this._respondWith,repoMetaPatch:this._repoMetaPatch,nameConflictPolicy:this._nameConflictPolicy}));this._blockTransferDocument[t.Properties.LINKS][u.BLOCK_TRANSFER]=this._uploadedBlocksURLs;const r={[t.HeaderKeys.CONTENT_TYPE]:Y};return this._useBlockStoreDirective&&(r[t.HeaderKeys.DIRECTIVE]=Ut),this._service.invoke(t.HTTPMethods.POST,e,r,JSON.stringify(a.pruneUndefined(this._blockTransferDocument)),{isStatusValid:$(),retryOptions:{pollHeader:"location",pollCodes:[202],timeoutAfter:12e4},responseType:"arraybuffer"}).then((e=>{if(200===e.statusCode||201===e.statusCode){er(`Finalize complete.  BlockUploadId: ${this._internalBlockUploadId}`);const r=nt(new Uint8Array(e.response));if(this._relationType===u.PRIMARY){this.finalizeResponse=r;const t=r.headers.link||r.headers["api-link"];if(this.createdAsset=a.pruneUndefined({assetId:r.headers["asset-id"],repositoryId:r.headers["repository-id"],links:me(t),etag:r.headers.etag,md5:r.headers["content-md5"]}),r.response&&this._respondWith)try{const e=JSON.parse(a.arrayBufferToString(r.response));r.response=e,this.createdAsset=a.mergeDeep(this.createdAsset,ce(e))}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected error parsing respondWith parameter",e)}}else{this.finalizeResponse=e;try{this.uploadRecord=Zt(this._blockTransferDocument[t.BlockTransferProperties.DC_FORMAT],this._blockTransferDocument[t.BlockTransferProperties.COMPONENT_ID],this._bytesUploaded,a.arrayBufferToString(e.response))}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"An error occurred while deserializing upload component record.",e,r)}}this._shiftState(t.BlockTransferStates.COMPLETE),this._updateProgress(!0),this._resolve(this)}this._continueBlockUploads()})).catch((e=>{if(o.isAdobeDCXError(e))switch(e.problemType){case o.ProblemTypes.ASSET_MOVED:return void this._handleAssetMoved(e);case o.ProblemTypes.ASSET_NAME_CONFLICT:return er("Error occurred finalizing the block transfer due to asset name conflict.. Rejecting with ALREADY_EXISTS"),this._reject(new o.DCXError(o.DCXError.ALREADY_EXISTS,"Asset name conflict occurred during block transfer finalization.",e,e.response)),void this._continueBlockUploads();case o.ProblemTypes.INVALID_BLOCK_SIZE:er("Finalize failed: invalidBlockSize. Block size not align with the expectation from Service.");break;case o.ProblemTypes.MISSING_UPLOADED_LINKS:er("Finalize failed: missingUploadedLinks. Finalize request does not contain all the links for which data was uploaded.");break;case o.ProblemTypes.INVALID_TRANSFER_LINKS:er("Finalize failed: invalidTransferLinks. Transfer URLs not present with Service/S3")}er("Error occurred finalizing the block transfer.. Rejecting"),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An error occurred while finalizing the block transfer.",e,e.response)),this._continueBlockUploads()}))}_shiftState(e){return er(`_shiftState(): ${e}`),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state])),this}}function sr(e,r,s,n={}){if(a.validateParams(["svc",e,"object"],["assetOrLink",r,["object","string"]],["transferDocument",s,"object"],["additionalHeaders",n,"object",!0]),T(r)&&J(r.links,[u.BLOCK_UPLOAD_INIT]),(null==n?void 0:n.directive)===Ut&&(delete s["repo:blocksize"],er('Removed "repo:blocksize" from init payload due to "use-block-store" directive')),s["repo:resource"]){if(!s["repo:resource"].reltype)throw new o.DCXError(o.DCXError.INVALID_DATA,"reltype param is required in the Resource Designator");s[t.BlockTransferProperties.REPO_REL_TYPE]=s["repo:resource"].reltype,s["repo:resource"].component_id&&(s[t.BlockTransferProperties.COMPONENT_ID]=s["repo:resource"].component_id),s["repo:resource"].etag&&(s[t.BlockTransferProperties.REPO_IF_MATCH]=s["repo:resource"].etag),delete s["repo:resource"]}if(s[t.BlockTransferProperties.REPO_REL_TYPE]===u.COMPONENT&&!s[t.BlockTransferProperties.COMPONENT_ID])throw new o.DCXError(o.DCXError.INVALID_DATA,"Component Id required to block upload to a component");const i=T(r)?a.getLinkHrefTemplated(r.links,u.BLOCK_UPLOAD_INIT,{}):r;n[t.HeaderKeys.CONTENT_TYPE]=Y;const d=a.normalizeHeaders(n);return d.priority=d.priority||"u=1",e.invoke(t.HTTPMethods.POST,i,d,JSON.stringify(s),{responseType:"json",isStatusValid:$()}).then((e=>({response:e,result:e.response})))}function or({additionalHeaders:e,asset:t,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,maybeIsNew:i,md5:d,progressCb:c,relation:l,size:u,svc:p,blockSize:_,maxConcurrentRequests:f}){tr("_upload()"),a.validateParams(["svc",p,"object"],["asset",t,"object"],["size",u,"number",!0],["md5",d,"string",!0],["etag",n,"string",!0]);const m=$t(o,u),g=Kt(m),E=N(p);if(zt(t,g))return ir({asset:t,additionalHeaders:e,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,md5:d,progressCb:c,relation:l,size:u,service:E,blockSize:_,maxConcurrentRequests:f});J(t.links,[l]);const A=a.getLinkHrefTemplated(t.links,l,{component_id:r});return h.default.resolve(void 0,{blockUpload:void 0,progress:c}).then((()=>Promise.resolve(a.isAnyFunction(o)?o(0,g):o))).then((r=>Ze({asset:t,additionalHeaders:e,contentType:s,data:r,etag:n,headHref:A,href:A,maybeIsNew:i,relation:l,service:E}))).then((e=>{let r={};try{r=fe(e),t.links=a.merge(t.links||{},r);const s=L(p);s&&s.setValueWithAsset(t.links,t)}catch(e){}return{response:e,result:{revision:e.headers.revision||e.headers.version,location:e.headers.location,links:r,etag:e.headers.etag,version:e.headers.version||e.headers.revision,md5:e.headers.md5||e.headers["content-md5"],length:g,type:s},isBlockUpload:!1,asset:{assetId:t.assetId||e.headers["asset-id"],repositoryId:t.repositoryId||e.headers["repository-id"],links:t.links||r}}})).catch((e=>{throw e}))}function nr({service:e,asset:r,additionalHeaders:s,dataOrSliceCallback:n,contentType:i,progressCb:d,relation:c,size:l,componentId:h,md5:p,etag:_,relPath:f,createIntermediates:m,respondWith:g,blockSize:E,repoMetaPatch:A,maxConcurrentRequests:y,nameConflictPolicy:D}){const C=a.isAnyFunction(n)?n:function(e){if(!a.isAnyFunction(e.slice))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Data cannot be sliced");return function(t,r){return q(this,void 0,void 0,(function*(){return e.slice(t,r)}))}}(n);r&&J(r.links,[u.BLOCK_UPLOAD_INIT]);const I=(null==s?void 0:s[t.HeaderKeys.DIRECTIVE])===Ut;if(I&&null!=E)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"blockSize must not be provided when use-block-store directive is set, omit it");const v=sr(e,r||function(e){ht("getBlockUploadLinkForGuest"),a.validateParams(["svc",e,"object"]);const t=M("/content/create/~/:block_upload",N(e));return a.expandURITemplate(t,{})}(e),a.pruneUndefined({[t.BlockTransferProperties.REPO_REL_TYPE]:c,[t.BlockTransferProperties.REPO_IF_MATCH]:_,[t.BlockTransferProperties.REPO_SIZE]:l,[t.BlockTransferProperties.DC_FORMAT]:i,[t.BlockTransferProperties.COMPONENT_ID]:h,[t.BlockTransferProperties.REPO_MD5]:p,[t.BlockTransferProperties.REPO_BLOCK_SIZE]:E}),s);return v.then((t=>{const r=new rr(e,C,t.result,c,l,i,h,p,_,f,m,g,A,y,D,{useBlockStoreDirective:I});return r.onProgress=d,Object.assign(v,{blockUpload:r}),r.init(s)})).then((e=>e.start())).then((e=>{const t=e.finalizeResponse||{headers:{}},s=e.uploadRecord||e.createdAsset;return{response:t,result:s,blockUpload:e,isBlockUpload:!0,asset:{assetId:t.headers["asset-id"]||r.assetId,repositoryId:t.headers["repository-id"]||r.repositoryId,etag:t.headers.etag,links:r?r.links:s.links}}}))}function ir({service:e,asset:t,additionalHeaders:r,dataOrSliceCallback:s,contentType:o,progressCb:n,relation:i,size:a,componentId:d,md5:c,etag:l,relPath:h,createIntermediates:u,respondWith:p,blockSize:_,repoMetaPatch:f,maxConcurrentRequests:m,nameConflictPolicy:g}){return nr({service:e,asset:t,additionalHeaders:r,dataOrSliceCallback:s,contentType:o,progressCb:n,relation:i,size:a,componentId:d,md5:c,etag:l,relPath:h,createIntermediates:u,respondWith:p,blockSize:_,repoMetaPatch:f,maxConcurrentRequests:m,nameConflictPolicy:g})}function ar({service:e,additionalHeaders:t,dataOrSliceCallback:r,contentType:s,progressCb:o,relation:n,size:i,componentId:a,md5:d,etag:c,relPath:l,respondWith:h,blockSize:u,repoMetaPatch:p,maxConcurrentRequests:_,nameConflictPolicy:f}){return nr({service:e,asset:void 0,additionalHeaders:t,dataOrSliceCallback:r,contentType:s,progressCb:o,relation:n,size:i,componentId:a,md5:d,etag:c,relPath:l,createIntermediates:!0,respondWith:h,blockSize:u,repoMetaPatch:p,maxConcurrentRequests:_,nameConflictPolicy:f})}const dr=Ve;function cr(e){return e||"defaultbuffer"}function lr(e){return!!(e.deviceModifyDate||e.assetType||e.assetSubType)}function hr(e,r,s="json",o={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["format",s,"enum",!1,["json","xml"]]),J(r.links,[u.EMBEDDED_METADATA]);const n=a.getLinkHrefTemplated(r.links,u.EMBEDDED_METADATA,{version:r.version||t.VersionProperties.PINNED_VERSION});return e.invoke(t.HTTPMethods.GET,n,Object.assign(Object.assign({},o),{accept:t.EmbeddedMetadataMediaTypes[s.toUpperCase()]}),void 0,{isStatusValid:$(),responseType:"json"===s?"json":"text"}).then((e=>({result:e.response,response:e})))}function ur(e,r,s,o,n="json",i={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0],["format",n,"enum",!1,["json","xml"]]),J(r.links,[u.EMBEDDED_METADATA]);const d=a.getLinkHrefTemplated(r.links,u.EMBEDDED_METADATA,{}),c=Object.assign(Object.assign({},i),{[t.HeaderKeys.CONTENT_TYPE]:t.EmbeddedMetadataMediaTypes[n.toUpperCase()],[t.HeaderKeys.IF_MATCH]:o});return e.invoke(t.HTTPMethods.PUT,d,c,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:$()})}function pr(e,r,s,o,n={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0]),J(r.links,[u.EMBEDDED_METADATA]);const i=a.getLinkHrefTemplated(r.links,u.EMBEDDED_METADATA,{});return e.invoke(t.HTTPMethods.PATCH,i,Object.assign(n,{[t.HeaderKeys.CONTENT_TYPE]:F,[t.HeaderKeys.IF_MATCH]:o}),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:$(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}})}const _r=n.newDebug("dcx:assets:filebase"),fr=n.newDebug("dcx:assets:filebase:leaf"),mr="application/vnd.adobe.versions+json";class gr extends pt{constructor(e,r,s){super(e,r,s),this._data.width=null!=e.width?e.width:e[t.Properties.IMAGE_WIDTH],this._data.length=null!=e.length?e.length:e[t.Properties.IMAGE_LENGTH],this._data.renderable=null!=e.renderable?e.renderable:"object"==typeof this._data.links?u.RENDITION in this._data.links:void 0}get width(){return this._data.width}get length(){return this._data.length}get renderable(){return this._data.renderable}getRendition(e,t,r,s){return _r("getRendition()"),a.validateParams(["opts",e,"object",!0],["responseType",t,"string",!0],["linkProvider",r,"object",!0]),this.fetchLinksIfMissing([u.RENDITION],s).then((()=>Er(this._svc,this,e,t,r,s)))}getEmbeddedMetadata(e="json",t){return _r("getEmbeddedMetadata()"),a.validateParams(["format",e,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([u.EMBEDDED_METADATA],t).then((()=>hr(this._svc,this,e,t)))}putEmbeddedMetadata(e,t,r="json",s){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([u.EMBEDDED_METADATA],s).then((()=>ur(this._svc,this,e,t,r,s)))}patchEmbeddedMetadata(e,t,r){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([u.EMBEDDED_METADATA],r).then((()=>pr(this._svc,this,e,t,r)))}blockDownload(e,t,r,s,o,n,i){_r("blockDownload()"),a.validateParams(["startByte",e,"number",!0],["endByte",t,"number",!0],["resource",r,"string",!0],["componentId",s,"string",!0],["revision",o,"string",!0],["responseType",n,"enum",!0,z]),a.assert((()=>null==e||null==t||e<t),"endByte must be greater than startByte");const d={};return this._withSourcePromise(d).then((()=>this.fetchLinksIfMissing([u.BLOCK_DOWNLOAD]))).then((()=>Ar.call(d,this._svc,this,e,t,r,s,o,n,i)))}updatePrimaryResource(e,t,r,s,o,n){_r("updatePrimaryResource()");const i=a.isAnyFunction(e)?u.BLOCK_UPLOAD_INIT:u.PRIMARY;return this.fetchLinksIfMissing([i],n).then((()=>yr(this.serviceConfig,this,e,t,r,s,o,n))).then((e=>(this._data.etag=e.result.etag,this._data.md5=e.result.md5,this._data.length=e.result.length,this._data.version=e.result.version,e)))}}function Er(e,r,s,o="defaultbuffer",n,i){fr("getRendition()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["renditionOptions",s,"object",!0],["linkProvider",n,"object",!0]),J(r.links,[u.RENDITION]);const d=Object.assign(Object.assign({},s),{version:r.version||t.VersionProperties.PINNED_VERSION}),c=n?a.provideLink(r.links[u.RENDITION],n,d):a.getLinkHrefTemplated(r.links,u.RENDITION,d);return e.invoke(t.HTTPMethods.GET,c,i,void 0,{responseType:cr(o),isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function Ar(e,r,s,o,n,i,d,c,l){fr("doBlockDownload()"),a.validateParams(["svc",e,"object"],["assetOrPresignedUrl",r,["object","string"]],["startByte",s,"number",!0],["endByte",o,"number",!0],["resource",n,"string",!0],["componentId",i,"string",!0],["revision",d,"string",!0],["responseType",c,"enum",!0,z]),a.assert((()=>null==s||null==o||s<o),"endByte must be greater than startByte");const h=null!=this?this:{};if("string"==typeof r)return Ge.call(h,e,r,s,o,c,!0,void 0,l);const p=r;J(p.links,[u.BLOCK_DOWNLOAD]);const _=a.pruneUndefined({reltype:n,component_id:i,revision:d}),f=a.getLinkHrefTemplated(p.links,u.BLOCK_DOWNLOAD,{resource:void 0!==n?JSON.stringify(_):void 0,version:p.version||t.VersionProperties.PINNED_VERSION});return Ge.call(h,e,f,s,o,c,!1,void 0,l)}function yr(e,t,r,s,o,n,i,d){return fr("updatePrimaryResource()"),a.validateParams(["service",e,"object"],["asset",t,"object"],["dataOrSliceCallback",r,["function","object","string"]],["contentType",s,"string"],["size",o,"number",!0],["md5",i,"string",!0]),J(t.links,[u.PRIMARY]),or({svc:e,asset:t,dataOrSliceCallback:r,contentType:s,relation:u.PRIMARY,size:o,md5:i,maybeIsNew:!1,etag:n,additionalHeaders:d}).catch((a=>{var c;if(413===(null===(c=a.response)||void 0===c?void 0:c.statusCode))return ir({service:N(e),asset:t,dataOrSliceCallback:r,contentType:s,relation:u.PRIMARY,size:o,md5:i,etag:n,additionalHeaders:d});throw a}))}const Dr=n.newDebug("dcx:assets:pagination");class Cr{constructor(e,t,r,s){if(this._links=e,this._svc=t,this._transformer=r,this._items={},this.ListResource=s,!e||!e[u.PAGE])throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset must have links that contain a page relation.")}get items(){return Object.values(this._items)}get data(){return this._data}getPage(e={},r){Dr("getPage()");const{embed:s}=e,o=G(e,["embed"]);s&&(o.embed=s.some((e=>"object"==typeof e))?JSON.stringify(s):s.join(",")),this.ListResource&&Object.assign(o,{resource:this.ListResource});const n=a.getLinkHrefTemplated(this._links,u.PAGE,o);return this._svc.invoke(t.HTTPMethods.GET,n,r,void 0,{isStatusValid:$(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}getNextPage(){if(Dr("getNextPage()"),this.hasNextPage()&&this._nextPageLink)return this._svc.invoke(t.HTTPMethods.GET,this._nextPageLink.href,void 0,void 0,{isStatusValid:$(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}hasNextPage(){return Dr("hasNextPage() ",void 0!==this._nextPageLink),void 0!==this._nextPageLink}*[Symbol.iterator](){for(const e in this._items)yield this._items[e]}[Symbol.asyncIterator](){return function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,o=r.apply(e,t||[]),n=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){o[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof K?Promise.resolve(r.value.v).then(d,c):l(n[0][2],r)}catch(e){l(n[0][3],e)}var r}function d(e){a("next",e)}function c(e){a("throw",e)}function l(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}(this,arguments,(function*(){for(const e in this._items)yield yield K(this._items[e]);for(;this.hasNextPage();){const e=yield K(this.next());for(const t of e.value.paged)yield yield K(t)}}))}next(){return q(this,void 0,void 0,(function*(){if(Dr("next()"),!this.hasNextPage())return{done:!0,value:void 0};const e=yield this.getNextPage();return e?{done:!1,value:e}:{done:!0,value:void 0}}))}parseResponse(e){Dr("parseResponse()"),this._items={};const r=e.response;for(const e in r[t.Properties.CHILDREN]){const s=r[t.Properties.CHILDREN][e],[o,n]=this._transformer(s,this._svc);this._items[o]=n}return this._nextPageLink=r[t.Properties.LINKS].next,this.currentPage=r[t.Properties.PAGE],r}}const Ir=n.newDebug("dcx:assets:version"),vr=n.newDebug("dcx:assets:version:leaf");class Tr extends gr{constructor(e,t,r){super(e,t,r),this._svc=t,this.type=X.Version,this._data=Rr(e)}get milestone(){return this._data.milestone}get contributorIds(){return this._data.contributorIds}getRepositoryResource(){throw Ir("getRepositoryResource()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getEffectivePrivileges(){throw Ir("getEffectivePrivileges()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}performBulkRequest(e,t){throw Ir("performBulkRequest()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}checkACLPrivilege(e,t){throw Ir("checkACLPrivilege()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getACLPolicy(){throw Ir("getACLPolicy()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}}function br(e){vr("adobeVersionTransformer()");const t=Rr(e);return t.links=a.merge({},e.links,e._links),[t.version,t]}function Pr(e,t){vr("versionTransformer()");const r=new Tr(e,t);return[r.version,r]}function Rr(e){return vr("deserializeVersion()"),{version:e.version||e[t.VersionProperties.VERSION],createDate:e.created||e[t.VersionProperties.CREATED],createdBy:e.createdBy||e[t.VersionProperties.CREATED_BY],milestone:e.milestone||e[t.VersionProperties.MILESTONE],contributorIds:e.contributorIds||e[t.VersionProperties.CONTRIBUTORS],links:e._links}}const wr=n.newDebug("dcx:assets:file"),Or=n.newDebug("dcx:assets:file:leaf");class Sr extends gr{constructor(e,t,r){super(e,t,r),this.type=X.File}getPagedVersions(e={itemTransformer:Pr},t){return wr("getPagedVersions()"),a.validateParams(["pageOpts",e,"object",!0]),this.fetchLinksIfMissing([u.PAGE],t).then((()=>Lr(this._svc,this,e,t)))}getVersionResource(e,t){return wr("getVersionResource()"),a.validateParams(["version",e,"string"]),this.fetchLinksIfMissing([u.PAGE],t).then((()=>Nr(this._svc,this,e,t).then((e=>({result:e.result?new Tr(e.result,this._svc):void 0,response:e.response})))))}patchVersions(e,t,r){return wr("patchVersions()"),a.validateParams(["patchDoc",e,["string","array"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([u.VERSION_HISTORY],r).then((()=>kr(this._svc,this,e,t,r)))}initBlockUpload(e,t){return a.validateParams(["transferDocument",e,"object"],["additionalHeaders",t,"object",!0]),this.fetchLinksIfMissing([u.BLOCK_UPLOAD_INIT],t).then((()=>sr(this._svc,this,e,t)))}copy(e,t,r,s,o,n){return super.copy(e,t,r,s,o,n).then((({response:e,result:t})=>({response:e,result:new Sr(t,this.serviceConfig)})))}}function kr(e,r,s,o,n){Or("patchVersions()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["patchDoc",s,["string","array"]],["etag",o,"string",!0]),J(r.links,[u.VERSION_HISTORY]);const i=Object.assign(Object.assign({},n),{[t.HeaderKeys.CONTENT_TYPE]:F});o&&(i[t.HeaderKeys.IF_MATCH]=o);const d=a.getLinkHrefTemplated(r.links,u.VERSION_HISTORY,{});return e.invoke(t.HTTPMethods.PATCH,d,i,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:$()})}function Nr(e,r,s,o){Or("getVersionResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string"]),J(r.links,[u.PAGE]),Q(r.links,u.PAGE,"type",mr);const n=a.getLinkHrefTemplated(r.links,u.PAGE,{version:s});return e.invoke(t.HTTPMethods.GET,n,o,void 0,{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response[t.VersionProperties.TOTAL_CHILDREN]>0?e.response[t.Properties.CHILDREN][0]:void 0,response:e})))}function Lr(e,t,r={},s){return Or("getPagedVersions()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["pageOpts",r,"object"]),J(t.links,[u.PAGE]),Q(t.links,u.PAGE,"type",mr),new Cr(t.links,e,r.itemTransformer||br,u.VERSION_HISTORY).getPage(r,s)}const Mr=n.newDebug("dcx:assets:composite"),Xr=n.newDebug("dcx:assets:composite:leaf"),xr=n.AdobeDCXLogger.getInstance();class Br extends Sr{constructor(e,t,r){super(e,t,r),this.type=X.Composite}headManifest(e){return Mr("headManifest()"),this.fetchLinksIfMissing([u.MANIFEST],e).then((()=>jr(this._svc,this,e))).then((e=>this._updateDataWithResponse(e)))}getManifest(e,t,r){return Mr("getManifest()"),a.validateParams(["version",e,"string",!0],["etag",t,"string",!0]),this.fetchLinksIfMissing([u.MANIFEST],r).then((()=>Ur(this._svc,this,e,t,r)))}getManifestUrl(e){Mr("getManifestUrl()");const t=null==e?u.MANIFEST:u.PAGE;return this.fetchLinksIfMissing([t]).then((()=>Vr(this._svc,this,e)))}getManifestAndComponentsByPath(e,t,r,s){return Xr("getManifestAndComponentsByPath()"),Yr(this._svc,this,e,t,r,s)}getComponent(e,t,r,s,o){Mr("getComponent()");const n={};return this._withSourcePromise(n).then((()=>Qr.call(n,this._svc,this,e,t,r,s,o)))}getComponentByPath(e,t="defaultbuffer",r){return Mr("getComponentByPath()"),Zr(this.serviceConfig,this,e,t,r)}getComponentUrl(e,t,r){return Mr("getComponentUrl()"),this.fetchLinksIfMissing([u.COMPONENT],r).then((()=>Kr(this._svc,this,e,t)))}updateManifest(e,t,r,s,o,n){return Mr("updateManifest()"),this.fetchLinksIfMissing([u.MANIFEST],o).then((()=>es(this._svc,this,e,t,r,s,o,n))).then(this._updateDataWithResponse.bind(this))}putComponent(e,t,r,s,n,i,d,c){if(Mr("putComponent()"),s&&!a.verifyUuid(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");return a.verifyUuid(e)||xr.warn("Existing component id is not a uuid"),this.fetchLinksIfMissing([u.COMPONENT],c).then((()=>ts(this.serviceConfig,this,e,t,r,s,n,i,d,c)))}putEmbeddedMetadata(e,t,r="json",s){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([u.EMBEDDED_METADATA],s).then((()=>ur(this._svc,this,e,t,r,s))).then((e=>q(this,void 0,void 0,(function*(){return yield this.headManifest(s),e}))))}patchEmbeddedMetadata(e,t,r){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([u.EMBEDDED_METADATA],r).then((()=>pr(this._svc,this,e,t,r))).then((e=>q(this,void 0,void 0,(function*(){return yield this.headManifest(),e}))))}copy(e,t,r,s,o,n){return super.copy(e,t,r,s,o,n).then((({response:e,result:t})=>({response:e,result:new Br(t,this.serviceConfig)})))}}function jr(e,r,s){return Xr("headCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),J(r.links,[u.MANIFEST]),Vr(e,r,void 0,s).then((r=>e.invoke(t.HTTPMethods.HEAD,r,s,void 0,{responseType:"json",isStatusValid:$()})))}function Ur(e,r,s,n,i){return Xr("getCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string",!0],["etag",n,"string",!0]),J(r.links,[u.MANIFEST]),Vr(e,r,s,i).then((r=>e.invoke(t.HTTPMethods.GET,r,Object.assign(null!=i?i:{},n?{[t.HeaderKeys.IF_NONE_MATCH]:n}:{}),void 0,{isStatusValid:$([304]),retryOptions:{pollCodes:[404,202],pollHeader:"location",pollMethod:t.HTTPMethods.GET,problemWithCode:{problemType:o.ProblemTypes.RESOURCE_NOT_READY,code:404}}}))).then((e=>{if((200===e.statusCode||201===e.statusCode)&&"application/http"===e.headers[t.HeaderKeys.CONTENT_TYPE]){if(e.response){const t=nt(a.stringToBuffer(e.response));return{manifestData:JSON.parse(a.arrayBufferToString(t.response))||null,manifestEtag:t.headers.etag,response:t}}return{manifestData:e.response||null,manifestEtag:e.headers.etag,response:e.response}}if("string"==typeof e.response)return{manifestData:e.response?JSON.parse(e.response):null,manifestEtag:e.headers.etag,response:e};if(null===e.response&&["application/problem+json","application/json"].includes(e.headers["content-type"]))throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type");return{manifestData:e.response||null,manifestEtag:e.headers.etag,response:e}}))}function Vr(e,t,r,s){return Xr("getCompositeManifestUrl()"),Fr(e,t,u.MANIFEST,r,s).then((e=>a.expandURITemplate(e,{})))}function Hr(e,t,r,s){return Xr("_getComponentPathUrl()"),Fr(e,t,u.COMPONENT,t.version,s).then((e=>a.expandURITemplate(e,a.pruneUndefined({component_path:r}))))}function Fr(e,r,s,n,i){return Xr("_getUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["versionId",n,"string",!0]),h.default.resolve().then((()=>{if(n)return Nr(e,r,n,i)})).then((e=>{if(null!=n){if(!e||!a.isObject(e)||"object"!=typeof e.result)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Invalid version resource.",void 0,e?e.response:void 0);return J(e.result[t.Properties.LINKS],[s]),a.getLinkHref(e.result[t.Properties.LINKS],s)}return a.getLinkHref(r.links,s)}))}function Yr(e,r,s,n,i,d){a.validateParams(["svc",e,"object"],["asset",r,"object"],["components",s,"array"],["version",n,"string",!0],["etag",i,"string",!0]);const c=[u.MANIFEST,u.COMPONENT,u.BULK_REQUEST,u.BLOCK_DOWNLOAD];return n&&c.push(u.PAGE),Mt(e,r,c,void 0,d).then((c=>q(this,void 0,void 0,(function*(){r.links=Object.assign({},r.links,c);const l=N(e),h=s.map((({component_path:e,responseType:s,subrequestHeaders:o})=>({method:t.HTTPMethods.GET,href:a.getLinkHrefTemplated(r.links,u.COMPONENT,{component_path:e}),headers:Object.assign(o||{},d),component_path:e,responseType:s}))),p=yield Vr(l,r,n,d);h.unshift({method:t.HTTPMethods.GET,href:p,headers:Object.assign(i?{[t.HeaderKeys.IF_NONE_MATCH]:i}:{},d)});const _={startTime:a.now(),timeoutAfter:72e5};return a.retriesWithDelayOnError(Wr.bind(void 0,e,r,s,h,d),404,_,o.ProblemTypes.RESOURCE_NOT_READY)}))))}function Wr(e,r,s,n,i){return q(this,void 0,void 0,(function*(){const d=N(e),c=yield Promise.all(a.chunkArray(n,10).map((e=>at(d,r,e,void 0,i,!0))));return h.default.resolve(yield c.reduce(((c,l)=>q(this,void 0,void 0,(function*(){var h,p;const _=yield c;if(_.responses.push(l.response),200!==l.response.statusCode)return _;const{componentResponses:f,manifestResponse:m}=function(e,r){return e.reduce(((e,s)=>{const n=r.find((e=>e.href===s.headers[t.HeaderKeys.CONTENT_ID]));if(!n)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,s);return"component_path"in n?e.componentResponses.push(s):e.manifestResponse=s,e}),{componentResponses:[]})}(l.result,n),g={};if(s.forEach((e=>{e.hasOwnProperty("skipBlockDownload")&&(g[e.component_path]=e.skipBlockDownload)})),Object.assign(_.components,yield function(e,r,s,n,i,d,c){return q(this,void 0,void 0,(function*(){return(yield Promise.all(r.map((r=>q(this,void 0,void 0,(function*(){if(r.headers[t.HeaderKeys.CONTENT_TYPE]===H&&r.response.type===o.ProblemTypes.RESPONSE_TOO_LARGE){const o=zr(r,e),l=r.headers.location?r.headers.location:a.getLinkHrefTemplated(n,u.BLOCK_DOWNLOAD,{resource:JSON.stringify({component_path:o.component_path}),version:c||t.VersionProperties.PINNED_VERSION});if(d&&d[o.component_path])return{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:r.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:r.headers["content-length"],[t.HeaderKeys.CONTENT_ID]:r.headers[t.HeaderKeys.CONTENT_ID]}),responseType:"application/json",response:{href:l},message:"OK"};const h=yield Ge(N(s),l,void 0,void 0,"defaultbuffer",!0,void 0,i);return Object.assign(h.headers,{[t.HeaderKeys.CONTENT_ID]:r.headers[t.HeaderKeys.CONTENT_ID]}),h}return r})))))).reduce(((t,r)=>{const s=zr(r,e);try{const e=o._responseToError(r);t[s.component_path]=Object.assign({},s,{response:r,[e?"error":"data"]:e||Gr(r.response,s.responseType||"defaultbuffer",r.headers["content-type"])})}catch(e){t[s.component_path]=Object.assign({},s,{response:r,error:new o.DCXError(o.DCXError.UNEXPECTED,"Error parsing sub-response into requested responseType",e)})}return t}),{})}))}(n.slice(1),f,e,r.links,i,g,r.version)),!m)return _;if(200===m.statusCode){_.manifest.data=Gr(m.response,"json"),_.manifest.response=m,v(r)&&"function"==typeof(null===(h=r.current)||void 0===h?void 0:h.parse)&&(r.current.parse(a.arrayBufferToString(m.response)),r.current.versionId=m.headers.version),r.links=fe(m);const t=L(e);return t&&t.setValueWithAsset(r.links,r),_}if(304===m.statusCode)return _.manifest.response=m,_;if(404===m.statusCode){if(m.response=Gr(m.response,"json"),m.response&&m.response.type===o.ProblemTypes.RESOURCE_NOT_READY)throw new o.DCXError(o.DCXError.NOT_FOUND,void 0,void 0,m);return _.manifest.error=o._responseToError(m)||new o.DCXError(o.DCXError.NO_COMPOSITE,"Composite missing or deleted",void 0,m),_}if(m.headers[t.HeaderKeys.CONTENT_TYPE]===H&&m.response.type===o.ProblemTypes.RESPONSE_TOO_LARGE){try{const e=m.headers.location?m.headers.location:a.getLinkHrefTemplated(r.links,u.BLOCK_DOWNLOAD,{resource:JSON.stringify({reltype:u.MANIFEST}),version:r.version||t.VersionProperties.PINNED_VERSION}),s=yield Ge(d,e,void 0,void 0,"json",!0,void 0,i);_.manifest.data=s.response,_.manifest.response=s,v(r)&&"function"==typeof(null===(p=r.current)||void 0===p?void 0:p.parse)&&r.current.parse(JSON.stringify(s.response)),r.links=fe(s)}catch(e){_.manifest.error=e instanceof o.DCXError?e:new o.DCXError(o.DCXError.UNEXPECTED,"Error fetching manifest via block download",e)}return _}return _.manifest.error=o._responseToError(m)||new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,m.response.title||"Failed to fetch manifest. Operation failed.",void 0,m),_}))),Promise.resolve({manifest:{},components:{},responses:[]})))}))}function zr(e,r){if(!e.headers[t.HeaderKeys.CONTENT_ID])throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Sub-response is missing content-id header",void 0,e);const s=r.find((({href:r})=>r===e.headers[t.HeaderKeys.CONTENT_ID]));if(!s)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,e);return s}function Gr(e,t,r){if(!I(e))return e;switch(t){case"text":return a.arrayBufferToString(e);case"json":return JSON.parse(a.arrayBufferToString(e));case"blob":return new Blob([e],{type:r});case"buffer":case"defaultbuffer":return e;case"arraybuffer":return e.buffer}throw new o.DCXError(o.DCXError.INVALID_PARAMS,"requested response type is not supported")}function qr(e,r,s,n,i,d){return q(this,void 0,void 0,(function*(){const c=[{method:t.HTTPMethods.PUT,href:s,headers:i,body:n}],l=[];if(r.deviceModifyDate&&l.push({op:"add",path:`/${[t.Properties.REPO_DEVICE_MODIFY_DATE]}`,value:r.deviceModifyDate}),l.length){const e={[t.HeaderKeys.CONTENT_TYPE]:F};c.push({method:t.HTTPMethods.PATCH,href:a.getLinkHrefTemplated(r.links,u.REPO_METADATA,{}),headers:e,body:JSON.stringify(l)})}const{result:h,response:p}=yield at(e,r,c,void 0,d,!0),{manifestResponse:_,repoMetadataResponse:f}=function(e,r){const s={manifestResponse:{},repoMetadataResponse:{}};return r.forEach((r=>{const n=e.find((e=>e.headers[t.HeaderKeys.CONTENT_ID]===r.href));if(!n)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,n);r.href.includes(":repometadata")?s.repoMetadataResponse=n:s.manifestResponse=n})),s}(h,c);return{manifestResponse:_,repoMetadataResponse:f,response:p}}))}function Kr(e,t,r,s){return Xr("getCompositeComponentUrl()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string",!0]),J(t.links,[u.COMPONENT]),a.getLinkHrefTemplated(t.links,u.COMPONENT,{component_id:r,revision:s})}function $r(e,r,s,n){return Xr("getPresignedUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),Mt(e,r,[u.BLOCK_DOWNLOAD],void 0,n).then((o=>{const i=a.getLinkHrefTemplated(o,u.BLOCK_DOWNLOAD,{resource:s?JSON.stringify(s):void 0,version:r.version||t.VersionProperties.PINNED_VERSION});return(w(e)?e.service:e).invoke(t.HTTPMethods.GET,i,Object.assign({priority:"u=1"},n),void 0,{isStatusValid:$(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:t.HTTPMethods.GET}})})).then((e=>{if("string"!=typeof e.response.href)throw new o.DCXError(o.DCXError.INVALID_DATA,"Direct download URL not found.",void 0,e);return{response:e,result:e.response.href}}))}const Jr=d.telemetrySpan("AdobeDCX.getCompositeComponentPresignedUrl",(function(e,t,r,s,o){return Xr("getCompositeComponentPresignedUrl()"),d.setTracingSpanAttribute("componentId",r),d.setTracingSpanAttribute("componentRevision",s),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string"]),$r(e,t,{reltype:u.COMPONENT,revision:s,component_id:r},o)}));function Zr(e,t,r,s="defaultbuffer",o,n){return a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentPath",r,"string"],["responseType",s,"string",!0],["additionalHeaders",o,"object",!0]),Mt(e,t,[u.COMPONENT,u.PAGE],void 0,o).then((s=>{if(t.links=s,t.version)return Hr(N(e),t,r)})).then((i=>Je(N(e),t,null!=i?i:a.getLinkHrefTemplated(t.links,u.COMPONENT,{component_path:r}),u.COMPONENT,s,void 0,void 0,o,n)))}function Qr(e,t,r,s,o="defaultbuffer",n,i){Xr("getCompositeComponent()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string"],["responseType",o,"string",!0],["additionalHeaders",n,"object",!0],["componentSize",i,"number",!0]);const d={};if(!i||i<Jt()){const i=Kr(e,t,r,s);return Je.call(d,e,t,i,u.COMPONENT,o,r,s,n)}return Jr(e,t,r,s,n).then((({response:t,result:r})=>Ge.call(d,e,r,void 0,void 0,o,!0,t.response.size,n)))}function es(e,r,s,n,i=1,d,c={},l){if(Xr("updateCompositeManifest() ",n,d),a.validateParams(["svc",e,"object"],["asset",r,"object"],["manifest",s,["object","string"]],["overwrite",n,"boolean"],["validationLevel",i,"+number"],["etag",d,"string",!0]),i<1)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"ValidationLevel must be >=1");return J(r.links,[u.BULK_REQUEST,u.REPO_METADATA]),Fr(e,r,u.MANIFEST,void 0,c).then((h=>q(this,void 0,void 0,(function*(){const u=Object.assign({},c);n?u[t.HeaderKeys.IF_MATCH]="*":d&&(u[t.HeaderKeys.IF_MATCH]=d);const p=`${U}; validation-level=${i}`;u[t.HeaderKeys.CONTENT_TYPE]=p;const _="string"==typeof s?s:JSON.stringify(s);let f,m,g;const E=h.includes(t.Constants.REPO_META_PATCH)||h.includes(t.Constants.RESPOND_WITH);if(E){const s={},o=a.pruneUndefined({[t.Properties.REPO_DEVICE_MODIFY_DATE]:r.deviceModifyDate});Object.keys(o).length&&(s[t.Constants.REPO_META_PATCH]=o),l&&(s[t.Constants.RESPOND_WITH]=l),h=a.expandURITemplate(h,s),f=yield function(e,r,s,o){return q(this,void 0,void 0,(function*(){return yield e.invoke(t.HTTPMethods.PUT,r,o,s,{isStatusValid:$([412,409]),responseType:"arraybuffer",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:t.HTTPMethods.GET,modifyHeadersCallback:S([t.HeaderKeys.IF_MATCH])}})}))}(e,h,_,u)}else{h=a.expandURITemplate(h,{});const t=yield qr(e,r,h,_,u,c);f=t.manifestResponse,m=t.repoMetadataResponse,g=t.response}if(Xr("uCM() status code for manifest response: ",f.statusCode),412===f.statusCode&&n)return Xr("uCM() retry 412 without overwrite"),es(e,r,s,!1,i,void 0,c);if(409===f.statusCode&&n)return Xr("uCM() retry 409 without overwrite"),es(e,r,s,!1,i,d,c);if(409===f.statusCode)throw new o.DCXError(o.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,f);if(412===f.statusCode)throw new o.DCXError(o.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,f);if(400===f.statusCode){const e=o._responseToError(f);throw new o.DCXError(null==e?void 0:e.code,null==e?void 0:e.message,void 0,f)}{const e=$()(f.statusCode,f);if(!0!==e)throw new o.DCXError(e.code||o.DCXError.UNEXPECTED_RESPONSE,e._message||e.message,e.underlyingError,f)}if(!E){if(f.xhr=g.xhr,Xr("uCM() status code for metadata response: ",m.statusCode),lr(r)&&200!==m.statusCode&&201!==m.statusCode&&204!==m.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected HTTP Response",void 0,m);return f}let A=f;if(200===f.statusCode&&(A=nt(new Uint8Array(f.response))),A.response&&l)try{const e=JSON.parse(a.arrayBufferToString(A.response));A.response=ce(e)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected error parsing respondWith parameter",e)}return A}))))}function ts(e,t,r,s,n,i,d,c,l,h,p){if(a.validateParams(["service",e,"object"],["asset",t,"object"],["componentId",r,"string"],["contentType",n,"string"],["maybeIsNew",i,"boolean",!0],["size",d,"number",!0],["blockSize",p,"number",!0],["md5",c,"string",!0]),i&&!a.verifyUuid(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");return a.verifyUuid(r)||xr.warn("Existing component id is not a uuid"),or({svc:e,asset:t,dataOrSliceCallback:s,contentType:n,relation:u.COMPONENT,size:d,componentId:r,md5:c,maybeIsNew:i,additionalHeaders:h,progressCb:l,blockSize:p}).then((({response:e,result:t,isBlockUpload:s,asset:o})=>{const i={response:e,result:Object.assign(Object.assign({},t),{id:r,type:n}),isBlockUpload:s,asset:o};return Object.defineProperty(i,"compositeAsset",{get:()=>o}),i}))}const rs=n.newDebug("dcx:assets:directory"),ss=n.newDebug("dcx:assets:directory:leaf");class os extends pt{constructor(e,r,s){super(e,r,s),this.type=X.Directory,this.children=[],this.children=e[t.Properties.CHILDREN]}getPagedChildren(e,t){return rs("getPagedChildren()"),this.fetchLinksIfMissing([u.PAGE],t).then((()=>as(this._svc,this,e,t)))}createAsset(e,t,r,s,o,n,i,a,d,c){return rs("createAsset()"),cs(this._svc,this,e,t,r,s,o,n,i,a,d,c).then((e=>({result:new pt(e.result,this.serviceConfig),response:e.response})))}createAssetForGuest(e,t,r,s,o,n,i,a,d){return rs("createAssetForGAT"),ls(this._svc,e,t,r,s,o,n,i,a,d).then((e=>({result:new pt(e.result,this.serviceConfig),response:e.response})))}copy(e,t,r,s,o,n){return super.copy(e,t,r,s,void 0,n).then((({response:e,result:t})=>({response:e,result:new os(t,this.serviceConfig)})))}}function ns(e){var r;ss("directoryTransformer()");const s=ce(e,null===(r=e[t.Properties.PAGE])||void 0===r?void 0:r.embed);s.links=a.merge({},e.links,e._links);const o=e.children||e[t.Properties.CHILDREN];return o&&o.length>0?s.children=o.map((e=>ce(e))):s.children=[],[s.assetId,s]}function is(e,r){return ss("getDirectoryByURL()"),e.invoke(t.HTTPMethods.GET,r,void 0,void 0,{responseType:"json",isStatusValid:$()}).then((e=>({result:e.response,response:e})))}function as(e,t,r={},s){if(ss("getPagedChildren()"),J(t.links,[u.PAGE]),r&&r.embed&&r.embed.includes(u.REPOSITORY))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Repository Resource embeds on directory listings are not supported");try{return new Cr(t.links,e,ns,"api:primary").getPage(r,s)}catch(e){return h.default.reject(e)}}function ds(e,r,s,n,i){const d=N(e);return i&&"rename"===i?a.isObject(s)&&n&&(n===u.REPO_METADATA||a.isObject(n)&&n.reltype===u.REPO_METADATA)?h.default.resolve(s.name||r.substring(r.lastIndexOf("/")+1)):Dt(d,{assetId:s.headers["asset-id"],links:fe(s)}).then((e=>e.result[t.Properties.REPO_NAME])).catch((e=>{throw e.response?o._responseToError(e.response):new l.default(e.code,e.message,e.underlyingError,e.response,e.additionalData)})):h.default.resolve(r.substring(r.lastIndexOf("/")+1))}const cs=d.telemetrySpan("AdobeDCX.createAsset",(function(e,r,s,n,i,c,p={},_,f,m,g,E){ss("createAsset()"),a.validateParams(["service",e,"object"],["parentDir",r,"object"],["relPath",s,"string"],["createIntermediates",n,"boolean"],["contentType",i,"string"],["respondWith",c,["string","object"],!0],["additionalHeaders",p,"object",!0],["repoMetaPatch",m,"object",!0]),c||"rename"!==E||(c=u.REPO_METADATA);const A=a.isObject(c)?JSON.stringify(c):c;return Mt(e,r,[u.CREATE]).then((y=>{const D=a.getLinkHrefTemplated(y,u.CREATE,{path:s,intermediates:n.toString(),respondWith:A,mode:"id",repoMetaPatch:m,nameConflictPolicy:E}),C=Object.assign({},{[t.HeaderKeys.CONTENT_TYPE]:i},p),I=N(e),v=_?$t(_,f):void 0,T=v?Kt(v):0;return _&&zt(r,T)?ir({service:I,contentType:i,relation:u.PRIMARY,asset:r,dataOrSliceCallback:_,size:T,relPath:s,createIntermediates:n,respondWith:c,repoMetaPatch:m,additionalHeaders:p,progressCb:g,nameConflictPolicy:E}).then((({result:t,response:r})=>ds(e,s,r,c,E).then((e=>({result:a.pruneUndefined(a.mergeDeep({name:e},t)),response:r}))))):h.default.resolve().then((()=>q(this,void 0,void 0,(function*(){const h=a.isAnyFunction(_)?yield _(0,T):v;return I.invoke(t.HTTPMethods.POST,D,C,h,{responseType:"json",isStatusValid:$([413]),reuseRequestDesc:{id:"createAsset",method:t.HTTPMethods.POST,href:D,headers:C,progress:g}}).then((h=>{var A;if(413===h.statusCode)return ir({service:I,contentType:i,relation:u.PRIMARY,asset:r,dataOrSliceCallback:_,size:Kt($t(_,f)),relPath:s,createIntermediates:n,respondWith:c,repoMetaPatch:m,additionalHeaders:p,progressCb:g,nameConflictPolicy:E}).catch((e=>{var t;if(e.problemType===o.ProblemTypes.ASSET_NAME_CONFLICT){const r={assetId:null===(t=e.response.response)||void 0===t?void 0:t["repo:assetId"],links:fe(e.response)};return ir({service:I,contentType:i,relation:u.PRIMARY,asset:r,dataOrSliceCallback:_,size:Kt($t(_,f)),relPath:s,createIntermediates:n,respondWith:c,repoMetaPatch:m,additionalHeaders:p,progressCb:g,nameConflictPolicy:E})}throw e})).then((({result:t,response:r})=>ds(e,s,r,c,E).then((e=>({result:a.pruneUndefined(a.mergeDeep({name:e},t)),response:r})))));let y;r.path&&(y=a.appendPathElements(r.path,s));const D=fe(h),C=h.headers;if(null===(A=C[t.HeaderKeys.CONTENT_TYPE])||void 0===A?void 0:A.includes("multipart/mixed")){const e=rt(h)[1];throw 404===e.statusCode?new l.default(o.DCXError.ASSET_NOT_FOUND,"Asset was created successfully but repository metadata could not be found.",void 0,h):403===e.statusCode?new l.default(o.DCXError.FORBIDDEN,"Asset was created successfully but Permission denied for fetching repository metadata.",void 0,h):o.unexpectedResponse("Unexpected Server Response",void 0,h)}const v=a.isObject(h.response)?h.response:{etag:"",md5:""},T=C["asset-id"]||C["x-resource-id"],b=r.repositoryId;d.setTracingSpanAttribute("assetId",T);let P=v.etag,R=v.md5;null==c&&(P=C.etag,R=C["content-md5"]);const w=a.isObject(h.response)&&c&&(c===u.REPO_METADATA||a.isObject(c)&&c.reltype===u.REPO_METADATA)?ce(h.response):{};h.response&&(w.representations=h.response.representations||h.response[t.Properties.REPO_REPRESENTATIONS]);const O=L(e);return O&&O.setValueWithAsset(D,w),ds(e,s,h,c,E).then((e=>({result:a.pruneUndefined(a.mergeDeep({name:e},w,a.pruneUndefined({links:D,assetId:T,etag:P,md5:R,repositoryId:b,format:i,path:y}))),response:h})))}))}))))}))}));function ls(e,r,s,n,i={},d,c,p,_,f){ss("createAssetForGuest()"),a.validateParams(["service",e,"object"],["relPath",r,"string"],["contentType",s,"string"],["respondWith",n,["string","object"],!0],["additionalHeaders",i,"object",!0],["repoMetaPatch",p,"object",!0]),n||"rename"!==f||(n=u.REPO_METADATA);const m=a.isObject(n)?JSON.stringify(n):n,g=N(e);return function(e,t,r,s,o){ht("getCreateLinkForGuestUser"),a.validateParams(["svc",e,"object"],["assetPath",t,"string"]);const n={path:t,mode:"id",intermediates:"true",repoMetaPatch:s,respondWith:r,nameConflictPolicy:o},i=M("/content/create/~/:create{?path,mode,intermediates,respondWith,nameConflictPolicy,repoMetaPatch*}",N(e));return h.default.resolve(a.expandURITemplate(i,a.pruneUndefined(n)))}(g,r,m,p,f).then((m=>{const E=Object.assign({},{[t.HeaderKeys.CONTENT_TYPE]:s},i),A=d?$t(d,c):void 0,y=A?Kt(A):0;return d&&y>Ht?ar({service:g,contentType:s,relation:u.PRIMARY,dataOrSliceCallback:d,size:y,relPath:r,respondWith:n,repoMetaPatch:p,additionalHeaders:i,progressCb:_,nameConflictPolicy:f}).then((({result:t,response:s})=>ds(e,r,s,n,f).then((e=>({result:a.pruneUndefined(a.mergeDeep({name:e},t)),response:s}))))):h.default.resolve().then((()=>q(this,void 0,void 0,(function*(){const h=a.isAnyFunction(d)?yield d(0,y):A;return g.invoke(t.HTTPMethods.POST,m,E,h,{responseType:"json",isStatusValid:$([413]),reuseRequestDesc:{id:"createAssetForGuest",method:t.HTTPMethods.POST,href:m,headers:E,progress:_}}).then((h=>{var m;if(413===h.statusCode)return ar({service:g,contentType:s,relation:u.PRIMARY,dataOrSliceCallback:d,size:Kt($t(d,c)),relPath:r,respondWith:n,repoMetaPatch:p,additionalHeaders:i,progressCb:_,nameConflictPolicy:f}).catch((e=>{if(e.problemType===o.ProblemTypes.ASSET_NAME_CONFLICT)return ar({service:g,contentType:s,relation:u.PRIMARY,dataOrSliceCallback:d,size:Kt($t(d,c)),relPath:r,respondWith:n,repoMetaPatch:p,additionalHeaders:i,progressCb:_,nameConflictPolicy:f});throw e})).then((({result:t,response:s})=>ds(e,r,s,n,f).then((e=>({result:a.pruneUndefined(a.mergeDeep({name:e},t)),response:s})))));const E=fe(h),A=h.headers;if(null===(m=A[t.HeaderKeys.CONTENT_TYPE])||void 0===m?void 0:m.includes("multipart/mixed")){const e=rt(h)[1];throw 404===e.statusCode?new l.default(o.DCXError.ASSET_NOT_FOUND,"Asset was created successfully but repository metadata could not be found.",void 0,h):403===e.statusCode?new l.default(o.DCXError.FORBIDDEN,"Asset was created successfully but Permission denied for fetching repository metadata.",void 0,h):o.unexpectedResponse("Unexpected Server Response",void 0,h)}const y=a.isObject(h.response)?h.response:{etag:"",md5:""},D=A["asset-id"]||A["x-resource-id"],C=A["repository-id"];let I=y.etag,v=y.md5;null==n&&(I=A.etag,v=A["content-md5"]);const T=a.isObject(h.response)&&n&&(n===u.REPO_METADATA||a.isObject(n)&&n.reltype===u.REPO_METADATA)?ce(h.response):{},b=L(e);return b&&b.setValueWithAsset(E,T),ds(e,r,h,n,f).then((e=>({result:a.pruneUndefined(a.mergeDeep({name:e},T,a.pruneUndefined({links:E,assetId:D,etag:I,md5:v,format:s,repositoryId:C,path:r}))),response:h})))}))}))))}))}const hs=n.newDebug("dcx:assets:discoverable");function us(e){hs("discoverableAssetTransformer()");const r=e[t.Properties.EMBEDDED][u.REPO_METADATA],s=ce(r,e[t.Properties.EMBEDDED]);return s.links=a.merge({},e.links,r._links),[s.assetId,s]}function ps(e){hs("discoverableReposTransformer()");const r=e[t.Properties.EMBEDDED][u.PRIMARY],s=le(r);return s.links=r._links,[s.repositoryId,s]}const _s=n.newDebug("dcx:assets:factory");function fs(e,t){_s("hydrateAsset()"),a.validateParams(["asset",e,"object"],["svc",t,"object"]);const r=e.format||"",s=r.endsWith("+dcx")?X.Composite:r===j?X.Directory:r.split("/").length>1?X.File:X.Asset;switch(s){case X.Directory:return e.type===s&&e instanceof os?e:new os(e,t);case X.Composite:return e.type===s&&e instanceof Br?e:new Br(e,t);case X.File:return e.type===s&&e instanceof Sr?e:new Sr(e,t);case X.Asset:return e.type===s&&e instanceof pt?e:new pt(e,t);default:return new pt(e,t)}}const ms=n.newDebug("dcx:assets:indexdocument");function gs(e){ms("deserializeIndexDocument()");const r=e.children.map((e=>{const r=ce(e[t.Properties.EMBEDDED][u.REPO_METADATA]),s=le(e[t.Properties.EMBEDDED][u.REPOSITORY]);return r.embedded={RepositoryResource:s},r}));return{regions:e[t.Properties.REPO_REGIONS],assignedDirectories:r,links:e._links}}const Es=1e5;class As{constructor(e=1e5,t="SESSION"){if(this.values={},this.maxEntries=Es,this.promiseToResolveMap=new Map,e<=0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Cache Max enteries must be great than 0.");this.maxEntries=e,this.defaultSessionKey=t}clear(){this.promiseToResolveMap.forEach((e=>{e.call(void 0)}));for(const e in this.values)this.values[e].clear();this.values={}}getKey(e){if(e.assetId||"object"!=typeof e)return e.assetId}getValueWithAsset(e){if(!e.assetId&&"object"==typeof e)return;const t=this.getKey(e);return t?this.get(t,e.repositoryId):void 0}setPending(e,t=this.defaultSessionKey){let r;this.values[t]||(this.values[t]=new Map);const s=this.values[t].get(e);if(s&&s instanceof Promise)return this.promiseToResolveMap.get(s);const o=new Promise((e=>{r=e}));return this.values[t].set(e,o),this.promiseToResolveMap.set(o,r),o.then((()=>this.promiseToResolveMap.delete(o))).catch((()=>this.promiseToResolveMap.delete(o))),r}get(e,t=this.defaultSessionKey){if(this.values[t]&&t in this.values)return this.values[t].get(e)}setValueWithAsset(e,t){if(!e)return;const r=this.getKey(t);if(r){const s=t.repositoryId||this.defaultSessionKey;this.set(e,r,s)}}set(e,t,r=this.defaultSessionKey){if(this.values[r]){if(this.values[r]&&this.values[r].get(t)instanceof Promise){const s=this.values[r].get(t),o=this.promiseToResolveMap.get(s);this.promiseToResolveMap.delete(s),o&&o(e)}}else this.values[r]=new Map;if(this.values[r].size>=this.maxEntries){const e=this.values[r].keys().next().value;this.values[r].delete(e)}this.values[r].set(t,Promise.resolve(e))}delete(e,t=this.defaultSessionKey){this.values[t]&&this.values[t].delete(e)}deleteWithAsset(e){const t=this.getKey(e);t&&this.delete(t,e.repositoryId)}}var ys,Ds;t.RenditionType=void 0,(ys=t.RenditionType||(t.RenditionType={})).IMAGE_JPG="image/jpg",ys.IMAGE_PNG="image/png",ys.IMAGE_GIF="image/gif",ys.VIDEO_MP4="video/mp4",ys.VIDEO_METADATA="application/vnd.adobe.ccv.videometadata",t.RenditionC2paSign=void 0,(Ds=t.RenditionC2paSign||(t.RenditionC2paSign={})).NONE="none",Ds.EMBEDDED="embedded";const Cs=n.newDebug("dcx:assets:versionset"),Is=n.newDebug("dcx:assets:versionset:leaf");Object.defineProperty(t,"ProblemTypes",{enumerable:!0,get:function(){return o.ProblemTypes}}),t.ACLPolicyMediaType="application/vnd.adobecloud.accesscontrolpolicy+json",t.Asset=pt,t.AssetFactory=class{constructor(e){this._svc=e}hydrate(e){return fs(e,this._svc)}},t.AssetTypes=X,t.BlockTransferMediaType=Y,t.BlockUpload=rr,t.COPY_RESOURCES_LIMIT=500,t.COPY_RESOURCES_RESOURCE_LIMIT=30,t.Composite=Br,t.DEFAULT_BLOCK_DOWNLOAD_THRESHOLD=Ft,t.DEFAULT_BLOCK_UPLOAD_THRESHOLD=Ht,t.DEFAULT_CACHE_MAX_ENTRIES=Es,t.DEFAULT_MAX_CONCURRENT_REQUESTS=4,t.DEFAULT_STRING_LENGTH_CHECK=Yt,t.Directory=os,t.DirectoryMediaType=j,t.File=Sr,t.GenericCache=As,t.JSONLDMediaType="application/ld+json",t.JSONMediaType=V,t.JSONPatchMediaType=F,t.JSONProblemMediaType=H,t.LinkRelation=u,t.MAX_CACHE_PERIOD_MS=2592e6,t.ManifestMediaType=U,t.OperationDocumentBuilder=Oe,t.OperationDocumentMediaType=W,t.PageResource=Cr,t.RepositoryLinksCache=class extends As{constructor(e=1e5,t=2592e6){super(e,"SESSION"),this.timestampsOnLinkCreation=0,this.maxCachePeriodMS=0,this.maxCachePeriodMS=t}isLinkExpired(){return this.maxCachePeriodMS<Date.now()-this.timestampsOnLinkCreation}setIndexLinks(e){this.set(e,"INDEX","SESSION"),this.timestampsOnLinkCreation=Date.now()}getIndexLinks(){if(!this.isLinkExpired())return this.get("INDEX","SESSION")}setIndexRepository(e){this.indexRepository=e}getIndexRepository(){return this.indexRepository}setRepositoryLinks(e){this.set(e,"/Repositories","SESSION"),this.timestampsOnLinkCreation=Date.now()}getRepositoryLinks(){if(!this.isLinkExpired())return this.get("/Repositories","SESSION")}},t.STREAMABLE_RESPONSE_TYPES=z,t.Version=Tr,t.VersionSet=class{constructor(e,r,s){this._svc=r,this.versionCount=e.versionCount||e[t.VersionProperties.TOTAL_CHILDREN],this.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],this.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],this.versions=[];for(const s in e.versions||e[t.Properties.CHILDREN])this.versions.push(new Tr(e.versions&&e.versions[s]?e.versions[s]:e[t.Properties.CHILDREN][s],r));this.links=a.merge({},e.links,e._links,s)}versionByVersionId(e){return Cs("versionByVersionId()"),this.versions.find((t=>t.version===e))}versionsByLabel(e){return Cs("versionsByLabel()"),this.versions.filter((t=>!(!t.milestone||t.milestone.label!==e)))}},t._copyResources=je,t._getComponentPathUrl=Hr,t._getUrl=Fr,t._parseUploadableData=$t,t.adobeVersionTransformer=br,t.assertLinksContain=J,t.assertLinksContainAny=Z,t.assertValidBulkRequest=it,t.assetTransformer=function(e){ut("assetTransformer()");const t=ce(e);return t.links=a.merge({},e.links,e._links),[t.assetId,t]},t.blockTransferManager=dr,t.bodyToUint8Array=tt,t.buildRangeHeader=Ke,t.checkACLPrivilege=St,t.constructMultipartRequestBody=et,t.constructServiceEndpoint=M,t.convertToACPRepoMetadataResource=function(e){de("convertToACPRepoMetadataResource()");const r={};return r[t.Properties.REPO_REPOSITORY_ID]=e[t.Properties.REPO_REPOSITORY_ID]||e.repositoryId,r[t.Properties.REPO_ASSET_ID]=e[t.Properties.REPO_ASSET_ID]||e.assetId,r[t.Properties.REPO_NAME]=e[t.Properties.REPO_NAME]||e.name,r[t.Properties.REPO_SIZE]=null!=e[t.Properties.REPO_SIZE]?e[t.Properties.REPO_SIZE]:e.size,r[t.Properties.REPO_PATH]=e[t.Properties.REPO_PATH]||e.path,r[t.Properties.REPO_ASSET_CLASS]=e[t.Properties.REPO_ASSET_CLASS]||e.etag,r[t.Properties.REPO_ETAG]=e[t.Properties.REPO_ETAG]||e.etag,r[t.Properties.REPO_VERSION]=e[t.Properties.REPO_VERSION]||e.version,r[t.Properties.DC_FORMAT]=e[t.Properties.DC_FORMAT]||e.format,r[t.Properties.REPO_CREATE_DATE]=e[t.Properties.REPO_CREATE_DATE]||e.createDate,r[t.Properties.REPO_MODIFY_DATE]=e[t.Properties.REPO_MODIFY_DATE]||e.modifyDate||e.modifiedDate,r[t.Properties.REPO_DISCARD_DATE]=e[t.Properties.REPO_DISCARD_DATE]||e.discardDate,r[t.Properties.REPO_CREATED_BY]=e[t.Properties.REPO_CREATED_BY]||e.createdBy,r[t.Properties.REPO_MODIFIED_BY]=e[t.Properties.REPO_MODIFIED_BY]||e.modifiedBy,r[t.Properties.REPO_DISCARDED_BY]=e[t.Properties.REPO_DISCARDED_BY]||e.discardedBy,r[t.Properties.REPO_DEVICE_CREATE_DATE]=e[t.Properties.REPO_DEVICE_CREATE_DATE]||e.deviceCreateDate,r[t.Properties.REPO_DEVICE_MODIFY_DATE]=e[t.Properties.REPO_DEVICE_MODIFY_DATE]||e.deviceModifyDate,r[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION]=e[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION]||e.defaultScheduledDeletionDuration,r[t.Properties.REPO_SCHEDULED_DELETION_DATE]=e[t.Properties.REPO_SCHEDULED_DELETION_DATE]||e.scheduledDeletionDate,r[t.Properties.REPO_BASE_ASSET_ID]=e[t.Properties.REPO_BASE_ASSET_ID]||e.baseAssetId,r[t.Properties.REPO_ASSET_TYPE]=e[t.Properties.REPO_ASSET_TYPE]||e.assetType,r[t.Properties.REPO_ASSET_SUB_TYPE]=e[t.Properties.REPO_ASSET_SUB_TYPE]||e.assetSubType,r[t.Properties.REPO_STATE]=e[t.Properties.REPO_STATE]||e.state,r[t.Properties.LINKS]=e[t.Properties.LINKS]||e.links,r[t.Properties.REPO_REPRESENTATIONS]=e[t.Properties.REPO_REPRESENTATIONS]||e.representations,r[t.Properties.IMAGE_WIDTH]=e[t.Properties.IMAGE_WIDTH]||e.width,r[t.Properties.IMAGE_LENGTH]=e[t.Properties.IMAGE_LENGTH]||e.length,r[t.Properties.REPO_CONTRIBUTORS]=e[t.Properties.REPO_CONTRIBUTORS]||e.contributors,r[t.Properties.STORAGE_LES]=e[t.Properties.STORAGE_LES]||e.les,r[t.Properties.STORAGE_REGION]=e[t.Properties.STORAGE_REGION]||e.region,r[t.Properties.REPO_PINNED_VERSION]=e[t.Properties.REPO_PINNED_VERSION]||e.pinnedVersion,r[t.Properties.REPO_PINNED_VERSION_MODIFY_DATE]=e[t.Properties.REPO_PINNED_VERSION_MODIFY_DATE]||e.pinnedVersionModifyDate,a.pruneUndefined(r)},t.copyAsset=ye,t.copyAssetResources=function(e,t,r,s,o,n,i){return je(e,t,r,s,o,n,i)},t.copyResources=function(e,t,r,s,o,n,i){return Ee("copyResource()"),je(e,t,r,s,o,n,i).then((e=>e.response)).then(Xe)},t.createAsset=cs,t.createAssetForGuest=ls,t.defaultBufferResponseType=cr,t.deleteACLPolicy=Nt,t.deleteAsset=ve,t.deserializeAsset=ce,t.deserializeIndexDocument=gs,t.deserializeRepository=le,t.deserializeUploadComponentRecord=Zt,t.deserializeVersion=Rr,t.deserializeVersionSet=function(e){Is("deserializeVersionSet()");const r={versionCount:e[t.VersionProperties.TOTAL_CHILDREN],repositoryId:e[t.VersionProperties.REPO_ID],assetId:e[t.Properties.REPO_ASSET_ID],links:{},versions:[]},s=e.children||e[t.Properties.CHILDREN];return s&&s.length>0&&(r.versions=s.map((e=>Rr(e)))),r.links=e._links,r},t.directoryTransformer=ns,t.discardAsset=Ie,t.discoverableAssetTransformer=us,t.discoverableReposTransformer=ps,t.doBatchOperation=function(e,t,r,s){return Ne(e,t,r,s).then(Pe)},t.doBlockDownload=Ar,t.doLinksContain=ee,t.doOperation=we,t.doesAssetContainLinks=te,t.fetchLinksForAsset=Et,t.fetchLinksForAssetWithResponse=At,t.fetchLinksIfMissing=Mt,t.getACLPolicy=Ot,t.getAppMetadata=bt,t.getBaseDirectoryMetadata=It,t.getBlockDownloadThreshold=Jt,t.getCompositeComponent=Qr,t.getCompositeComponentByPath=Zr,t.getCompositeComponentPresignedUrl=Jr,t.getCompositeComponentUrl=Kr,t.getCompositeComponentsUrlsForUpload=function(e,r,s,n){return Mt(e,r,[u.COMPONENT,u.BLOCK_UPLOAD_INIT],void 0,n).then((i=>{var d;const c=N(e);null===(d=L(e))||void 0===d||d.setValueWithAsset(i,r),r.links=Object.assign(Object.assign({},r.links),i);const l=a.normalizeHeaders(a.pruneUndefined(Object.assign(Object.assign({},n),{[t.HeaderKeys.AUTHORIZATION]:c.authProvider.authToken,[t.HeaderKeys.X_API_KEY]:c.authProvider.apiKey})));return Promise.all(s.map((e=>zt(r,e.size)?function(e,r,s,n){return sr(e,r,a.pruneUndefined({"repo:reltype":u.COMPONENT,"repo:size":s.size,"dc:format":s.contentType,component_id:s.componentId}),n).then((e=>{if(200!==e.response.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from block upload init",e.response);const r=e.result;return{blockSize:r[t.BlockTransferProperties.REPO_BLOCK_SIZE],uploadRequestParameters:r[t.Properties.LINKS][u.BLOCK_TRANSFER].map((({href:e})=>({href:e,method:t.HTTPMethods.PUT}))),finalizeRequestParameters:{href:a.getLinkHrefTemplated(r[t.Properties.LINKS],u.BLOCK_FINALIZE,{}),method:t.HTTPMethods.POST,headers:n,body:`${JSON.stringify(r)}`}}})).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from block upload init",e)}))}(c,r,e,l):function(e,r,s,o){return h.default.resolve({blockSize:s.size,uploadRequestParameters:[{href:Kr(e,r,s.componentId),method:t.HTTPMethods.PUT,headers:o}]})}(c,r,e,l))))}))},t.getCompositeManifest=Ur,t.getCompositeManifestUrl=Vr,t.getDataLength=Kt,t.getDirectory=function(e,r){return ss("directoryTransformer()"),Mt(e,r,[u.PRIMARY]).then((s=>is(N(e),a.getLinkHrefTemplated(s,u.PRIMARY,{version:r.version||t.VersionProperties.PINNED_VERSION}))))},t.getDirectoryByURL=is,t.getDiscoverableAssets=function(e,t={},r){hs("getDiscoverableAssets()"),a.validateParams(["svc",e,"object"],["pageOpts",t,"object"]);const s=N(e);return _e(e,r).then((e=>new Cr(e.assetLinks,s,us,"api:primary").getPage(t,r))).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getDiscoverableRepos=function(e,r={},s){hs("getDiscoverableRepos()"),a.validateParams(["svc",e,"object"],["pageOpts",r,"object"]);const o=N(e),n=M("/repositories",o);return h.default.resolve(void 0).then((()=>q(this,void 0,void 0,(function*(){const i=L(e);let a;return i&&(a=yield i.getRepositoryLinks()),a||(a=fe(yield o.invoke(t.HTTPMethods.HEAD,n,s,void 0,{isStatusValid:$(),skipLinksDirective:!0}))),i&&i.setRepositoryLinks(a),new Cr(a,o,ps).getPage(r,s)})))).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getEffectivePrivileges=wt,t.getEmbeddedMetadata=hr,t.getHTTPResource=ae,t.getIndexDocument=function(e,r){ms("getIndexDocument()"),a.validateParams(["svc",e,"object"]);const s=N(e),o=M("/index",s);return s.invoke(t.HTTPMethods.GET,o,r,void 0,{responseType:"json",isStatusValid:$(),skipLinksDirective:!0}).then((e=>({result:gs(e.response),response:e.response})))},t.getIndexLinks=pe,t.getIndexRepository=_e,t.getLinksForAsset=yt,t.getLinksFromCache=Bt,t.getManifestAndComponentsByPath=Yr,t.getOpsHref=ge,t.getPagedChildren=as,t.getPagedVersions=Lr,t.getPresignedUrl=$r,t.getPrimaryResource=_t,t.getPubsAsset=function(e,r){ue("getPubsAsset()");const s=N(e),o=M("/index-pubs",s);return s.invoke(t.HTTPMethods.GET,o,r,void 0,{responseType:"json",isStatusValid:$(),skipLinksDirective:!0}).then((r=>{const s=ce(r.response.pubsDir[t.Properties.EMBEDDED]["http://ns.adobe.com/adobecloud/rel/metadata/repository"]),o=L(e);return o&&o.setValueWithAsset(s.links,s),s}))},t.getRendition=Er,t.getRepoMetadata=Dt,t.getRepositoryResource=vt,t.getReposityLinksCache=L,t.getResolveByIdHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByIdHref)return h.default.resolve(this.resolveByIdHref);if(a.isAnyFunction(this.resolveByIdHref))return h.default.resolve(this.resolveByIdHref())}return pe(e).then((e=>{try{return a.getLinkHref(e,u.RESOLVE_BY_ID)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByID href.",e)}}))},t.getResolveByPathHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByPathHref)return h.default.resolve(this.resolveByPathHref);if(a.isAnyFunction(this.resolveByPathHref))return h.default.resolve(this.resolveByPathHref())}return pe(e).then((e=>{try{return a.getLinkHref(e,u.RESOLVE_BY_PATH)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByPath href.",e)}}))},t.getResolveLinkForAsset=mt,t.getService=N,t.getVersionResource=Nr,t.headAppMetadata=Tt,t.headCompositeManifest=jr,t.headHTTPResource=ie,t.headPrimaryResource=ft,t.hydrateAsset=fs,t.isAdobeCopyResourcesDocument=e=>"copy_resources"===e.op,t.isAdobeDCXBranchLike=function(e){return a.isObject(e)&&(["compositeId","compositeAssetId","compositeRepositoryId"].some((t=>t in e))||a.isObject(e._core))},t.isAdobeDCXCompositeLike=v,t.isAdobeResponseLike=y,t.isBlob=b,t.isBufferLike=I,t.isComponentResourceDesignator=function(e){return a.isObject(e)&&"component_id"in e},t.isHttpService=R,t.isMinimalAdobeAsset=T,t.isRepoMetaPatch=lr,t.isRepoResponseLike=D,t.isRepoResponseResultLike=C,t.isResolvableAsset=P,t.isServiceConfig=w,t.isTransferDocument=O,t.maybeGetBlockTransfer=Qt,t.moveAsset=Ce,t.newBlockDownload=ze,t.newOperationDocBuilder=Se,t.normalizeCopyResourcesDesignator=e=>{if((e=>e.hasOwnProperty("source")&&e.hasOwnProperty("target"))(e))return{source:De(e.source),target:De(e.target)};const t=De(e);return{source:t,target:t}},t.packageAssets=be,t.parseHttpResponseContent=nt,t.parseLinkString=me,t.parseLinksFromResponseHeader=fe,t.parseMultipartResponseParts=rt,t.patchACLPolicy=kt,t.patchAppMetadata=Rt,t.patchEmbeddedMetadata=pr,t.patchVersions=kr,t.pauseBlockTransfer=function(e,t){return q(this,void 0,void 0,(function*(){const r=yield Qt(e);if(r)return t&&r.on("stateChanged",t),yield r.pause(),r}))},t.performBulkRequest=at,t.putAppMetadata=Pt,t.putCompositeComponent=ts,t.putEmbeddedMetadata=ur,t.removeKeysFromHeader=S,t.resolveAsset=gt,t.restoreAsset=Te,t.setBlockDownloadThreshold=e=>{if(Number.isNaN(e)||"number"!=typeof e||e<=0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Invalid block download threshold, must be positive integer");Wt=e},t.shouldUseBlockTransferForDownload=(e,t=52428800)=>((e,t)=>e>=t)(e,t),t.shouldUseBlockTransferForUpload=zt,t.streamToGetSliceCallback=function(e,t,r,s=4){var n;const i=null!==(n=qt(r))&&void 0!==n?n:Ht,d=i*s,c=new ArrayBuffer(d),l=new Uint8Array(c);let h=0;const u=a.isWHATWGReadableStream(e)?e.pipeThrough(function(e,t){let r;const s=new ByteLengthQueuingStrategy({highWaterMark:e*t});return{writable:new WritableStream({write(t){if(Vt("Chunk Received:",t.byteLength),t.byteLength<e)r.enqueue(t);else{const s=Math.ceil(t.byteLength/e),o=[...Array(s).keys()].map((r=>t.subarray(r*e,Math.min((r+1)*e,t.byteLength))));for(const e of o)Vt("enqueue smaller chunk:",e.byteLength),r.enqueue(e)}},close(){r.close()}},s),readable:new ReadableStream({start(e){r=e}},s)}}(i,s)).getReader():e;let p=!1,_=Promise.resolve();return function(e,t){return q(this,void 0,void 0,(function*(){if(p)return new Uint8Array([]);try{let r;const s=new Promise(((o,n)=>q(this,void 0,void 0,(function*(){function i(r){const s=h%d;if(r.byteLength+s>d){const e=d-s;l.set(r.subarray(0,e),s),l.set(r.subarray(e),0)}else l.set(r,s);if(h+=r.byteLength,Vt(`chunk ${e}-${t} progress: ${h-e}/${t-e}`),h>=t){const r=l.subarray(e%d,t%d||t);Vt(`resolving slice - start:  ${e}, end: ${t}, length: ${r.byteLength}`),o(r)}}if(a.isNodeReadableStream(u)){function c(){return q(this,void 0,void 0,(function*(){const e=u.read(t-h);null!==e&&i(e)}))}const f=()=>{p=!0,o(l.subarray(e%d,h%d||d))},m=()=>{u.off("readable",c),u.off("end",f),u.off("error",n)},g=()=>{u.on("readable",c),u.on("end",f),u.on("error",n)};r=()=>q(this,void 0,void 0,(function*(){g(),yield c(),s.finally(m)}))}else{function E(){return q(this,void 0,void 0,(function*(){const{value:r,done:s}=yield u.read();return s?(p=!0,Vt("End of stream",e,h),o(l.subarray(e%d,h%d||d))):(i(r),h<=t?yield E():void 0)}))}r=()=>(Vt("starting read for slice",e,t),E())}_=_.then((()=>q(this,void 0,void 0,(function*(){r(),yield s}))))}))));return s}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,e.message,e)}}))}},t.transformAssetPropsToJsonPatch=he,t.updateCompositeManifest=es,t.updatePrimaryResource=yr,t.updateRepoMetadata=Ct,t.useLinkOrResolveResource=Lt,t.versionTransformer=Pr},717256:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(617750);var o,n,i=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(r(123e3));o=function(e){"undefined"!=typeof self?e.exports=self:"undefined"!=typeof window?e.exports=window:e.exports=Function("return this")()},o(n={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports;const a="dcxjs";let d=!1;const c=globalThis;var l,h;d||(d=!0,c[a]={_modules:{}},Object.assign(c[a],{getModule:e=>{var t;return null===(t=c[a])||void 0===t?void 0:t.modules[e]},registerModule:(e,t)=>{const r=c[a];if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");if(e in r.modules)throw new Error(`[@dcx/core] Module ${e} already registered.`);r.modules[e]={module:t}}}),Object.defineProperty(c[a],"modules",{get:()=>c[a]._modules}),null===(l=c[a])||void 0===l||l.registerModule("AdobeDCXLogger",s.AdobeDCXLogger),Object.defineProperty(c[a],"logger",{get:()=>{var e;return null===(e=c[a])||void 0===e?void 0:e.getModule("AdobeDCXLogger").module},enumerable:!0}),null===(h=c[a])||void 0===h||h.registerModule("AdobeDCXPromise",i.default));const u=globalThis[a];t.dcxjs=u,t.default=u,t.getModule=e=>{var t;const r=c[a];if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");return null===(t=r.getModule(e))||void 0===t?void 0:t.module}},551096:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),r(717256);var s=r(298453),o=r(617750);r(323);var n=r(436246),i=r(257e3),a=r(413209),d=r(123e3),c=r(251890),l=r(234230),h=r(777522);function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=u(o),_=function(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}(n),f=u(a),m=u(d);class g{constructor(){this._communityId=null,this._artworkComponentId=null,this._assetId=null,this._resourcePath=null,this._mainResource=null,this._mainResourceVersion=null,this._artworkResource=null,this._artworkResourceVersion=null,this._title=null,this._alias=null,this._tags=[],this._description=null,this._categoryId=null,this._subCategoryIds=[],this._creatorIds=[],this._undiscoverable=!1,this._isPrivate=!1,this._custom=null}get communityId(){return this._communityId}set communityId(e){this._communityId=e}get artworkComponentId(){return this._artworkComponentId}set artworkComponentId(e){this._artworkComponentId=e}get assetId(){return this._assetId}set assetId(e){this._assetId=e}get resourcePath(){return this._resourcePath}set resourcePath(e){this._resourcePath=e}get mainResource(){return this._mainResource}set mainResource(e){this._mainResource=e}get mainResourceVersion(){return this._mainResourceVersion}set mainResourceVersion(e){this._mainResourceVersion=e}get artworkResource(){return this._artworkResource}set artworkResource(e){this._artworkResource=e}get artworkResourceVersion(){return this._artworkResourceVersion}set artworkResourceVersion(e){this._artworkResourceVersion=e}get title(){return this._title}set title(e){this._title=e}get alias(){return this._alias}set alias(e){this._alias=e}get tags(){return this._tags}set tags(e){this._tags=this._tags.concat(e)}get description(){return this._description}set description(e){this._description=e}get categoryId(){return this._categoryId}set categoryId(e){this._categoryId=e}get subCategoryIds(){return this._subCategoryIds}set subCategoryIds(e){this._subCategoryIds=this._subCategoryIds.concat(e)}get creatorIds(){return this._creatorIds}set creatorIds(e){this._creatorIds=this._creatorIds.concat(e)}get undiscoverable(){return this._undiscoverable}set undiscoverable(e){this._undiscoverable=e}get isPrivate(){return this._isPrivate}set isPrivate(e){this._isPrivate=e}get custom(){return this._custom}set custom(e){this._custom=e}}const E=o.newDebug("dcx:dcxjs:sb"),A=()=>!0,y={disableRetry:!0},D=!1,C="primary",I="http://ns.adobe.com/ccapi/manifest",v="http://ns.adobe.com/ccapi/manifest2",T="http://ns.adobe.com/ccapi/component",b="version-history",P="rendition";let R=null,w=null;class O{constructor(e,t){this._maxRedirects=5,this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._assetInfoCache={},this._assetIdResolutionTemplate=null,this.SYNC_ASYNC_DEFAULT_DELAY=5,this.ASYNC_DEFAULT_DELAY=1,this.DEFAULT_POLL_DELAY=10,this._service=e,this._server=t,t&&(this._endPoint=n.endPointOf(t))}get maxRedirects(){return this._maxRedirects}set maxRedirects(e){if("number"!=typeof e)throw new f.default(f.default.INVALID_PARAMS,"Expecting a number.");this._maxRedirects=Math.floor(e)}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new f.default(f.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}isValidHref(e){const t=n.endPointOf(e);return!t||t===this._endPoint}isDomainOnAllowList(e){E("isDomainOnAllowList");const t=n.parseURI(e).authority;if(!t||0===t.length)return!0;const r=t.length,s=this._authenticationAllowList.length;for(let e=0;e<s;e++){const s=this._authenticationAllowList[e],o=s.length;let n;if(n=r>o?t.slice(-o):t,n===s)return E("iDOAL true"),!0}return E("iDOAL false"),!1}getAsset(e,t,r,s){return this._getAsset(e,t,r,void 0,s)}_getAsset(e,t={},r,s,o){if(E("_getAsset()"),!(e=this._resolveUrl(e)))return void o(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+e));let d=s;const c={};"string"==typeof t?c["if-none-match"]=t:n.merge(c,t);let l,h=0;const u=(e,t)=>{if(E("_getAsset() respHandler",e,t),e)return void o(a.networkError("Error downloading an asset",e,t));const r=t.statusCode;if(200===r)o(void 0,t);else if(304===r)o(void 0,t);else if(301===r||302===r||303===r||307===r)if(!this._service.handlesRedirects&&this.maxRedirects)if(h<this.maxRedirects){const r=t.headers.location;r?l(r):o(a.unexpectedResponse("Missing location header in redirect response",e,t))}else o(a.unexpectedResponse("Too many redirects",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t))};return l=t=>{const s={responseType:r,isStatusValid:A,retryOptions:y,autoParseJson:D};return t&&(h++,s.reuseRequestDesc=d,this.isDomainOnAllowList(t)||(c.authorization=null)),this._service.invoke(i.HTTPMethods.GET,t||e,c,void 0,s,u)},d=l(),d.progress=n.noOp,d}getAssetAsType(e,t,r,s){return this._getAssetAsType(e,t,r,void 0,void 0,void 0,s)}_cacheLinksFromResponse(e,t){if("string"==typeof e){const r=this._parseCachableLinks(t);if(Object.keys(r).length>0){const t=this._assetInfoCache[e],s=Object.assign({},t||{},n.pruneUndefined(r));this._cacheInfoForAssetId(e,void 0,s)}}}_getAssetAsType(e,t,r,s,o,n,i){return E("_getAssetAsType"),this._getAsset(e,r,t,s,((e,t)=>{if(e)return i(e);if(200===t.statusCode){const e=t.response||t.responseText;null==n&&this._cacheLinksFromResponse(o,t),i(void 0,e,t.headers.etag,t)}else 304===t.statusCode?i(void 0,null,t.headers.etag,t):i(a.unexpectedResponse("Unexpected response getting asset",e,t))}))}_getResourcePathFromHref(e,t){return E("_getResourcePathFromHref"),this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{isStatusValid:A,retryOptions:y,autoParseJson:D},((e,r)=>{if(E("_gRPFH invoked",e,r),e)return t(e);if(200===r.statusCode){const e=r.headers.link;if(e){const r=n.parse(e).get("rel","http://ns.adobe.com/ccapi/path");if(r&&r[0]&&r[0].uri)return t(void 0,r[0].uri)}}return t(a.unexpectedResponse("Unexpected response trying to retrieve path to asset.",void 0,r))}))}resolveRootURLAsync(){E("resolveRootURLAsync()");const e=this._resolveUrl("/");let t;return E("rRUA() rootHref",e),R=this._service.invoke(i.HTTPMethods.GET,e,{},void 0,{responseType:"text",isStatusValid:A,retryOptions:y,autoParseJson:D}).then((e=>{if(E("rRUA() resolved",e),200!==e.statusCode)throw t=new f.default(f.default.UNEXPECTED_RESPONSE,"Resolve root URL did not succeed with 200",void 0,e),t;{const r=e.responseText||e.response;try{const e=JSON.parse(r),t=e._links?e._links["http://ns.adobe.com/ccapi/resolve/id"]:void 0;if(t)return{href:t.href,self:this}}catch(r){throw t=new f.default(f.default.INVALID_DATA,"Invalid JSON returned by server",r,e),t}}})).catch((e=>{throw E("rRUA() rejected",e),e})),E("rRUA() rootReqDesc",R),R}getPromiseCacheInfo(e){return E("getPromiseCacheInfo()"),null!=w||(w=e(),w&&w.then&&w.then((()=>{E("gPCI() resolved"),w=null}),(()=>{E("gPCI() rejected"),w=null}))),w}_parseCachableLinks(e){const t={};e.headers["content-location"];const r=e.headers.link;if(r){const e=n.parse(r);let s=e.get("rel",C);s&&(t.primaryTemplate=s[0].uri),s=e.get("rel",v),s?t.manifestTemplate=s[0].uri:(s=e.get("rel",I),s&&(t.manifestTemplate=s[0].uri)),s=e.get("rel",T),s&&(t.componentTemplate=s[0].uri),s=e.get("rel",b),s&&(t.versionHistory=s[0].uri),s=e.get("rel",P),s&&(t.renditionTemplates=s)}return t}getCachedAssetInfo(e,t){E("getCachedAssetInfo()");const r=this._infoForAssetId(e);if(r)return E("gCAI() cached"),t(void 0,r);const s=this._awaitInfoForAssetId(e,t);if(E("gCAI() needs head req",s),s){let r;const s=s=>{let o=n.expandURITemplate(s,{asset_id:e});if(o=this._resolveUrl(o),!o)return E("gCAI() no href"),t(new f.default(f.default.WRONG_ENDPOINT,"Wrong endpoint: "+o));let d={};return r&&(d={reuseRequestDesc:r},E("gCAI() reuse RD",d)),r=this._service.invoke(i.HTTPMethods.HEAD,o,{},void 0,Object.assign(Object.assign({},d),{isStatusValid:A,retryOptions:y,autoParseJson:D}),((t,r)=>{if(E("gCAI() resolveAssetId() resolved",t,r),t)return this._cacheInfoForAssetId(e,t);const s=r.statusCode;if(200===s){const t=this._parseCachableLinks(r);return this._cacheInfoForAssetId(e,void 0,t)}return 404===s?this._cacheInfoForAssetId(e,new f.default(f.default.ASSET_NOT_FOUND,"Asset not found",t,r)):this._cacheInfoForAssetId(e,a.unexpectedResponse("Unable to resolve asset id.",t,r))})),r};return this._assetIdResolutionTemplate?(E("gCAI() has resolution template"),s(this._assetIdResolutionTemplate)):(E("gCAI() get resolution template"),R=this.getPromiseCacheInfo(this.resolveRootURLAsync.bind(this)).then((e=>(E("gCAI() getPromiseCacheInfo() resolved",e),this._assetIdResolutionTemplate=e.href,s(e.self._assetIdResolutionTemplate)))).catch((e=>{E("gCAI() getPromiseCacheInfo() rejected",e);const r=new f.default(f.default.UNEXPECTED_RESPONSE,"Unable to retrieve asset id resolution link from root resource.",e,e.response);return t(r)})),E("gCAI() rootReqDesc",R),R)}}registerLinks(e){e=e._links||e;const t={};t.assetId="urn:aaid:faux:"+n.generateUuid();let r=e[C];return r&&(t.primaryTemplate=r.href),r=e[I],r&&(t.manifestTemplate=r.href),r=e[v],r&&(t.manifestTemplate=r.href),r=e[T],r&&(t.componentTemplate=r.href),r=e[b],r&&(t.versionHistory=r.href),r=e[P],r&&(t.renditionTemplates=[{rel:"rendition",uri:r.href}]),this._assetInfoCache[t.assetId]=t,t.assetId}_infoForAssetId(e){const t=this._assetInfoCache[e];if(t&&!t.callbacks)return t}_awaitInfoForAssetId(e,t){E("_awaitInfoForAssetId");let r=this._assetInfoCache[e];return r?(E("_aIFA pending"),r.callbacks.push(t),!1):(E("_aIFA not pending"),r={},r.assetId=e,r.callbacks=[t],this._assetInfoCache[e]=r,!0)}_cacheInfoForAssetId(e,t,r){E("_cacheInfoForAssetId");let s=this._assetInfoCache[e];if(s){if(t){const r=s.callbacks;this._assetInfoCache[e]=void 0;for(let e=0;e<r.length;e++)r[e](t)}}else!t&&r&&(this._assetInfoCache[e]=s={});if(!t&&r&&(s.assetId||(s.assetId=e),s.primaryTemplate=r.primaryTemplate,s.manifestTemplate=r.manifestTemplate,s.componentTemplate=r.componentTemplate,s.versionHistory=r.versionHistory,s.renditionTemplates=r.renditionTemplates,s.callbacks)){for(let e=0;e<s.callbacks.length;e++)s.callbacks[e](void 0,s);s.callbacks=void 0}}_resolveUrl(e){return n.endPointOf(e)?e:n.appendPathElements(this._server,e)}_makeRelativeUrl(e){if(n.endPointOf(e)){const t=n.parseURI(e);(t.scheme||t.authority)&&(e=t.path,t.query&&(e+="?"+t.query),t.fragment&&(e+="#"+t.fragment))}return e}_parseAsyncResponse(e){E("_parseAsyncResponse");const t=e.responseText||e.response;if(!t)throw new f.default(f.default.INVALID_DATA,"No body data.");const r={},s=t.indexOf("\n");if(-1===s)throw new f.default(f.default.INVALID_DATA,"Could not find status line.");const o=t.slice(0,13===t.charCodeAt(s-1)?s-1:s).split(" ");if(r.statusCode=parseInt(o[1],10),!r.statusCode)throw new f.default(f.default.INVALID_DATA,"Could not find status code.");o.length>2&&(r.statusText=o[2]);let i=t.search(/\r?\n\r?\n/);-1===i&&(i=t.length);const a=t.slice(s+1,i);r.headers=n.parseHeaders(a);const d="\r"===t.charAt(i)?i+4:i+2;return r.response=t.slice(d),r}_pollForAsyncResponse(e,t,r,s){E("_pollForAsyncResponse");const n=Date.now()+1e3*t,d={responseType:"text",reuseRequestDesc:r,noSoonerThen:n,isStatusValid:A,retryOptions:y,autoParseJson:D};o.log("asynchronous request - polling");const c=this._service.invoke(i.HTTPMethods.GET,e,void 0,void 0,d,((t,n)=>{if(t)return s(a.networkError("Error polling for an asynchronous reponse",t,n));let i=n.statusCode;if(202===i){let t;o.log("asynchronous request - not yet ready"),n.headers["retry-after"]&&(t=parseInt(n.headers["retry-after"],10)),this._pollForAsyncResponse(e,t||10,r,s)}else if(200===i){o.log("asynchronous request - success");try{n=this._parseAsyncResponse(n)}catch(e){return s(a.unexpectedResponse("Error parsing response body.",e,n))}i=n.statusCode,200===i||201===i||204===i?s(void 0,n):s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}else o.log("asynchronous request - error"),s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}));r=c}_handle202Response(e,t,r,s){E("_handle202Response");const o=e.responseText||e.response;let n;try{n=JSON.parse(o)}catch(t){return s(a.unexpectedResponse("Error parsing 202 response body.",t,e))}const i=n.href;if(!i)return s(a.unexpectedResponse("202 response missing an href.",void 0,e));let d=e.headers["retry-after"];d=d?parseInt(d,10):r,this._pollForAsyncResponse(this._resolveUrl(i),d,t,s)}}const S=()=>!0,k={disableRetry:!0},N=!1,L="/content/2/",M=/^\/?content\/2\/[^\/]+\/[^\/]+/,X=/^\/?api\/v2\/[^\/]+\/assets\/[^\/]+/,x={"image/jpeg":"jpg","image/png":"png"};class B extends O{constructor(e,t){if(super(e,t),this.name="AdobeCommunitySession",!this._endPoint)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Could not determine endpoint from: "+t)}publishCompositeAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets";s=this._resolveUrl(s);const o={resource_path:this.assetIdFromSSResourceHref(t.resourcePath),resource_type:e,metadata:this.metadataFromPubRecord(t)},n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.POST,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:N,isStatusValid:S,retryOptions:k},(function(e,s){if(e)return r(a.networkError("Error publishing composite",e,s));if(201===s.statusCode){const o=s.headers.location;if(!o)return e=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Missing location header returned on response by server",void 0,s),r(a.unexpectedResponse("Unexpected response publishing composite",e,s));const n=function(e){const t=e.match("^.*?\\/api\\/v2\\/([^/]*)/assets\\/([^\\/]*).*$");return t?t[2]:null}(o);if(n)return t.assetId=n,r(void 0,o)}return r(a.unexpectedResponse("Unexpected response publishing composite",e,s))}))}updateCpMetadataAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets/"+t.assetId;s=this._resolveUrl(s);const o=this.metadataFromPubRecord(t),n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.PUT,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:N,isStatusValid:S,retryOptions:k},((e,t)=>e?r(a.networkError("Error publishing composite",e,t)):200===t.statusCode?r(void 0,s):r(a.unexpectedResponse("Unexpected response publishing composite",e,t))))}getCpMetadata(e,t){let r="/api/v2/"+e.communityId+"/assets/"+e.assetId;r=this._resolveUrl(r),this._service.invoke(i.HTTPMethods.GET,r,{},void 0,{responseType:"text",autoParseJson:N,isStatusValid:S,retryOptions:k},(function(r,s){if(r)return t(a.networkError("Error getting metadata for CP composite",r,s));if(200===s.statusCode){let r;const o=s.response||s;try{r=JSON.parse(o),e.resourcePath=r.resource_path,e.description=r.description||null,e.title=r.title||null,e.alias=r.alias||null,e.undiscoverable=r.undiscoverable||!1,e.isPrivate=r.private||!1;let t=r.tags;t&&null!==t&&t.length>0&&(e.tags=t);let s=r._embedded;if(s&&null!==s&&(t=r.creators,t&&null!==t&&t.length>0)){const r=[];for(let e=0;e<t.length;++e){const s=t[e];if(s&&null!==s){const e=s.id;e&&null!==e&&r.push(e)}}0!==r.length&&(e.creatorIds=r)}if(s=r.category_id,s&&null!==s&&(e.categoryId=s.id||null),t=r.sub_categories,t&&null!==t&&t.length>0){e.subCategoryIds=[];for(let r=0;r<t.length;++r)s=t[r],e.subCategoryIds.push(s.id)}s=r.custom,s&&null!==s&&(e.custom=s)}catch(e){const r=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Invalid JSON returned by server",e,s);return t(r)}return t(void 0,e)}return t(a.unexpectedResponse("Unexpected response while getting metadata for CP composite",r,s))}))}updatePublicationRecordData(e,t){const r=t.versionId;if(e.mainResource="manifest",r&&(e.mainResourceVersion=r),null!==e.artworkComponentId){const r=t.getComponentWithId(e.artworkComponentId);if(null==r)throw new a.AdobeDCXError(a.AdobeDCXError.COMPONENT_DOWNLOAD_ERROR,"Bad component ID = "+e.artworkComponentId);let s=e.resourcePath;s=this.assetIdFromSSResourceHref(s),s+=r.absolutePath,e.artworkResource=s,e.artworkResourceVersion=r.version}}getCompositeManifestHref(e,t,r){if(t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"AdobeCommunitySession does not support version manifests.");if(!e.assetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Composite must be bound.");if(!this.isProperAssetId(e.assetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");const s=this._resolveUrl(e.assetId);if(!s)throw new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId);return r(void 0,n.appendPathElements(s,"manifest"))}getComponent(e,t,r){const s={};let o=s;return this.getComponentHref(e,e.version,((e,n)=>e?r(e):(o=o||s,this._getAsset(n,void 0,t,o,r)))),o||s}getRenditionOfComponent(e,t,r,s,o,n){const i={};let a=i;return this.getComponentRenditionHref(e,e.version,t,r,s,((e,r)=>e?n(e):(a=a||i,this._getAsset(r,{accept:t},o,a,n)))),a||i}getCompositeManifest(e,t,r,s){let o=e.assetId;return o&&(o=this._resolveUrl(o)),o?(o=n.appendPathElements(o,"manifest"),this.getAssetAsType(o,"text",r,s)):s(new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId))}headRequest(e,t){return this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{responseType:"text",autoParseJson:N,isStatusValid:S,retryOptions:k},(function(e,r){if(e)return t(e);t(e,r)}))}getComponentHref(e,t,r){const s=e._owner;if(!s||!s.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(s.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(s._core){const t=s._core._getSourceAssetInfoOfComponent(e);if(t)return void r(void 0,this._constructComponentHref(t.compositeAssetId,t.componentPath,t.componentVersion))}r(void 0,this._constructComponentHref(s.compositeAssetId,e.absolutePath,t))}getComponentRenditionHref(e,t,r,s,o,n){const i=e._owner;if(!i||!i.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(i.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(i._core&&i._core._getSourceAssetInfoOfComponent(e))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Getting a rendition of a source href not implemented.");return n(void 0,this._constructComponentRenditionHref(i.compositeAssetId,e.absolutePath,t,r,s,o))}isProperAssetId(e){return n.ensureRelativeHrefStartsWithSlash(e)}_constructComponentHref(e,t,r){const s=t.slice(1);let o=n.appendPathElements(this._resolveUrl(e),s);return o&&void 0!==r&&(this._hrefUsesContentApis(e)?o+="/version/"+r:o+="?version="+r),o}_constructComponentRenditionHref(e,t,r,s,o,i){let d,c;const l=t.slice(1),h=n.parseURI(e).path;if(h.slice(0,11)===L){const t=x[s];if(!t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Unsupported rendition media type: "+s);if(d=M.exec(h),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",l,"version",r,"format",t,"dimension",o,"size",String(i)))}else{if(d=X.exec(h),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",o,String(i),l)+"?version="+r)}return c}_hrefUsesContentApis(e){return n.parseURI(e).path.slice(0,11)===L}assetIdFromSSResourceHref(e){const t=e.match("^\\/pubs\\/([^\\/]*).*$");return t?t[1]:null}metadataFromPubRecord(e){const t={};if(null!==e.title&&(t.title=e.title),null!==e.description&&(t.description=e.description),null!==e.alias&&(t.alias=e.alias),t.undiscoverable=e.undiscoverable,e.isPrivate&&(t.private=e.isPrivate),Array.isArray(e.tags)&&(t.tags=[...e.tags]),Array.isArray(e.creatorIds)&&(t.creator_ids=[...e.creatorIds]),null!==e.categoryId&&(t.category_id=e.categoryId),Array.isArray(e.subCategoryIds)&&(t.sub_category_ids=[...e.subCategoryIds]),null!==e.custom&&(t.custom=e.custom),null!==e.mainResource&&null!==e.mainResourceVersion){const r={};r.resource_path=e.mainResource,r.resource_version=e.mainResourceVersion,t.main_resource=r}if(null!==e.artworkResource&&null!==e.artworkResourceVersion){const r={};r.resource_path=e.artworkResource,r.resource_version=e.artworkResourceVersion,t.artwork=r}return t}}function j(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}const U={unmodified:"unmodified",modified:"modified",pendingDelete:"pendingDelete",committedDelete:"committedDelete"},V={pending:"pending",active:"active",archived:"archived"},H={name:!0,id:!0,state:!0,path:!0,rel:!0,type:!0,etag:!0,length:!0,version:!0,md5:!0,width:!0,height:!0};class F{constructor(e,t=!1){this._readOnly=!1,this._data={},this.records={},e&&this._setData(e),this._readOnly=t}get compositeId(){return this._compositeId}get owner(){return this._owner}get data(){return this._data}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a component that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.type=e,this._setDirty()}get path(){return this._data.path}set path(e){if(this._data.path!==e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path.");this._owner?this._owner._core._setPathOfComponent(this,e):(this._data.path=e,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){return this._data.path&&this._owner?n.appendPathElements(this._parentPath,this._data.path):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get state(){return this._data.state}set state(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.keys(U).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');this._data.state=e,this._setDirty()}get etag(){return this._data.etag}set etag(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.etag=e,this._setDirty()}get md5(){return this._data.md5}set md5(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.md5=e,this._setDirty()}get version(){return this._data.version}set version(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(void 0!==e&&"string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.version=e,this._setDirty()}get length(){return this._data.length}set length(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.length=e,this._setDirty()}get width(){return this._data.width}set width(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.width=e,this._setDirty()}get height(){return this._data.height}set height(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.height=e,this._setDirty()}get assetId(){return this._assetId}set assetId(e){if(e!==this._assetId){if(this._assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"assetId property cannot be changed.");this._assetId=e}}get repositoryId(){return this._repoId}set repositoryId(e){if(e!==this._repoId){if(this._repoId)throw new a.DCXError(a.DCXError.INVALID_STATE,"repoId property cannot be changed.");this._repoId=e}}getComponentDescriptor(){if(!i.isAdobeDCXBranchLike(this._owner))throw new a.DCXError(a.DCXError.INVALID_STATE,"Component must be part of a composite to get a descriptor.");return JSON.stringify({versionId:l.CURRENT_COMPONENT_DESCRIPTOR_VERSION,componentId:this.id,compositeId:this._owner.compositeId,cloudAssetId:this._owner.compositeAssetId,repositoryId:this.repositoryId||this._owner.compositeRepositoryId,componentRevisionId:this.version,type:this.type,size:this.length,etag:this.etag,hashType:l.CURRENT_COMPONENT_DESCRIPTOR_HASH_TYPE,hashValue:this.md5})}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];H[r]||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');delete this._data[e],this._setDirty()}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}isEqualTo(e,t){return n.objectsEqual(this._data,e._data,t)}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_setDirty(){this._owner&&this._owner._setDirty()}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Component is missing an id of type string"):null}}F.STATES=U;class Y{constructor(e,t=!1,r=!1){this._data={},e&&this._setData(e),this._readOnly=t,this._isRoot=r}get owner(){return this._owner}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a node that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.type=e,this._setDirty()}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get path(){return this._isRoot?Y.ROOT_PATH:this._data.path}set path(e){if(e!==this.path){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._isRoot)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the path of the root node.");if(e&&!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path or undefined.");this._owner?this._owner._setPathOfNode(this,e||void 0):(this._data.path=e||void 0,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){const e=this.path;return this._isRoot?e:e&&this._owner?n.appendPathElements(this._parentPath,e):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get isRoot(){return this._isRoot}set isRoot(e){throw new a.DCXError(a.DCXError.READ_ONLY,"isRoot is read-only.")}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];(this._isRoot?W[r]:z[r])||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");delete this._data[e],this._setDirty()}copy(){let e;const t=this._data.children,r=this._data.components;try{t&&delete this._data.children,r&&delete this._data.components;const s=JSON.parse(JSON.stringify(this._data));e=new Y(s)}finally{t&&(this._data.children=t),r&&(this._data.components=r)}return e}isEqualTo(e,t,r){return this._isEqual(this._data,e._data,n.merge({children:!0,components:!0},t),r)}_isEqual(e,t,r,s){let o,i,a,d,c;if(!n.objectsEqual(e,t,r))return!1;if(i=e.components,a=t.components,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d){let e,t,r;for(o=0;o<d;o++){for(e=i[o],t=null,r=0;r<d;r++)if(e.id===a[r].id){t=a[r];break}if(!t)return!1;if(!n.objectsEqual(e,t,s))return!1}}if(i=e.children,a=t.children,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d)for(o=0;o<d;o++)if(!this._isEqual(i[o],a[o],r,s))return!1;return!0}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Node is missing an id of type string"):null}_setDirty(){this._owner&&this._owner._setDirty()}}Y.ROOT_PATH="/";const W={components:!0,children:!0,"manifest-format-version":!0,id:!0,name:!0,type:!0,state:!0,local:!0},z={components:!0,children:!0,rel:!0,path:!0,id:!0,name:!0,type:!0};class G{constructor(e,t,r=!1){this._allNodes={},this._allComponents={},this._absolutePaths={},this._readOnly=!1,this._isDirty=!1,this._sourceAssetInfoLookup={},this._readOnly=r,this._owner=t,this._setData(e)}get allNodes(){return this._allNodes}get rootNode(){return this.getChildWithAbsolutePath(Y.ROOT_PATH)}set rootNode(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "rootNode" is read-only.')}get isDirty(){return this._isDirty}set isDirty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isDirty.")}get changeCount(){return this._data.local&&this._data.local.change||0}set changeCount(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property changeCount.")}getChildWithId(e){return this._allNodes[e]}getChildWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof Y?t:void 0}getChildrenOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.children;if(Array.isArray(s))for(let e=0;e<s.length;e++){const t=s[e],o=this._allNodes[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Node not in cache");r.push(o)}return r}addChild(e,t,r,s){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(t=t||n.generateUuid(),this._allNodes[t])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Node already exists in branch.");if(r&&("number"!=typeof r||r%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const o=s?this._allNodes[s.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const i=new Y;i.id=t,e&&(i.name=e),i._parentPath=o.absolutePath||o._parentPath;const d=o._data.children;return d?(r>=0&&r<=d.length||(r=d.length),r===d.length?d[r]=i._data:d.splice(r,0,i._data)):o._data.children=[i._data],this._allNodes[i.id]=i,i._owner=this._owner,this._setDirty(),i}removeChild(e){let t=e;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(t.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot remove the root node.");const r=t.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const s=this._nodeDataOfParentOfNode(t);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const o=s.parentNodeData.children;return o&&(o.splice(s.index,1),0===o.length&&delete s.parentNodeData.children),t=this._allNodes[r],this._removeNodeFromCachesRecursively(t._data),this._setDirty(),t}moveChild(e,t,r){let s=e;const o=r;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(s.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot move the root node.");if(t&&("number"!=typeof t||t%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const n=s.id;if(!n)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const i=this._nodeDataOfParentOfNode(s);if(s=this._allNodes[n],!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const d=o?this._allNodes[o.id]:this.rootNode;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(this._nodeIdIsDescendantOf(d.id,s._data))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Must not create a cycle.");const c=i.parentNodeData.children.splice(i.index,1)[0];try{const e=d._data.children;e?(t>=0&&t<=e.length||(t=e.length),t===e.length?e[t]=c:e.splice(t,0,c)):d._data.children=[c]}catch(e){throw i.parentNodeData.children.splice(i.index,0,c),e}return 0===i.parentNodeData.children.length&&delete i.parentNodeData.children,this._setDirty(),this._allNodes[n]}copyChild(e,t,r,s,o,n){return this._copyChild(e,t,r,s,o,!1,n)}replaceChild(e,t,r,s){return this._copyChild(e,void 0,void 0,t,r||e.id,!0,s)}getMissingComponentsFromError(e){var t;return e.code!==a.DCXError.INCOMPLETE_COMPOSITE?[]:(null!==(t=e.response.response.report.failures.filter((e=>"MissingComponent"===e.rule)))&&void 0!==t?t:[]).map((e=>this.getComponentWithId(e.component_id)||this.getComponentWithAbsolutePath(e.component_path))).filter((e=>e))}allComponents(){const e=[];for(const t in this._allComponents)Object.prototype.hasOwnProperty.call(this._allComponents,t)&&e.push(this._allComponents[t]);return e}getComponentWithId(e){return this._allComponents[e]}getComponentWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof F?t:void 0}getComponentsOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.components;if(Array.isArray(s)){let e;for(e=0;e<s.length;e++){const t=s[e],o=this._allComponents[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Component not in cache");r[r.length]=o}}return r}addComponentWithComponentDescriptor(e,t,r,s=i.LinkRelation.COMPONENT,o){return this.addComponentWithUploadResults(t,s,r,o,l.uploadResultsFromComponentDescriptor(e))}addComponentWithUploadResults(e,t,r,s,o){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(o.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear valid to be for this composite.");const n=Object.keys(o.records);if(1!==n.length)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults must contain records of exactly one component upload.");const i=o.records[n[0]],d=i.id;if(this._allComponents[d])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+d);const c=s?this._allNodes[s.id]:this.rootNode;if(!c)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const l=new F;l.id=d,l.name=e,l.type=i.type,l.relationship=t,l.path=r,l.state=U.unmodified,l.etag=i.etag,l.length=i.length,l.version=i.version,l.md5=i.md5;const h=this._normalizedAbsolutePathForItem(l,c);if(this._absolutePaths[h])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+h);l._parentPath=c.absolutePath||c._parentPath;const u=c._data.components;return u?u.push(l.data):c._data.components=[l.data],l._owner=this._owner,this._allComponents[d]=l,this._absolutePaths[h]=l,this._setDirty(),l}updateComponentWithUploadResults(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!(e=this._allComponents[e.id]))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");if(t.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear to be valid for this composite.");const r=t.records[e.id];if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not contain an upload record for the given component.");return e.etag=r.etag,e.version=r.version,e.md5=r.md5,e.length=r.length,this._setSourceAssetInfoOfComponent(void 0,e),e.state=U.unmodified,this._setDirty(),e}removeComponent(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const t=e.id;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const r=this._nodeDataOfParentOfComponent(e);if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");return r.parentNodeData.components.splice(r.index,1),0===r.parentNodeData.components.length&&delete r.parentNodeData.components,e=this._allComponents[t],delete this._allComponents[t],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._owner=void 0,e._parentPath="",this._setDirty(),e}moveComponent(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const r=e.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const s=this._nodeDataOfParentOfComponent(e);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");const o=t?this._allNodes[t.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const n=this._normalizedAbsolutePathForItem(e,o);if(this._absolutePaths[n])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+n);const i=s.parentNodeData.components.splice(s.index,1)[0],d=o._data.components;return d?d.push(i):o._data.components=[i],0===s.parentNodeData.components.length&&delete s.parentNodeData.components,e=this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._parentPath=o.absolutePath||o._parentPath,this._absolutePaths[n]=e,this._setDirty(),e}copyComponent(e,t,r,s,o){return this._copyComponent(e,t,r,s,!1,o)}replaceComponent(e,t,r,s){const o=this._copyComponent(e,void 0,t,r||e.id,!0,s);return r&&r!==e.id&&delete this._allComponents[e.id],o}_getHrefOfComponent(e){let t;const r=this._getBranchOf(e).compositeHref;return r&&void 0!==e.version&&(t=n.appendPathElements(r,e.id),t+=";version="+e.version),t}_setSourceAssetInfoOfComponent(e,t){const r=t.id,s=this._sourceAssetInfoLookup;e?s[r]=e:s[r]&&delete s[r]}_getSourceAssetInfoOfComponent(e){const t=e.id,r=this._sourceAssetInfoLookup;if(r)return r[t]}_copySourceHrefsFrom(e){const t=e._sourceAssetInfoLookup,r=this.allComponents(),s=r.length;if(s&&t){const e=this._sourceAssetInfoLookup;for(let o=0;o<s;o++){const s=r[o].id;e[s]=t[s]}}}_getBranchOf(e){return e._owner?this._getBranchOf(e._owner):e}_isSameComposite(e){const t=this._getBranchOf(this),r=this._getBranchOf(e);return t._data.id===r._data.id&&t.compositeAssetId===r.compositeAssetId&&t.compositeRepositoryId===r.compositeRepositoryId}_stringify(e,t=!1){if(e){const e=this._data.local;let r=null;try{delete this._data.local,r=JSON.stringify(this._data,void 0,t?2:void 0)}finally{e&&(this._data.local=e)}return r}return JSON.stringify(this._data,void 0,t?2:void 0)}_setData(e){const t=new Y(e,this._readOnly,!0);t._owner=this._owner,t._parentPath="";const r=t.id,s={},o={},i={};o[r]=t,i[Y.ROOT_PATH]=t;const d=(e,t)=>{let r,c;const l=e.components;if(Array.isArray(l))for(let e=0;e<l.length;e++){const r=l[e],o=new F(r,this._readOnly);if(s[o.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate component id: "+o.id);if(o._owner=this._owner,o._parentPath=t,c=this._normalizedAbsolutePathForItem(o),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid absolute component path: "+c);s[o.id]=o,i[c]=o}const h=e.children;if(Array.isArray(h))for(let e=0;e<h.length;e++){const s=h[e],l=new Y(s,this._readOnly);if(o[l.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate node id: "+l.id);if(r=l.path,l._owner=this._owner,l._parentPath=t,r){if(c=this._normalizedAbsolutePathForItem(l),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid node absolute path: "+c);i[c]=l}o[l.id]=l,d(s,l.path?n.appendPathElements(t,l.path):t)}};return d(e,Y.ROOT_PATH),this._data=e,this._allComponents=s,this._allNodes=o,this._absolutePaths=i,this._isDirty=!1,this}_removeNodeFromCachesRecursively(e){const t=e.components;if(Array.isArray(t))for(let e=0;e<t.length;e++){const r=t[e].id,s=this._allComponents[r];delete this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(s)],s._owner=void 0}const r=e.children;if(Array.isArray(r))for(let e=0;e<r.length;e++)this._removeNodeFromCachesRecursively(r[e]);const s=e.id,o=this._allNodes[s];delete this._allNodes[s],o.path&&delete this._absolutePaths[this._normalizedAbsolutePathForItem(o)],o._owner=void 0}_local(){return this._data.local||(this._data.local={version:2}),this._data.local}_recursiveReset(e,t){const r=e.components;if(r)for(let e=r.length-1;e>=0;e--){const s=r[e];s.state===U.committedDelete?(delete r[e],delete this._allComponents[s.id],delete s._owner,this._setSourceAssetInfoOfComponent(void 0,s)):(delete s.etag,delete s.version,s.state=U.modified,t&&t(s))}const s=e.children;if(s)for(let e=0;e<s.length;e++)this._recursiveReset(s[e],t)}_nodeIdIsDescendantOf(e,t){const r=t.children;if(r)for(let t=0;t<r.length;t++){const s=r[t];if(s.id===e||this._nodeIdIsDescendantOf(e,s))return!0}return!1}_recursivelyGetAllComponentsOfChild(e,t=[]){const r=e._data||e,s=r.components;if(s){const e=s.length;for(let r=0;r<e;r++)t[t.length]=this._allComponents[s[r].id]}const o=r.children;if(o){const e=o.length;for(let r=0;r<e;r++)t=this._recursivelyGetAllComponentsOfChild(o[r],t)}return t}_nodeDataOfParentOfNode(e,t=this._data){const r=e._data.id,s=t.children;if(s)for(let o=0;o<s.length;o++){const n=s[o];if(n.id===r)return{parentNodeData:t,index:o};const i=this._nodeDataOfParentOfNode(e,n);if(i)return i}return null}_nodeDataOfParentOfComponent(e,t=this._data){const r=e._data.id,s=t.components;if(s)for(let e=0;e<s.length;e++)if(s[e].id===r)return{parentNodeData:t,index:e};const o=t.children;if(o)for(let t=0;t<o.length;t++){const r=o[t],s=this._nodeDataOfParentOfComponent(e,r);if(s)return s}return null}_determineAbsolutePathChangesRecursively(e,t,r){const s=e.components;if(s)for(let e=0;e<s.length;e++){const o=s[e],i=this._allComponents[o.id];r.push({item:i,parentPath:t,absPath:n.appendPathElements(t,o.path)})}const o=e.children;if(o)for(let e=0;e<o.length;e++){const s=o[e],i=this._allNodes[s.id],a=s.path,d=a?n.appendPathElements(t,a):t;r.push({item:i,parentPath:t,absPath:a?d:void 0}),this._determineAbsolutePathChangesRecursively(s,d,r)}}_setPathOfNode(e,t){const r=t?n.appendPathElements(e._parentPath,t):e._parentPath,s=[{item:e,absPath:t?r:void 0}];let o;this._determineAbsolutePathChangesRecursively(e._data,r,s);const i=n.flatCopy(this._absolutePaths);for(let e=0;e<s.length;e++){const t=s[e].item;t._data.path&&delete i[this._normalizedAbsolutePathForItem(t)]}for(let e=0;e<s.length;e++)if(o=s[e],o.absPath){const e=o.absPath.toLowerCase();if(i[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+e);i[e]=o.item}for(let e=0;e<s.length;e++)o=s[e],o.parentPath&&(o.item._parentPath=o.parentPath);e._data.path=t,this._absolutePaths=i}_setPathOfComponent(e,t){if(!this._allComponents[e.id])throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");const r=n.appendPathElements(e._parentPath,t).toLowerCase();if(this._absolutePaths[r])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path for component: "+r);if(!n.isValidAbsolutePath(r))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+r);delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],this._absolutePaths[r]=e,e._data.path=t}_setDirty(e=!1){if(!e){if(this._local().archivalState===V.pending||this._local().archivalState===V.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot modify an archived composite.");this._data.state!==U.pendingDelete&&this._data.state!==U.committedDelete||p.default.warn("Modifying deleted composite")}this._isDirty=!0,this._local().change=this.changeCount+1,e||this._data.state!==U.unmodified&&this._data.state||(this._data.state=U.modified)}_normalizedAbsolutePathForItem(e,t){let r;return r=t?n.appendPathElements(t.absolutePath||t._parentPath,e.path):e.absolutePath,r.toLowerCase()}_hasSameEndpoint(e){return!0}_copyComponent(e,t,r,s,o,i){n.validateParams(["component",e,"object"],["callback",i,"function",!0]);const d=e._owner._core;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy, undefined component owner");const c=this._isSameComposite(d),l=c||this._hasSameEndpoint(e);if(d._local(),!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy between two different endpoints.");const h=function(e,t,r){q(e,t,c,l,!s)};if(!i)return this._copyComponentModel(e,t,o,r,s,h);try{i(void 0,this._copyComponentModel(e,t,o,r,s,h))}catch(e){i(a.DCXError.wrapError(a.DCXError.UNEXPECTED,"Unexpected error attempting to copy component model",e))}}_copyComponentModel(e,t,r,s,o,i){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const d=e._owner,c=new F(JSON.parse(JSON.stringify(e._data)));if(s?(c.path=s,c.id=o||n.generateUuid()):o&&(c.id=o),c._owner=this._owner,e.id===c.id&&this._isSameComposite(d._core)||(c.state=U.modified,c.etag=void 0,c.version=void 0,c.md5=void 0,c.length=void 0),this._allComponents[c.id]&&!r)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Component already exists.");const l=this._allComponents[e.id];if(r&&!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing component.");let h,u;if(r){const e=this._nodeDataOfParentOfComponent(l);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent node of existing component not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");h=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");c._parentPath=u.absolutePath||u._parentPath;const p=this._normalizedAbsolutePathForItem(c),_=this._absolutePaths[p];if(_&&_!==l)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+p);if(!n.isValidAbsolutePath(p))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component path must be a valid path for a component.");let f=this._local();i&&(f=n.deepCopy(f),i(e,c,f));const m=u._data.components;return r?m[h]=c.data:m?m.push(c.data):u._data.components=[c.data],this._data.local=f,this._allComponents[c.id]=c,this._absolutePaths[p]=c,this._setDirty(),c}_copyChild(e,t,r,s,o,n,i){if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');const d=e._owner._core,c=this._isSameComposite(d),l=c||this._hasSameEndpoint(e);if(d._local(),d._recursivelyGetAllComponentsOfChild(e).length>0&&!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy components between two different endpoints.");const h=(e,t,r)=>{q(e,t,c,l,!0)};if(!i)return this._copyChildModel(e,t,r,n,s,o,h);try{i(void 0,this._copyChildModel(e,t,r,n,s,o,h))}catch(e){i(e)}}_copyChildModel(e,t,r,s,o,i,d){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");const c=e._owner,l=new Y(JSON.parse(JSON.stringify(e._data)));o?(l.path=o,l.id=i||n.generateUuid()):i&&(l.id=i),l._owner=this._owner,e.isRoot&&(delete l._data.local,delete l._data.state,delete l._data["manifest-format-version"]);const h=this._allNodes[l.id];if(h&&!s)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Child node already exists.");if(s&&!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing node to replace.");let u;if(s){const e=this._nodeDataOfParentOfNode(h);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent of existing node not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");r=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(l._parentPath=u.absolutePath||u._parentPath,l.path){const e=this._normalizedAbsolutePathForItem(l),t=this._absolutePaths[e];if(t&&t!==h)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node path must be a valid path for a node.")}const p=n.flatCopy(this._allNodes),_=n.flatCopy(this._allComponents),f=n.flatCopy(this._absolutePaths),m=n.deepCopy(this._local()),g=function(e,t,r,s,o,n){let i,a;delete r[e.id],e.path&&delete o[t._normalizedAbsolutePathForItem(e)];const d=e._data.children;if(d)for(a=d.length,i=0;i<a;i++)g(r[d[i].id],t,r,s,o);const c=e._data.components;if(c)for(a=c.length,i=0;i<a;i++){const e=s[c[i].id];delete s[e.id],delete o[t._normalizedAbsolutePathForItem(e)]}};h&&g(h,this,p,_,f);const E=(e,t,r,s,o,i,l)=>{if(r[e.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate node id: "+e.id);let h;if(r[e.id]=e,e.path){if(h=t._core._normalizedAbsolutePathForItem(e),o[h])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+h);o[h]=e}const u=e._data.children;if(u){const a=u.length;for(let d=0;d<a;d++){const a=new Y(u[d]);r[a.id]&&(a.id=n.generateUuid()),a._owner=t,a._parentPath=e.absolutePath||e._parentPath,E(a,t,r,s,o,i)}}const p=e._data.components;if(p){const r=p.length;for(let l=0;l<r;l++){const r=new F(p[l]),u=r.id;if(s[u]&&(r.id=n.generateUuid(),r.state=U.modified,r.etag=void 0,r.version=void 0,r.md5=void 0,r.length=void 0),r._owner=t,r._parentPath=e.absolutePath||e._parentPath,d&&d(c.getComponentWithId(u),r,i),s[r.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+r.id);if(s[r.id]=r,h=t._core._normalizedAbsolutePathForItem(r),o[h])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+h);o[h]=r}}};if(E(l,this._owner,p,_,f,m,c._local()),s)u._data.children[r]=l._data;else{const e=u._data.children;e?(r>=0&&r<=e.length||(r=e.length),r===e.length?e[r]=l._data:e.splice(r,0,l._data)):u._data.children=[l._data]}return this._allNodes=p,this._allComponents=_,this._absolutePaths=f,this._data.local=m,this._setDirty(),l}_verifyIntegrity(e,t,r){const s=[];let o=!1;const i=e=>(s.push(new a.DCXError(a.DCXError.INVALID_STATE,e)),t&&(o||(t("Branch for composite "+this.rootNode.id+" has the following errors:"),o=!0),t("   "+e)),!1),d=function(e,t){return!!e||i(t)},c=[],l=function(e){(c.indexOf(e)<0||i("Item "+e.id+" encountered more than once"))&&c.push(e)},h=n.flatCopy(this._allComponents),u=n.flatCopy(this._allNodes),p=n.flatCopy(this._absolutePaths),_=Object.keys(p),f=_.length;for(let e=0;e<f;e++){const t=_[e];d("/"===t.charAt(0),"Absolute path "+t+" does not start with a slash.")}const m=(e,t)=>{let r,s;const o=e.children;if(o)for(r=0;r<o.length;r++){const e=o[r],a=u[e.id];(a||i("Node "+e.id+" is not in cache."))&&(l(a),d(a._data===e,"Node "+a.id+" _data property incorrect."),delete u[a.id],a.path&&a._owner&&(s=this._normalizedAbsolutePathForItem(a),(p[s]||i("Absolute path of node "+a.id+" ("+s+") is not in cache."))&&delete p[s]),d(a._parentPath===t,"Parent path of node "+a.id+" should be "+t+" but is "+a._parentPath),d(a._owner===this._owner,"Node "+a.id+" _owner property is not correct.")),m(e,e.path?n.appendPathElements(t,e.path):t)}const a=e.components;if(a)for(r=0;r<a.length;r++){const e=a[r],o=h[e.id];(o||i("Component "+e.id+" is not in cache."))&&(l(o),d(o._data===e,"Component "+o.id+" _data property incorrect."),delete h[o.id],o._owner&&(s=this._normalizedAbsolutePathForItem(o),(p[s]||i("Absolute path "+s+" is not in cache."))&&delete p[s]),d(o._parentPath===t,"Parent path of component "+o.id+" should be "+t+" but is "+o._parentPath),d(o._owner===this._owner,"Component "+o.id+" _owner property is not correct."))}},g=p[Y.ROOT_PATH];d(g,"Cannot find root node via path")&&(d(g.id===this._data.id,"Root node has correct id"),d(g.path===Y.ROOT_PATH,"Root node has correct path"),d(""===g._parentPath,"Root node has correct parent path"),d(g._owner===this._owner,"Root node has correct owner"),d(g._data===this._data,"Root node has correct data"),d(u[g.id]===g,"Cannot find root node via id")&&delete u[g.id],delete p[Y.ROOT_PATH]),m(this._data,Y.ROOT_PATH);let E=Object.keys(h);for(let e=0;e<E.length;e++)i("Component "+E[e]+" is in cache but could not be found.");E=Object.keys(u);for(let e=0;e<E.length;e++)i("Node "+E[e]+" is in cache but could not be found.");E=Object.keys(p);for(let e=0;e<E.length;e++)i("Absolute path "+E[e]+" is in cache but could not be found.");return s.length?s:null}}function q(e,t,r,s,o,i,d){if(!t._owner||!e._owner)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Failed to update storage for copied component, missing target or source branch core.");const c=t._owner._core,l=e._owner._core,h=r&&e.id===t.id;let u=l._getSourceAssetInfoOfComponent(e);const p=c.getComponentWithId(t.id),_=s&&(!p||!p.etag)&&e.state===U.unmodified,f=!h&&!u,m=f;if(o&&!p&&(u||f)&&e.id===t.id&&(t._data.id=n.generateUuid(),t.state=U.modified,t.etag=void 0,t.version=void 0,t.md5=void 0,t.length=void 0),f){if(_&&e._owner.compositeAssetId)u={compositeAssetId:e._owner.compositeAssetId,componentId:e.id,componentVersion:e.version,componentPath:e.absolutePath,repositoryId:e._owner.compositeRepositoryId},c._setSourceAssetInfoOfComponent(u,t);else if(m)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not use server-to-server copy for component "+e.id)}else c._setSourceAssetInfoOfComponent(u,t);u&&(t.state=U.modified)}class K{constructor(e,t,r=!1){this._owner=t,e?this._setData(e,r):(e={id:n.generateUuid()},this._core=new G(e,this,r),this._data=e)}get owner(){return this._owner}get rootNode(){return this._core.rootNode}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._owner?this._owner.compositeAssetId:void 0}set compositeAssetId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeAssetId" is read-only.')}get compositeRepositoryId(){return this._owner?this._owner.compositeRepositoryId:void 0}set compositeRepositoryId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeRepositoryId" is read-only.')}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._isDirty}get changeCount(){return this._core.changeCount}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t,r){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}addComponentWithComponentDescriptor(e,t,r,s,o){return this._core.addComponentWithComponentDescriptor(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message,e)}return this._setData(t,this._core._readOnly)}copy(){return new K(JSON.parse(JSON.stringify(this._data)),this._owner)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a type of type string"):null}_setData(e,t){const r=this._verify(e);if(null===r)return this._core=new G(e,this,t),this._data=e,this;throw r}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}var $;!function(e){e[e.NONE=0]="NONE",e[e.COPY=1]="COPY"}($||($={}));const J=o.newDebug("dcx:dcxjs:dcxbranch");class Z{constructor(e,t,r,s){this._derivationType=$.NONE,e?this._setData(e,t,r,s):(e={"manifest-format-version":6,id:n.generateUuid()},this.originalManifestFormatVersion=6,this._core=new G(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e),this._pendingElements=[]}get data(){return this._data}set data(e){this._data=e}get compositeId(){return this._core.rootNode.id}set compositeId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");if(t.allNodes[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"There is already a node with the same id.");delete t.allNodes[this._data.id],this._data.id=e,t.allNodes[e]=this._core.rootNode,t._setDirty()}get rootNode(){return this._core.rootNode}set rootNode(e){this._core.rootNode=e}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._core._compositeAssetId}set compositeAssetId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._compositeAssetId=e}get compositeRepositoryId(){return this._core._compositeRepositoryId}set compositeRepositoryId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["repoId",e,"string",!0]),t._compositeRepositoryId=e}get compositeLinks(){return this._core._compositeLinks}set compositeLinks(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["links",e,"object",!0]),t._compositeLinks=e}get _isRepoComposite(){return!!this._core._compositeRepositoryId}get _collaborationType(){return this._data.local?this._data.local.collaborationType:void 0}set _collaborationType(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().collaborationType=e:delete t._local().collaborationType,t._setDirty(!0)}get _clientDataString(){return this._data.local?this._data.local.clientDataString:void 0}set _clientDataString(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().clientDataString=e:delete t._local().clientDataString,t._setDirty(!0)}get manifestEtag(){return this._data.local?this._data.local.manifestEtag:void 0}set manifestEtag(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._local().manifestEtag=e,t._setDirty(!0)}get compositeState(){return this._data.state||U.unmodified}set compositeState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(U).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');if(this._isRepoComposite&&(e===U.pendingDelete||e===U.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be deleted in one step using RepoAPISession.");if(!(this._isRepoComposite||e!==U.pendingDelete&&e!==U.committedDelete||this.compositeArchivalState!==V.pending)||this.compositeArchivalState===V.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot delete an archived composite.");this._data.state=e,t._setDirty(!0)}get compositeArchivalState(){return this._core._local().archivalState||V.active}set compositeArchivalState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(V).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "pending", "archived", or "active".');if(this._isRepoComposite&&e===V.pending)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be discarded in one step using RepoAPISession#discardAsset.");if(this.compositeArchivalState===V.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite has already been archived.");if(e!==V.active&&(this.compositeState===U.pendingDelete||this.compositeState===U.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot archive a deleted composite.");e===V.active?delete this._core._local().archivalState:this._core._local().archivalState=e,t._setDirty(!0)}get isBound(){return!(!this.manifestEtag||!this.compositeAssetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity instead.")}get versionId(){return this._versionId}set versionId(e){if(this._core._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._versionId=e}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._core.isDirty}set isDirty(e){this._core.isDirty=e}get localData(){return this._core._stringify(!1,!0)}set localData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property localData.")}get remoteData(){return this._core._stringify(!0)}set remoteData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property remoteData.")}get pendingElements(){return this._pendingElements}set pendingElements(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property pendingElements.")}get changeCount(){return this._core.changeCount}set changeCount(e){this._core.changeCount=e}get readOnly(){return this._core._readOnly}set readOnly(e){this._core._readOnly=e}static _newBranchAsCopyOfCore(e){J("_newBranchAsCopyOfCore()");const t=JSON.parse(JSON.stringify(e._data)),r=new Z(t),s=r._core;return s._sourceCompositeInfo={links:e._compositeLinks,repositoryId:e._compositeRepositoryId,assetId:e._compositeAssetId},r._resetIdentity((function(t){const r=e.getComponentWithId(t.id);if(!r)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not find original component.");if(r.state===U.modified||!r.etag)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot create a new composite from a branch that contains modified or unbound components.");const o=r._owner.compositeAssetId;if(!o)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot make a copy of component of a composite that has not been bound with an asset id. Component id ="+r.id);const n=r._owner.compositeRepositoryId;J("_nBACOC() origAssetId",o),J("_nBACOC() origRepositoryId",n),J("_nBACOC() resetComponent",t),s._setSourceAssetInfoOfComponent({compositeAssetId:o,componentId:r.id,componentVersion:r.version,componentPath:r.absolutePath,repositoryId:n},t)})),r}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message,e)}return this._setData(t,this._core._readOnly,this._core._compositeAssetId,this._core._compositeRepositoryId)}getElementWithId(e){return this._createElement(this._core.getChildWithId(e))}getElementWithAbsolutePath(e){return this._createElement(this._core.getChildWithAbsolutePath(e))}addElement(e,t,r,s,o,n){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a name of type string");if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a type of type string");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a path of type string");const i=this._core.addChild(e,s,o,n);try{i.path=r}catch(e){throw this._core.removeChild(i),e}return i._data.type=t,this._createElement(i)}updateElement(e){const t=this.getChildWithId(e.rootNode.id);if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element does not exist in branch.");const r=this._core.replaceChild(e.rootNode,t.path);return this._deleteElement(e),r}abandonElement(e){this._deleteElement(e)}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t=null,r=null){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}replaceChild(e,t,r,s){return this._core.replaceChild(e,t,r,s)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}addComponentWithComponentDescriptor(e,t,r,s,o){return this._core.addComponentWithComponentDescriptor(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}replaceComponent(e,t,r,s){return this._core.replaceComponent(e,t,r,s)}copy(){const e=new Z(JSON.parse(JSON.stringify(this._data)),!1,this._core._compositeAssetId,this._core._compositeRepositoryId);if(e._derivationType=this._derivationType,e._derivationDatetime=this._derivationDatetime,this._core._sourceAssetInfoLookup){const t=JSON.stringify(this._core._sourceAssetInfoLookup);e._core._sourceAssetInfoLookup=JSON.parse(t)}return e}_isNodeLike(e){return n.isObject(e)}_createElement(e){if(!e)return;const t=JSON.parse(JSON.stringify(e._data));t["manifest-format-version"]=this._data["manifest-format-version"],delete t.path;const r=new K(t,this,this._core._readOnly);return this._pendingElements.push(r),r}_deleteElement(e){const t=this._pendingElements.indexOf(e);if(t<0)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown element.");this._pendingElements.splice(t,1)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a type of type string"):"number"!=typeof e["manifest-format-version"]?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a manifest-format-version of type number"):null}_setData(e,t,r,s){this.originalManifestFormatVersion=e["manifest-format-version"],function(e){const t=e["manifest-format-version"];if(t<6){if(t<4)throw new a.DCXError(a.DCXError.INVALID_DATA,"Encountered manifest format version "+e["manifest-format-version"]+". Format version conversion not yet implemented for that version.");t<6&&Q(e,!0)}}(e),e.local&&(e.local.version=2);const o=this._verify(e);if(null===o)return e["manifest-format-version"]=6,this._core=new G(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e,this;throw o}_reset(e,t){if(this.readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._data.local&&(delete this._data.local.manifestEtag,delete this._core._compositeAssetId,delete this._core._compositeRepositoryId),e||(this._data.id=n.generateUuid()),this._data.state=U.modified,this._core._recursiveReset(this._data,t),this._core._setDirty()}_resetBinding(e){this._reset(!0,e)}_resetIdentity(e){this._reset(!1,e)}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}function Q(e,t=!1){t&&e.path&&delete e.path;const r=e.components;if("object"==typeof r)for(let e=0;e<r.length;e++){const t=r[e];"number"==typeof t.version&&(t.version=t.version.toString())}const s=e.children;if("object"==typeof s)for(let e=0;e<s.length;e++)Q(s[e])}const ee=o.newDebug("dcx:dcxjs:dcxcomposite"),te={PRIVATE:void 0,SHARED_BY_USER:"sharedByUser",SHARED_WITH_USER:"sharedWithUser"};class re{constructor(e,t,r,s,o,n={},i){this._collaborationType=te.PRIVATE,null!=o&&"object"==typeof o&&(n=o,o=void 0),this._repoId=o,this._current=new Z,o&&(this._current.compositeRepositoryId=o),(e||""===e)&&(this._current.data.name=e),t&&(this._current.data.type=t),r&&(this._current.compositeId=r),this._current._collaborationType=this._collaborationType,this._current.data.state=U.modified,this._current._setDirty(!0),this._options=n,s&&(this._assetId=s,this._current.compositeAssetId=s,(e||""===e)&&(this._name=e),t&&(this._type=t),r&&(this._id=r),i&&(this._version=i)),this._options.xhrBaseBranchSupport&&(this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0)}get href(){return this._href}set href(e){this._href=e}get links(){return this._links}set links(e){n.validateParams(["links",e,"object"]),this._current&&(this._current.compositeLinks=e),this._links=e}get repositoryId(){return this._current?this._current.compositeRepositoryId:this._repoId}set repositoryId(e){n.validateParams(["repoId",e,"string"]),this._current&&(this._current.compositeRepositoryId=e),this._repoId=e}get id(){return this._current?this._current.compositeId:this._id}set id(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeId=e),this._id=e}get name(){return this._current?this._current.name:this._name}set name(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.name=e),this._name=e}get version(){return this._version}set version(e){if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined");this._version=e}get type(){return this._current?this._current.type:this._type}set type(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.type=e),this._type=e}get assetId(){return this._current?this._current.compositeAssetId:this._assetId}set assetId(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeAssetId=e),this._assetId=e}get collaborationType(){return this._current?this._current._collaborationType:this._collaborationType}set collaborationType(e){if(e!==te.PRIVATE&&e!==te.SHARED_BY_USER&&e!==te.SHARED_WITH_USER)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid value: ."+e);this._current&&(this._current._collaborationType=e),this._collaborationType=e}get clientDataString(){return this._current?this._current._clientDataString:this._clientDataString}set clientDataString(e){if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: must be a string or undefined.");const t=this._options.maxClientDataLength||1024;if(e&&e.length>t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: cannot be greater than 1KB");this._current&&(this._current._clientDataString=e),this._clientDataString=e}get isBound(){return!!(this._current&&this._current.isBound||!this._current&&this._assetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity or resetBinding instead.")}get current(){return this._current}set current(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "current" is read-only.')}static newCompositeAsCopyOf(e,t,r,s,o){let i=e._core;if(i||e.current&&(i=e.current._core),!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"compositeBranchOrElement must be a branch, an element or a composite with a current branch.");const d=new re(void 0,void 0,void 0,void 0,void 0,o);return d._current=Z._newBranchAsCopyOfCore(i),d._current._derivationType=$.COPY,d._current._derivationDatetime=(new Date).toISOString(),d.id=s||n.generateUuid(),t&&(d.name=t),r&&(d.type=r),d}loadBaseBranch(e){if(!this._baseBranchData)throw new a.DCXError(a.DCXError.NO_BASE_BRANCH_DATA,"No base branch data.");let t,r;try{if(r=new Z(void 0,!0,this.assetId).parse(this._baseBranchData),!e)return m.default.resolve(r)}catch(r){if(!e)return m.default.reject(r);t=r}e(t,r)}resolvePullWithBranch(e,t){const r=e;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Need a branch.");if(r===this._current)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot resolve current.");if(this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pulledBranchData,this._pulledBranchData=void 0),(()=>{r.readOnly=!1,r._collaborationType=this.collaborationType,r._clientDataString=this.clientDataString,this._current=r})(),!t)return this._current;t(void 0,this._current)}acceptPush(e){const t=this._pushJournal;let r;if(t)try{t.applyToBranch(this._current,!0),this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pushedBranchData,this._pushedBranchData=void 0),this._pushJournal=void 0,e&&e()}catch(e){r=e}else e&&e();if(r){if(!e)throw r;e(r)}if(!e)return this._current}resetBinding(e){delete this._assetId,this._current&&this._current._resetBinding(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}resetIdentity(e){delete this._assetId,this._current?(this._current._resetIdentity(),this._id=this._current.compositeId):this._id=n.generateUuid(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}_setPath(e){this._path=e}get _isRepoComposite(){return n.isObject(this._current)&&"boolean"==typeof this._current._isRepoComposite?this._current._isRepoComposite:!!this.repositoryId}}re.COLLABORATION=te;const se=c.telemetrySpan("AdobeDCX.newDCXComposite",(function(e,t,r,s,o,n,i={},d){if(null==e&&null==n){if("string"!=typeof o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a type.");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a name.")}r&&c.setTracingSpanAttribute("name",r);const l=new re(r,o,s,e,t,i,d);return n&&(l.links=n),l}));function oe(e,t,r){if(ee("convertToDCXComposite()"),e.format&&!e.format.endsWith("+dcx"))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Format must end in "+dcx"');return new re(e.name,e.format,t,e.assetId,e.repositoryId,r,e.version)}class ne{constructor(){this._originURL=null,this._manageUIURL=null,this._licenseType=null,this._licenseUrl=null,this._attributionURL=null,this._attributionName=null}get originURL(){return this._originURL}set originURL(e){this._originURL=e}get manageUIURL(){return this._manageUIURL}set manageUIURL(e){this._manageUIURL=e}get licenseType(){return this._licenseType}set licenseType(e){this._licenseType=e}get licenseUrl(){return this._licenseUrl}set licenseUrl(e){this._licenseUrl=e}get attributionURL(){return this._attributionURL}set attributionURL(e){this._attributionURL=e}get attributionName(){return this._attributionName}set attributionName(e){this._attributionName=e}}const ie=(e,t)=>`It looks like you're using a ${e} bundle in a ${t} environment. \r\nThis may lead to unexpected results. \n\nSee https://git.corp.adobe.com/DMA/dcx-js/blob/dev/docs/guides/bundles.md for main field definitions.`;class ae{constructor(e,t,r){this._aborted=!1,this._session=e,this._callback=t,this._cleanup=r,this._componentsPending=0,this._bytesTransfered=0,this._bytesTotal=0,this._onProgress=n.noOp,this._reportProgress=e=>{if(e>0){this._bytesTransfered+=e;const t=this._onProgress;t&&t(this._bytesTransfered,this._bytesTotal)}}}get xferComplete(){return this._xferComplete}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}set onProgress(e){this._onProgress=e}get onProgress(){return this._onProgress}_callCallback(e,t){const r=this._callback;if(r)return this._callback=void 0,r(e,t)}_xferComplete(e,t){const r=this._cleanup;if(!r)return this._callCallback(e,t);this._cleanup=void 0,r(e,t)}abort(e){return this._aborted||(this._aborted=!0,this._session._service.abortAllWithToken(this)),e||(this._callback=void 0,e=new Error("Aborted")),this._xferComplete(e,null)}}class de{constructor(){}static createCompositeAtPubs(e,t,r,s){return j(this,void 0,void 0,(function*(){return de.pubsAsset||(de.pubsAsset=yield i.getPubsAsset(e.serviceConfig)),yield e.createComposite({assetId:de.pubsAsset.assetId,repositoryId:de.pubsAsset.repositoryId},t,r,void 0,void 0,void 0,void 0,void 0,void 0,s)}))}static clearPubsAsset(){this.pubsAsset=void 0}static publishCompositeAlreadyPushedToPubs(e,t,r,s,o,n){if(!t||null==t.resourcePath||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"ResourcePath & communityId must be set on publication record for the composite to be published.");const i=new ae(o,n),d=null!==t.assetId;let c;return e.current&&o.updatePublicationRecordData(t,e.current),d?(c=o.updateCpMetadataAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i):(c=o.publishCompositeAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i)}static getCpMetadata(e,t,r){if(!t||null==t.assetId||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Asset Id & communityId must be set on publication record to fetch its CP metadata.");return e.getCpMetadata(t,r)}}class ce{constructor(e){this._waitingCallbacks=[],this._commitInProgress=!1,this._needAnotherCommit=!1,this._data={"composite-href":e.href,"uploaded-components":{}}}get compositeHref(){return this._data["composite-href"]}set compositeHref(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get derivationType(){return this._data["derivation-type"]}set derivationType(e){this._data["derivation-type"]=e}get manifestEtag(){return this._data.etag}set manifestEtag(e){e?this._data.etag=e:delete this._data.etag}get versionId(){return this._data.versionId}set versionId(e){e?this._data.versionId=e:delete this._data.versionId}get currentBranchEtag(){return this._data["current-branch-etag"]}set currentBranchEtag(e){e?this._data["current-branch-etag"]=e:delete this._data["current-branch-etag"]}get changeCount(){return this._data.change}set changeCount(e){e?this._data.change=e:delete this._data.change}get compositeHasBeenDeleted(){return!!this._data["composite-deleted"]}set compositeHasBeenDeleted(e){e?this._data["composite-deleted"]=!0:delete this._data["composite-deleted"]}get compositeHasBeenArchived(){return!!this._data["composite-archived"]}set compositeHasBeenArchived(e){e?this._data["composite-archived"]=!0:delete this._data["composite-archived"]}get isEmpty(){return 0===Object.keys(this._data["uploaded-components"]).length&&!this.compositeHasBeenDeleted&&!this.compositeHasBeenArchived&&!this.manifestEtag}set isEmpty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get isComplete(){return!!(this._data.etag&&this._data.change||this._data["composite-deleted"]||this._data["composite-archived"])}set isComplete(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}recordUploadedComponent(e,t,r,s,o,n){const i={etag:t,length:o,version:r,md5:s,timestamp:(new Date).toISOString()};n&&(i["source-asset-info"]=n),this._data["uploaded-components"][e]=i}idsOfAllUploadedComponents(){return Object.keys(this._data["uploaded-components"])}getRecordForUploadedComponent(e){const t=this._data["uploaded-components"][e];if(t&&!this.isComplete){let r=t.timestamp;if(!r)return void this.removeRecordForUploadedComponent(e);if(r=new Date(r),isNaN(r.getTime()))return void this.removeRecordForUploadedComponent(e);if(Date.now()-r.getTime()>=6012e5)return void this.removeRecordForUploadedComponent(e)}return t}removeRecordForUploadedComponent(e){delete this._data["uploaded-components"][e]}applyToBranch(e,t){const r=e;if(!this.isComplete)throw new a.DCXError(a.DCXError.INVALID_STATE,"Journal is not complete.");const s=r.isDirty;if(this.compositeHasBeenDeleted)r._data.state=U.committedDelete,r.manifestEtag=this.manifestEtag;else{this.compositeHasBeenArchived&&(r.compositeArchivalState=V.archived);const e=r.compositeState!==U.unmodified&&this.changeCount!==r.changeCount,t=this.idsOfAllUploadedComponents(),s=t.length;for(let e=0;e<s;e++){const s=t[e],o=r.getComponentWithId(s);if(o){const e=this.getRecordForUploadedComponent(o.id);if(o._data.etag=e.etag,o._data.length=e.length,o._data.version=e.version,o._data.md5=e.md5,e["source-asset-info"]){const t=r._core._getSourceAssetInfoOfComponent(o),s=e["source-asset-info"];t&&s&&t.compositeAssetId===s.compositeAssetId&&t.componentId===s.componentId&&t.componentVersion===s.componentVersion&&(o._data.state=U.unmodified,r._core._setSourceAssetInfoOfComponent(void 0,o))}else o._data.state=U.unmodified}}r.manifestEtag=this.manifestEtag,"string"==typeof this.versionId&&(r.versionId=this.versionId),void 0!==this.derivationType&&(r._derivationType=this.derivationType),e||(r._data.state=U.unmodified)}t&&(r._isDirty=s)}}function le(e){let t=0;return(r,s,o)=>{e(r-t,o),t=r}}const he=o.newDebug("dcx:dcxjs:compositexfer:pull");function ue(e){he("_pullCompositeManifest()");const{_composite:t,_session:r,_additionalData:{versionId:s,referenceBranch:o},additionalHeaders:d}=e;if(t._links){const{assetId:e,repositoryId:s}=r.registerLinks(t._links,t.repositoryId,t.assetId);t.assetId=e,t.repositoryId=s,delete t._links}if("string"!=typeof t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must have an asset id.");let c;return he("_pCM() pullManifest()",e),o&&!s&&(c=o.manifestEtag),m.default.resolve(void 0,e).then((()=>{const o=r.getCompositeManifest(t,s,c,d);return e.hasProgressHandler&&(o.progress=le(e._reportProgress.bind(e))),o})).then((r=>{const{manifestData:o,manifestEtag:d,response:c}=r;e._additionalData.response=c;try{const e=i.parseLinksFromResponseHeader(c);t.links=e}catch(e){}if(he("_pCM() pM() getCompositeManifest() cb",d),null===o)return;let l;try{l=n.isObject(o)?new Z(o):(new Z).parse(o),l.compositeAssetId=t.assetId,l.compositeRepositoryId=t.repositoryId,l._collaborationType=t.collaborationType,l._clientDataString=t.clientDataString,l.versionId=null!=c.headers.version?c.headers.version:s,l.manifestEtag=d}catch(e){throw he("_pCM() pM() gCM() bad manifest"),new a.DCXError(a.DCXError.INVALID_JSON,"Corrupted manifest",e)}if(l.compositeState===U.committedDelete||l.compositeState===U.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");const h=l._core.allComponents();for(let e=0;e<h.length;++e){const t=h[e];t.state===U.pendingDelete||t.state===U.committedDelete?l.removeComponent(t):t.state=U.unmodified}return l})).then((e=>{if(null!=e)return e.compositeState=U.unmodified,e.readOnly=!0,t._options.xhrBaseBranchSupport&&!s&&(t._pulledBranchData=e.localData),e})).catch((e=>{if(e.code===a.DCXError.NOT_FOUND)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite missing or deleted",e.underlyingError||e);throw e}))}const pe=o.newDebug("dcx:dcxjs:compositexfer:push"),_e="META-INF/metadata.xml";var fe;function me(e,t){if(pe("_pushComposite()"),!t.assetId||!t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite is not bound to a cloud asset. createComposite() must be called to assign an asset ID and repository ID before calling push.");const{owner:r,compositeIsNew:s,shouldPushWithXMP:o}=e._additionalData;return function(e,t){return pe("_isNoOpPush()"),!t&&e.compositeState===U.unmodified}(r,s)?m.default.resolve(r,e):(function(e){if(pe("_assertStateIsValidForPush()"),e.compositeState===U.committedDelete)throw new a.DCXError(a.DCXError.DELETED_COMPOSITE,"Attempt to push a deleted composite");if(e.compositeState===U.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");if(e.compositeArchivalState===V.pending||e.compositeArchivalState===V.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites cannot be archived")}(r),e._bytesTotal=0,e._indeterminateTotalBytes=!0,we.call(e).then(Ie.bind(e)).then(o&&!ge(r)?Ee.bind(e):void 0).then(ye.bind(e)).then(Ce.bind(e)).catch(Ae.bind(e)))}function ge(e){return e.getComponentWithAbsolutePath(`/${_e}`)}function Ee(){const{_composite:e,_session:r,_additionalData:{xmpConfig:s,owner:o,compositeIsNew:a}}=this,d=function(e,r,s){if(r.mode===t.XMPModes.CLIENT_MANAGED&&r.initialXMPXML)return r.initialXMPXML;const{creatorTool:o,modifyDate:i}=r,a=n.generateUuid(),d=[];if(e._derivationType===$.COPY){const t=e._derivationDatetime,r=h.makeHistoryEventXML(o,"copied",a,t);d.push(r)}else if(s){const e=h.makeHistoryEventXML(o,"created",a,i);d.push(e)}if(!s||e._derivationType===$.COPY){const e=h.makeHistoryEventXML(o,"saved",a,i);d.push(e)}return h.initializeXMPXML(o,a,i,d,void 0)}(o,s,a);return r.putCompositeComponent(e,n.generateUuid(),d,i.EmbeddedMetadataMediaTypes.XML,!0,d.length).then((t=>r.uploadResultsFromAdobeRepoUploadResult(t,e.id))).then((e=>(this._additionalData.xmpPushed=!0,o.addComponentWithUploadResults("xmp-metadata","metadata",_e,void 0,e))))}function Ae(e){pe("_handleError()",e);const{_session:t,_composite:r,_additionalData:{compositeIsNew:s}}=this;if(s||0===this.failedComponents.length&&(e.response&&400===e.response.statusCode||e.additionalData&&e.additionalData.bulkResponse))throw e;let o=!1;return t.headCompositeManifest(r).then((()=>{throw o=!0,e})).catch((t=>{if(!o&&404===t.response.statusCode)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite does not exist; may have been deleted",e,e.response,{failedComponents:this.failedComponents});throw e.additionalData={failedComponents:this.failedComponents},e}))}function ye(){pe("_pushManifest()");const e=this._additionalData.owner;if(e.compositeState!==U.modified)return;const{_session:t,_additionalData:{overwriteExisting:r,validationLevel:s,xmpConfig:o,compositeIsNew:a,shouldPushWithXMP:d,xmpPushed:c,contributors:l}}=this;e.compositeState=U.unmodified;const h=e.remoteData,u=h.length;this._bytesTotal+=u,this._indeterminateTotalBytes=!1;const p=function(e,t){return pe("_updateManifestEtag()"),e._journal.manifestEtag&&e._journal.currentBranchEtag===t.manifestEtag&&(pe("_uME() updating etag, previous: ",t.manifestEtag),t.manifestEtag=e._journal.manifestEtag),pe("_uME() using if-match: ",t.manifestEtag),t.manifestEtag}(this,e),_=l?l.manifest:void 0,f=Object.assign({[i.HeaderKeys.X_CONTRIBUTORS]:JSON.stringify(_)},this.additionalHeaders);let m;return!d||c?(m=t.updateCompositeManifest(e,h,r,s,p,n.pruneUndefined(f)),this.hasProgressHandler&&(m.progress=le(this._reportProgress.bind(this))),m):De(this,e,h,r,s,p,a,o)}function De(e,r,s,o,d,c,l,u,p=0){const{_session:_,_composite:f}=e,g=function(e,r){if(r.mode===t.XMPModes.CLIENT_MANAGED)return r.xmpPatch;const{creatorTool:s,modifyDate:o}=r,n=[];return e._derivationType===$.COPY&&h.makeDerivedWithAction.call({patchDocument:n},s,"copied",void 0,o),h.appendHistoryEvent.call({patchDocument:n},"saved",s,o),n}(r,u),E=_.getLinkHrefForAsset(f,i.LinkRelation.EMBEDDED_METADATA),A=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:"*",[i.HeaderKeys.CONTENT_TYPE]:i.JSONPatchMediaType}),y=_.getLinkHrefForAsset(f,i.LinkRelation.MANIFEST),D=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:c,[i.HeaderKeys.CONTENT_TYPE]:`${i.ManifestMediaType};validation-level=${d}`});return m.default.allSettled([y,E]).then((([e,t])=>{if("rejected"===t.status||"rejected"===e.status)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not retrieve required links.");return _.performBulkRequest(f,[{method:i.HTTPMethods.PUT,href:e.value,headers:D,body:s},{method:i.HTTPMethods.PATCH,href:t.value,headers:A,body:JSON.stringify(g)}])})).then((t=>function(e,t,r,s,o,n,d,c,l,u=0){pe("_handleManifestAndXMPResponse()");const[p,_]=l.result,{statusCode:f}=p,{statusCode:m}=_;if(pe("_hMAXR() manifest, embedded status: ",f,m),u>2&&(f>=400||m>=400))throw pe("_hMAXR() circuit break retries"),new a.DCXError(a.DCXError.INVALID_STATE,"Repairing failed or repeated failures during XMP/manifest push. Check additionalData.",void 0,l[0],{bulkResponse:l});let g=s,E=d,A=n;function y(s=r){return pe("_hMAXR() retry bulk; isNew, etag, overwrite: ",E,A,g),De(e,t,s,g,o,A,E,c,u+1)}if(f>=400){if(404===f)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite not found.",void 0,p,{bulkResponse:l});if(424===f);else{if(s&&409===f)throw new a.DCXError(a.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,p,{bulkResponse:l});if(s&&412===f)throw new a.DCXError(a.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,p,{bulkResponse:l});if(409===f)g=!1;else{if(412!==f)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from manifest PUT in bulk.",void 0,p,{bulkResponse:l});g=!1,A=void 0}}}if(m>=400){if(424===m);else{if(404!==m){if(400===m){const r=ge(t);if(r)return function(e,t,r){const{_session:s,_composite:o,_additionalData:{owner:n}}=e;return s.getCompositeComponent(o,t.id,t.version,"text").then((({response:e})=>{const n=h.repairXMPXML(e,r.creatorTool,r.modifyDate);if(e!==n)return s.putCompositeComponent(o,t.id,n,i.EmbeddedMetadataMediaTypes.XML,!1,n.length)})).then((e=>e&&s.uploadResultsFromAdobeRepoUploadResult(e,o.id))).then((e=>{if(e)return n.updateComponentWithUploadResults(t,e),e.records[t.id].etag}))}(e,r,c).then((()=>y(t.remoteData)));throw new a.DCXError(a.DCXError.INVALID_STATE,"Manifest appears to be corrupted.",void 0,p,{bulkResponse:l})}throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from embedded request in bulk.",void 0,p,{bulkResponse:l})}E=!0}return y()}const D=ge(t);return e._journal.recordUploadedComponent(D.id,"*",`${parseInt(D.version)+1}`,_.headers["content-md5"]||D.md5,D.length),p}(e,r,s,o,d,c,l,u,t,p)))}function Ce(e){if(void 0===e)return this._additionalData.owner;this._additionalData.manifestResponse=e;const{_journal:t,_composite:r,_additionalData:{owner:s}}=this,o=e.headers.etag,n=e.headers.version,i=s.changeCount;return t.manifestEtag=o,t.derivationType=$.NONE,t.currentBranchEtag=s.manifestEtag,t.changeCount=i,t.versionId=n,t.applyToBranch(s),s.compositeState=U.unmodified,r._options.xhrBaseBranchSupport&&(r._pushedBranchData=s.localData),s}function Ie(e){if(pe("_handleFailedComponents()"),0===e.length)return this._additionalData.owner;if(e.filter((e=>e.error&&e.error.code===a.DCXError.EXCEEDS_QUOTA)).length>0)throw new a.DCXError(a.DCXError.EXCEEDS_QUOTA,"One or more components failed to upload.",void 0,void 0,{failedComponents:e});throw new a.DCXError(a.DCXError.COMPONENT_UPLOAD_ERROR,"One or more components failed to upload.",void 0,void 0,{failedComponents:e})}function ve(e){return pe("_getCurrentCopyOpCollector()"),(0===e.length||e[e.length-1].docBuilder.entryCount>=(this._additionalData._test_operationsPerBatch||50))&&(pe("_gCCOC() new copy op collector"),e.push({docBuilder:i.newOperationDocBuilder(),orderedPendingComponents:[]})),e[e.length-1]}function Te(e,t){pe("_reduceComponent()");const{_journal:r,_composite:s,_additionalData:{owner:o}}=this,{state:n=U.unmodified,etag:d}=t,c=null==d;if(!c&&n===U.unmodified)return pe("_rC() not new, not modified"),void r.removeRecordForUploadedComponent(t.id);if(!c&&(n===U.committedDelete||n===U.pendingDelete))return pe("_rC() not new, committedDelete or pendingDelete"),void o.removeComponent(t);const l=o._core._getSourceAssetInfoOfComponent(t);if(pe("_rC() source asset",l),null==l)return void this._failedComponents.push({component:t,error:new a.DCXError(a.DCXError.INVALID_STATE,"Component should not be modified or new without local storage")});const h=r.getRecordForUploadedComponent(t.id);if(l&&h){const e=h["source-asset-info"];if(e&&e.compositeAssetId===l.compositeAssetId&&e.componentId===l.componentId&&e.componentVersion===l.componentVersion)return t.etag=h.etag,t.version=h.version,t.md5=h.md5,t.length=h.length,void(t.state=U.unmodified)}const u=ve.call(this,e);u.docBuilder.copyResources({assetId:l.compositeAssetId,repositoryId:l.repositoryId},s,[{source:{component_id:l.componentId,revision:l.componentVersion,reltype:i.LinkRelation.COMPONENT},target:{component_id:t.id,reltype:i.LinkRelation.COMPONENT}}],!0),u.orderedPendingComponents.push([t,l])}function be(e){pe("_handleBatchResults(): ",e);const{_journal:t,_failedComponents:r}=this;e.map((e=>{if("rejected"===e.status)throw pe("_hBR() error",e.reason),e.reason;const{orderedPendingComponents:s,results:o,response:i}=e.value;o.forEach((({resources:e})=>{e.forEach((e=>{const o=s.find((([,t])=>t.componentId===e.target.component_id));if(o){const[s,d]=o;try{const{etag:r,id:o,version:c,md5:l,length:h}=function(e,t,r){if(pe("_validateCopyResponse()"),!n.isObject(e))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid result",void 0,t);const s={etag:e.etag,version:e.revision,md5:r.md5,length:r.length,state:U.unmodified};for(const e in s)if(null==s[e])throw new a.DCXError(a.DCXError.INVALID_DATA,`No ${e}`,void 0,t);return Object.assign(r,s)}(e.target,i,s);t.recordUploadedComponent(o,r,c,l,h,d)}catch(e){r.push({component:s,error:e})}}}))}))}))}function Pe(e,t){pe("_parallelBatchOperations()");const{value:r,done:s}=t.next();return pe("_pBO() next generator: ",r,s),m.default.resolve(r).then((t=>{const r=t.filter((e=>e.orderedPendingComponents.length)).map((t=>{const r=t.docBuilder.getDocument(),s=JSON.stringify(r);this._bytesTotal+=s.length;const o=e.performBatchOperation(s).then((({result:e,response:r})=>({results:e,response:r,orderedPendingComponents:t.orderedPendingComponents})));return this.hasProgressHandler&&(o.progress=le(this._reportProgress.bind(this))),o}));return m.default.allSettled(r)})).then(be.bind(this)).then((()=>s?this.failedComponents:Pe.call(this,e,t)))}function*Re(e){pe("_makeCopyOpGenerator()");let t=[];for(let r=0;r<e.length;r++){const s=e[r];Te.call(this,t,s);const o=ve.call(this,t);o.orderedPendingComponents.length===i.COPY_RESOURCES_RESOURCE_LIMIT&&(yield[o],t=[])}return t}function we(){pe("_pushComponents()");const{_session:e,_additionalData:{owner:t}}=this,r=t.allComponents();pe("_pC() component count: ",r.length);const s=Re.call(this,r);return m.default.resolve(void 0,this).then((()=>Pe.call(this,e,s)))}t.XMPModes=void 0,(fe=t.XMPModes||(t.XMPModes={}))[fe.MANAGED=0]="MANAGED",fe[fe.PARTIALLY_MANAGED=1]="PARTIALLY_MANAGED",fe[fe.CLIENT_MANAGED=2]="CLIENT_MANAGED",fe[fe.UNMANAGED=3]="UNMANAGED";const Oe=o.newDebug("dcx:dcxjs:compositexfer:upload");function Se(e,t){Oe("_uploadComponent()");const{additionalHeaders:r,_additionalData:{componentId:s,componentType:o,componentIsNew:i,size:d,md5:c},_composite:h,_session:u,_blockSize:p}=e;n.validateObject(h,"composite",["id","string"],["repositoryId","string"],["assetId","string"]),n.validateParams(["session",u,"object"],["dataOrSliceCallback",t,["object","function","string"]],["componentType",o,"string"],["componentId",s,"string",!0],["size",d,"+number",!0],["md5",c,"string",!0]);const{id:_,repositoryId:f}=h,g=d||t.length||t.byteLength||t.size;return e._bytesTotal=g,m.default.resolve(void 0,e).then((()=>u.putCompositeComponent(h,s,t,o,i,g,c,e.hasProgressHandler?le(e._reportProgress.bind(e)):void 0,r,p))).then((({result:t,response:r})=>{e._additionalData.response=r;const n=l.createUploadResults(_,h.assetId,f);return n.records[s]=function(e,t,r,s){if("object"!=typeof s)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Invalid upload result, expecting object");const{md5:o,etag:n,revision:i,length:d=t}=s;if(null==d)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No length");if(null==n)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No etag");if(null==i)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No version");if(null==o)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No md5");return l.createUploadRecord(e,n,i,o,d,r)}(s,g,o,t),n}))}const ke=o.newDebug("dcx:dcxjs:repocompositexfer:xferctx");class Ne{constructor(e,t,r,s,o,n){this.additionalHeaders=o,this._aborted=!1,this._bytesTransfered=0,this._abortHandlers=[],this._bytesTotal=0,this._additionalData={},this._failedComponents=[],this._session=e,this._composite=t,this.onProgress=s,r&&(this._additionalData=r),this._blockSize=n}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}get failedComponents(){return this._failedComponents}get hasProgressHandler(){return void 0!==this._progressHandler}set onProgress(e){n.isAnyFunction(e)&&(this._progressHandler=e)}get onProgress(){return this._progressHandler}onAbort(e){this._abortHandlers.push(e)}abort(e){this._aborted||(this._abortHandlers.forEach((t=>n.isAnyFunction(t)&&t.call(void 0,e))),this._session._service.abortAllWithToken(this),this._aborted=!0)}_reportProgress(e,t){if(ke("progress",e),t&&(this._indeterminateTotalBytes=!0),e>0&&(this._bytesTransfered+=e,n.isAnyFunction(this._progressHandler)))try{this._progressHandler(this._bytesTransfered,this._bytesTotal,this._indeterminateTotalBytes)}catch(e){console.error("Error in progress callback",e)}}}const Le=o.newDebug("dcx:dcxjs:compositexfer");function Me(e,t,r,s){const n=e._additionalData.response;if((n||r&&r.response)&&o.emitAnalyticsEvent(t,{composite:e._composite,error:r,response:n||r.response,branch:s}),r)throw r}const Xe=c.telemetrySpan("AdobeDCX.pullCompositeManifestOnly",(function(e,t,r){const s=new Ne(e,t,{referenceBranch:t.current},void 0,r);t.assetId&&c.setTracingSpanAttribute("assetId",t.assetId),t.id&&c.setTracingSpanAttribute("id",t.id);const n=(e,t)=>(Me(s,o.AnalyticsEvent.PullComposite,e,t),t);return ue(s).then(n.bind(void 0,void 0)).catch(n)}));function xe(e,t,r,s,n){const i=e._additionalData.response;if((i||s&&s.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.UploadComponent,{composite:e._composite,error:s,response:i||s.response,isBlockTransferred:t,component:r}),s)throw s;return n}const Be=c.telemetrySpan("AdobeDCX.uploadNewComponent",(function(e,t,r,s,o,i,d,l,h,u){if(Le("uploadNewComponent()"),o&&!n.verifyUuid(o))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component id is not a uuid ");const p=new Ne(e,t,{componentType:s,componentIsNew:!0,componentId:o||n.generateUuid(),size:i,md5:d},l,h,u);c.setTracingSpanAttribute("componentId",o),c.setTracingSpanAttribute("type",s),c.setTracingSpanAttribute("assetId",t.assetId),i&&c.setTracingSpanAttribute("size",i.toString());const _=(e,t)=>(xe(p,!!f.blockUpload,{length:i,type:s},e,t),t),f=Se(p,r).then(_.bind(void 0,void 0)).catch(_);return f})),je=c.telemetrySpan("AdobeDCX.uploadComponent",(function(e,t,r,s,o,i,a,d){Le("uploadComponent()"),n.validateObject(r,"component",["id","string"],["type","string"]);const{id:l,type:h}=r,u=new Ne(e,t,{componentType:h,componentIsNew:!1,componentId:l,size:o,md5:i},a,d);c.setTracingSpanAttribute("componentId",l),c.setTracingSpanAttribute("assetId",t.assetId),o&&c.setTracingSpanAttribute("size",o.toString());const p=(e,t)=>(xe(u,!!_.blockUpload,r,e,t),t),_=Se(u,s).then(p.bind(void 0,void 0)).catch(p);return _})),Ue=c.telemetrySpan("AdobeDCX.pushComposite",(function(e,r,s,i=1,d={mode:t.XMPModes.MANAGED},l,h){Le("pushComposite()"),n.validateParams(["session",e,"object"],["composite",r,"object"],["overwriteExisting",s,"boolean"],["validationLevel",i,"+number"],["options",d,"object",!0]);const u=function(e){void 0===e.mode&&(e.mode=t.XMPModes.MANAGED);const r=e.modifyDate||(new Date).toISOString(),s=e.creatorTool||"dcx-js";if(e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.PARTIALLY_MANAGED)return Le("push: using managed XMP mode"),n.validateObject(e,"options",["creatorTool","string",!0],["modifyDate","string",!0]),{mode:e.mode,creatorTool:s,modifyDate:r};if(e.mode===t.XMPModes.CLIENT_MANAGED){Le("push: using client managed XMP mode"),n.validateObject(e,"options",["xmpPatch","object[]",!0],["initialXMPXML","string",!0]);const t=e.xmpPatch||[],o=n.validateJSONPatchDocument(t);if(!0!==o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Invalid parameter "options.xmpPatch".',void 0,void 0,{issues:o});return Object.assign(Object.assign({},e),{modifyDate:r,creatorTool:s})}if(e.mode===t.XMPModes.UNMANAGED)return Le("push: using unmanaged XMP mode"),e;throw new a.DCXError(a.DCXError.INVALID_PARAMS,`Invalid XMP mode '${e.mode}'`)}(d),p=!r.isBound;!function(e,r){e.mode===t.XMPModes.PARTIALLY_MANAGED||e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.CLIENT_MANAGED&&(r||!r&&e.xmpPatch)}(u,p);const _=r._current.copy(),f=_._derivationType,m=new Ne(e,r,{owner:_,overwriteExisting:s,compositeIsNew:p,validationLevel:i,xmpConfig:u,shouldPushWithXMP:!1,xmpPushed:!1,contributors:h},void 0,l);null!==r.assetId&&c.setTracingSpanAttribute("assetId",r.assetId),null!=r.type&&c.setTracingSpanAttribute("type",r.type),m._journal=m._composite._pushJournal||new ce(r);const g=function(e,t){const s=m._additionalData.manifestResponse;(s||t&&t.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.PushComposite,{composite:r,branch:_,error:t,response:s||t.response,derivationType:f});const n=m._journal;return m._composite._pushJournal=n.isEmpty?void 0:n,e};return me(m,r).then(g).catch((e=>{throw g(void 0),e}))})),Ve=s.AdobeNetworkHTTPService,He=Ve;n.isBrowserSDK()&&n.isNode()?p.default.warn(ie("browser","Node")):!n.isBrowserSDK()&&n.isBrowser()&&p.default.warn(ie("Node","browser"));const Fe=o.getGlobalLogger(),Ye=_,We=re.COLLABORATION,ze=g;Object.defineProperty(t,"createHTTPService",{enumerable:!0,get:function(){return s.createHTTPService}}),Object.defineProperty(t,"AdobeDCXLogger",{enumerable:!0,get:function(){return o.AdobeDCXLogger}}),Object.defineProperty(t,"getGlobalLogger",{enumerable:!0,get:function(){return o.getGlobalLogger}}),Object.defineProperty(t,"AdobeDCXError",{enumerable:!0,get:function(){return a.AdobeDCXError}}),Object.defineProperty(t,"DCXError",{enumerable:!0,get:function(){return a.DCXError}}),Object.defineProperty(t,"isAdobeDCXError",{enumerable:!0,get:function(){return a.isAdobeDCXError}}),t.AdobeCommunityPlatform=de,t.AdobeCommunityPublicationRecord=g,t.AdobeCommunitySession=B,t.AdobeDCXBranch=Z,t.AdobeDCXComponent=F,t.AdobeDCXComposite=re,t.AdobeDCXElement=K,t.AdobeDCXNode=Y,t.AdobeDCXPushJournal=ce,t.AdobeDCXUtil=Ye,t.AdobeNetworkHTTPService=Ve,t.AdobeRemixData=ne,t.COLLABORATION=We,t.CommunityPublicationRecord=ze,t.CommunitySession=B,t.HTTPService=He,t.RemixData=ne,t.communityPlatform=de,t.convertToDCXComposite=oe,t.copyResources=function(e,t,r,s,o,n){return e.copyResources(t,r,s,o,n)},t.createCommunityPublicationRecord=()=>new g,t.createCommunitySession=(e,t)=>new B(e,t),t.createComposite=function(e,t,r,s,o,d,c,l,h){if(ee("createComposite()"),n.validateParams(["session",e,"object"],["composite",t,"object"],["parentDir",r,"object"],["relPath",s,"string"]),t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must not already have an assigned asset id.");if("string"!=typeof r.repositoryId&&"string"!=typeof t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Either composite or parentDir must contain valid repositoryId.");if("string"==typeof r.repositoryId&&"string"==typeof t.repositoryId&&r.repositoryId!==t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Composite contains a repositoryId that does not match parentDir.");if("string"!=typeof t.type)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must contain a valid type.");const u="string"==typeof t.repositoryId?t.repositoryId:r.repositoryId,p=r;if(Object.getOwnPropertyNames(r).forEach((e=>{p[e]=r[e],p.repositoryId=u})),!i.isMinimalAdobeAsset(p))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return function(e,t,r,s,o,a,d,c,l,h){const{repositoryId:u}=r;return e.createComposite(r,s,o,a,d,c,l,void 0,void 0,h).then((r=>j(this,void 0,void 0,(function*(){const{assetId:s,links:o}=r.result;if(t.assetId=s,t.repositoryId=u,t.links=o,c){const{manifestData:r}=yield e.getCompositeManifest(t);t.resolvePullWithBranch(new Z(r))}return a?r.result:t})))).catch((r=>{try{if(r.response&&n.isObject(r.response.headers)){const s=r.response.headers["asset-id"]||r.response.headers["x-resource-id"],o=i.parseLinksFromResponseHeader(r.response);t.links=o,"string"==typeof s&&n.isObject(o)&&e.updateCachedAssetLinks({assetId:s,repositoryId:u,links:o})}}catch(e){}throw r}))}(e,t,p,s,t.type,o||void 0,d,c,l,h)},t.createRemixData=()=>new ne,t.getCompositeManifestAndComponentsByPath=function(e,t,r,s,o,n){const a=i.isAdobeDCXCompositeLike(t)?t:oe(t);return e.getManifestAndComponentsByPath(a,r,s,o,n).then((e=>Object.assign(e,{composite:a})))},t.getURLForComponent=function(e,t,r,s){return e.getCompositeComponentUrl(t,t.id,void 0!==r?r:t.version,s)},t.logger=Fe,t.newCompositeAsCopyOf=(e,t,r,s,o={})=>re.newCompositeAsCopyOf(e,t,r,s,o),t.newDCXComposite=se,t.pullCompositeManifestOnly=Xe,t.pullCompositeVersionManifestOnly=function(e,t,r,s){const n=new Ne(e,t,{versionId:r,referenceBranch:t.current},void 0,s),i=(e,t)=>(Me(n,o.AnalyticsEvent.PullCompositeVersion,e,t),t);return ue(n).then(i.bind(void 0,void 0)).catch(i)},t.pushComposite=Ue,t.uploadComponent=je,t.uploadNewComponent=Be,Object.keys(d).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}})})),Object.keys(l).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}})}))},298453:(e,t,r)=>{var s=r(501158).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(413209),n=r(617750),i=r(123e3),a=r(436246);var d=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(i);function c(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}const l=n.newDebug("dcx:http:auth");class h{constructor(e,t,r){this._authToken=e,this._apiKey=t,this._pendingAuth=!1,this._hasBaseRefreshCb=!1,this._authListeners=[],this._persistentListeners=[],this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._authTokenScheme="Bearer",a.validateParams(["authToken",e,"string",!0],["apiKey",t,"string",!0],["refreshCb",r,"function",!0]),r&&(this._hasBaseRefreshCb=!0,this.onChange(((e,t)=>{"unauthenticated"===e&&r.call(null,t)}),!0)),e&&t||(l("init unauthenticated"),this._pendingAuth=!0,setTimeout((()=>{l("after tick",this._pendingAuth),this._pendingAuth&&this.refreshAuth()})))}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}get isNoAuthMode(){return!this._hasBaseRefreshCb}set isNoAuthMode(e){this._hasBaseRefreshCb=!e}get apiKey(){return this._apiKey}get authToken(){return this._authToken}get authTokenScheme(){return this._authTokenScheme}set authTokenScheme(e){this._authTokenScheme=e}setAuthToken(e){l("setAuthToken"),this._authToken=e,this._pendingAuth=!1,this._authChanged("updated")}setApiKey(e){this._apiKey=e}resume(){l("resume()"),this._pendingAuth=!1,this._authChanged("updated")}get pendingAuth(){return this._pendingAuth}onChange(e,t=!1){l("onChange, persistent:",t);const r=this._authListeners.push(e)-1;return t&&this._persistentListeners.push(r),()=>{try{t&&(this._persistentListeners=this._persistentListeners.filter((e=>e!==r))),delete this._authListeners[r]}catch(e){}}}clearListeners(e=!1){if(l("clearListeners, persistent:",e),!0===e)return this._authListeners=[],void(this._persistentListeners=[]);this._authListeners=this._authListeners.map(((e,t)=>{if(this._persistentListeners.includes(t))return e}))}get refreshPromise(){return this._refreshPromise}_authChanged(e){return c(this,void 0,void 0,(function*(){l("authChanged",e),this._pendingAuth="unauthenticated"===e,queueMicrotask((()=>c(this,void 0,void 0,(function*(){const t=[];this._authListeners.map((r=>{if("function"==typeof r){const s=r.call(null,e,this);s&&"object"==typeof s&&s.then&&t.push(s)}})),yield Promise.all(t),"updated"===e&&this._resolveRefresh()}))))}))}_resolveRefresh(){l("_resolveRefresh"),this._refreshResolve&&this._refreshResolve(this.getAuthData()),this._refreshResolve=void 0,this._refreshPromise=void 0}refreshAuth(){return l("refreshAuth"),this._refreshPromise||(this._refreshPromise=new Promise((e=>{this._refreshResolve=e})),this._authChanged("unauthenticated")),this._refreshPromise}getAuthData(){return{authToken:this._authToken,apiKey:this._apiKey}}getAuth(){return c(this,void 0,void 0,(function*(){return Promise.resolve(this.getAuthData())}))}isAuthorizedURL(e){const t=a.getDomainFromURL(e);return this._authenticationAllowList.includes(t)}logout(){l("logout"),this._apiKey=void 0,this._authToken=void 0,!1===this._pendingAuth&&(this._pendingAuth=!0,this._authChanged("unauthenticated"))}applyAuthHeaders(e,t){const r={"x-api-key":void 0,authorization:void 0};return this.isAuthorizedURL(e)&&(null!==t["x-api-key"]&&this.apiKey&&(r["x-api-key"]=this.apiKey),null!==t.authorization&&this.authToken&&(r.authorization=(this.authTokenScheme?`${this.authTokenScheme} `:"")+this.authToken)),a.pruneUndefined(Object.assign(Object.assign({},t),r))}}const u=12e4,p=36e5,_=n.newDebug("dcx:http:xhr");let f;if(f="undefined"!=typeof window?window.XMLHttpRequest:XMLHttpRequest,null==f)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_STATE,"XMLHttpRequest module not found.");const m={NO_ERROR:"",ABORTED:o.ErrorCodes.ABORTED,NETWORK:o.ErrorCodes.NETWORK_ERROR,TIMEOUT:o.ErrorCodes.TIMED_OUT,TOO_MANY_REDIRECTS:o.ErrorCodes.TOO_MANY_REDIRECTS,INSECURE_REDIRECT:o.ErrorCodes.INSECURE_REDIRECT};class g{constructor(e={}){this._autoParseJson=!1,this._bytesReported=0,this._errorCode=m.NO_ERROR,this._isFetchRequest=!1,this._fetchAbort=()=>{},this._preferFetch=!1,this._sent=!1,this.headers={},this.responseType="text",this._progressListeners=[];const{forceXhr:t,preCallback:s,postCallback:n,timeout:i,preferFetch:a}=e;this._preCallback=s,this._postCallback=n,this._timeout=null==i||i<0?u:i,this._xhr=t?new t:new f,this._xhr.timeout=p,this._preferFetch=!0===a,this._fetch=e.fetch?e.fetch:"undefined"!=typeof window&&"fetch"in window&&"function"==typeof window.fetch?window.fetch.bind(window):"undefined"!=typeof self&&"fetch"in self&&"function"==typeof self.fetch?self.fetch.bind(self):void 0!==r.g&&"fetch"in r.g&&"function"==typeof r.g.fetch?r.g.fetch.bind(r.g):void 0,this._parseFetchResponse=this._parseFetchResponse.bind(this),this.onProgress=this.onProgress.bind(this),this._autoParseJson=null==e.autoParseJson||e.autoParseJson,e.additionalNodeOptions&&this._xhr.setNodeOptions&&this._xhr.setNodeOptions(e.additionalNodeOptions),this._promise=new Promise((e=>{this._resolve=e,this._xhr.addEventListener("abort",(()=>{_("aborted",this._errorCode,this._timeout),this._errorCode=this._errorCode||m.ABORTED,this._finalize()})),this._xhr.addEventListener("error",(e=>{switch(_("err",this._errorCode,e,this._xhr.status,this._timeout),this._underlyingError=e,e?e.code:void 0){case"ERR_FR_TOO_MANY_REDIRECTS":this._errorCode=m.TOO_MANY_REDIRECTS;break;case o.AdobeDCXError.INSECURE_REDIRECT:this._errorCode=m.INSECURE_REDIRECT;break;case m.TIMEOUT:this._errorCode=m.TIMEOUT;break;default:this._errorCode=m.NETWORK}this._finalize()})),this._xhr.addEventListener("load",(()=>{_("load"),this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._estimatedTotalBytes,this._estimatedTotalBytes,!1),this._finalize()})),this._xhr.addEventListener("timeout",(()=>{_("timeout",p),this._errorCode=m.TIMEOUT,this._finalize()}))}))}get xhr(){return this._xhr}_parseFetchResponse(e){return c(this,void 0,void 0,(function*(){if(204===e.status)return e;if("chunked"===e.headers.get("transfer-encoding")||parseInt(e.headers.get("content-length")||"0")>0)switch(this.responseType){case"json":a.isJsonContentType(e.headers.get("content-type")||"")&&(this._fetchBodyAsResponseType=yield e.json());break;case"arraybuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer();break;case"blob":this._fetchBodyAsResponseType=yield e.blob();break;case"text":this._fetchBodyAsResponseType=yield e.text();break;case"void":break;case"buffer":case"defaultbuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer().then((e=>new Uint8Array(e)))}return"stream"===this.responseType&&(this._fetchBodyAsResponseType=e.body),e}))}_shouldAutoParseResponse(){const e=this._errorCode===m.NO_ERROR&&this._sent&&!this._isFetchRequest&&"text"===this._xhr.responseType&&this._autoParseJson&&"string"==typeof this._xhr.response&&this._xhr.response.length<102400&&a.isJsonContentType(this.getResponseHeader("content-type"));return _("_shouldAutoParseResponse()",e),e}_fetchWithTimeout(e,t={}){if("function"!=typeof this._fetch)throw new o.DCXError(o.DCXError.UNEXPECTED,"fetch method not found but was invoked");const{timeout:r}=t,s=function(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}(t,["timeout"]);this._isFetchRequest=!0;const n=e=>()=>{this._errorCode=this._errorCode||m.TIMEOUT,e(new o.DCXError(o.DCXError.TIMED_OUT,"request aborted due to timeout")),this._finalize()};if("function"!=typeof AbortController)return new Promise(((t,o)=>c(this,void 0,void 0,(function*(){this._timeoutTimeout=setTimeout(n(o),r);const i=yield this._fetch(e,s);return clearTimeout(this._timeoutTimeout),this._parseFetchResponse(i).then(t)})))).finally((()=>{clearTimeout(this._timeoutTimeout)}));const i=new AbortController;return this._timeoutTimeout=setTimeout(n(i.abort.bind(i)),r),this._fetchAbort=()=>{this._errorCode=this._errorCode||m.ABORTED,i.abort(),this._finalize()},new Promise(((t,r)=>{this._fetch(e,Object.assign({signal:i.signal},s)).then((e=>(clearTimeout(this._timeoutTimeout),this._parseFetchResponse(e)))).then(t).catch((e=>{clearTimeout(this._timeoutTimeout),r(e)}))}))}_finalize(){if(_("_finalize",this._xhr.status,this._errorCode),this._shouldAutoParseResponse())try{const e=JSON.parse(this._xhr.response);this._autoParsedResponse=e,this._xhr.responseType="json"}catch(e){}this._postCallback&&this._postCallback(this),this._timeoutTimeout&&clearTimeout(this._timeoutTimeout),this._progressListeners=[],this._resolve(this)}_validateResponseType(e){if("buffer"===e){if("function"!=typeof s)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===e){if("function"!=typeof Blob)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Blob class")}else if("text"!==e&&"json"!==e&&"arraybuffer"!==e&&"stream"!==e)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Unsupported response type");return e.toLowerCase()}inactivityTimer(){this._timeoutTimeout&&clearTimeout(this._timeoutTimeout),this._timeoutTimeout=setTimeout((()=>{this.timedOut()}),this._timeout)}send(e,t,r,s={},n="text",i={}){if(_("send"),this._sent)throw new Error("Xhr already sent");this.href=e,this.method=t.toUpperCase(),this.body=r,this.body?this._estimatedTotalBytes=this.body.byteLength||this.body.length||this.body.size:this._estimatedTotalBytes=Number.MAX_SAFE_INTEGER;const d=e=>{var t;_(`progress ${e.loaded}/${e.total}`),this._bytesReported=e.loaded,this.inactivityTimer(),e.lengthComputable?(this._estimatedTotalBytes=e.total,this._notifyProgressListeners(this._bytesReported,null!==(t=this._estimatedTotalBytes)&&void 0!==t?t:1/0,!1)):this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._bytesReported,this._estimatedTotalBytes||e.total,!0)};["POST","PUT","PATCH"].includes(this.method)&&this._xhr.upload?this._xhr.upload.onprogress=d:this._xhr.addEventListener("progress",d),this._timeout=i.timeout||this._timeout||u,_("setting timeout",this._timeout),this._xhr.timeout=p,n&&(n=this._validateResponseType(n),_("responseType: ",n),this.responseType="buffer"===n?"arraybuffer":"stream"===n?"stream":"void"===n?"text":n);const c=a.normalizeHeaders(s);if(this.headers=c,this.href.startsWith("http:")&&null!==this.headers.authorization)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Must not send auth token over unsecured connection");if(this._preCallback&&this._preCallback(this),(this._preferFetch||"stream"===n)&&"function"==typeof this._fetch)return this._xhr.responseType=this.responseType,this._promise=new Promise(((e,t)=>{this._resolve=e,this._fetchWithTimeout(this.href,{body:["GET","HEAD"].includes(this.method.toUpperCase())?void 0:r,credentials:i.withCredentials?"include":void 0,headers:c,method:this.method,timeout:this._timeout}).then((e=>{this._fetchResponse=e,this._finalize()})).catch((e=>{t(e)})),this._sent=!0})),this._promise;this._xhr.open(this.method,this.href,!0),this._xhr.responseType=this.responseType;for(const[e,t]of Object.entries(c))this._xhr.setRequestHeader(e,t);return null!=i.withCredentials&&(this._xhr.withCredentials=i.withCredentials),this.inactivityTimer(),null!=r?this._xhr.send(r):this._xhr.send(),this._sent=!0,this._promise}abort(){if(_("abort()"),!this._sent)throw new Error("Cannot abort before sending.");this._isFetchRequest?this._fetchAbort():this._xhr.abort()}timedOut(){if(_("timedOut()"),!this._sent)throw new Error("Cannot timed out before sending.");this._isFetchRequest||(this._xhr.abort(),this._errorCode=m.TIMEOUT,this._finalize())}getResponseHeader(e){if(!this._sent)throw new Error("Cannot getResponseHeader before sending.");const t=e.toLowerCase(),r=this.getAllResponseHeaders();if(t in r)return r[t]}getAllResponseHeaders(){var e,t;if(!this._sent)throw new Error("Cannot getAllResponseHeaders before sending.");if(this._parsedResponseHeaders)return this._parsedResponseHeaders;const r=this._isFetchRequest?a.objectFromEntries(null!==(t=null===(e=this._fetchResponse)||void 0===e?void 0:e.headers.entries())&&void 0!==t?t:[]):this._xhr.getAllResponseHeaders();return this._parsedResponseHeaders="string"==typeof r?a.parseHeaders(r):a.normalizeHeaders(r),this._parsedResponseHeaders}isError(){if(!this._sent)throw new Error("Cannot check isError before sending.");return this._errorCode!==m.NO_ERROR}isAborted(){if(!this._sent)throw new Error("Cannot check isAborted before sending.");return this._errorCode===m.ABORTED}isTimedOut(){if(!this._sent)throw new Error("Cannot check isTimedOut before sending.");return this._errorCode===m.TIMEOUT}isSent(){return this._sent}getErrorCode(){return this._errorCode}getStatus(){if(!this._sent)throw new Error("Cannot getStatus before sending.");return this._fetchResponse?this._fetchResponse.status:this._xhr.status}getResponse(){var e;if(!this._sent)throw new Error("Cannot getResponse before sending.");return this._response||(this._response={statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._isFetchRequest?(null===(e=this._fetchResponse)||void 0===e?void 0:e.statusText)||"":this._xhr.statusText,xhr:this},this._autoParsedResponse&&(this._response.originalResponseData=this._xhr.response)),this._response}toJSON(){return{statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._xhr.statusText}}getResponseDataAsJSON(){return c(this,void 0,void 0,(function*(){try{if(this._fetchResponse)return yield this._fetchResponse.json();if(this._autoParsedResponse)return this._autoParsedResponse;if("json"===this._xhr.responseType){if("string"==typeof this._xhr.response)return JSON.parse(this._xhr.response);if(null===this.xhr.response&&["application/problem+json","application/json"].includes(this.xhr.getResponseHeader("content-type")))throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type");return this.xhr.response}let e=this._xhr.response;if("text"===this._xhr.responseType&&null!==this._xhr.responseText)e=this._xhr.responseText;else if("arraybuffer"===this._xhr.responseType)e=a.arrayBufferToString(this._xhr.response);else{if("blob"===this._xhr.responseType&&(e instanceof Blob||a.isAnyFunction(e.text)))return JSON.parse(yield e.text());"stream"===this.responseType?yield new Promise(((t,r)=>{if(e="","function"==typeof this.xhr.response.on)return this.xhr.response.on("data",(t=>{e+=t})),this.xhr.response.on("end",t),void this.xhr.response.on("error",r);if("string"==typeof this.xhr.response)return t(e=this.xhr.response);throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type")})):e=this._xhr.responseText?this._xhr.responseText:e}return"string"==typeof e?JSON.parse(e):e}catch(e){throw new o.DCXError(o.DCXError.INVALID_JSON,"Could not parse response as JSON",e,this.toJSON())}}))}getResponseData(){if(!this._sent)throw new Error("Cannot getResponseData before sending.");return this._isFetchRequest&&this._fetchBodyAsResponseType?this._fetchBodyAsResponseType:this._autoParsedResponse||this._xhr.response}onProgress(e){const t=this._progressListeners.push(e)-1;return()=>{try{delete this._progressListeners[t]}catch(e){}}}_notifyProgressListeners(e,t,r){this._progressListeners.map((s=>s&&s.call&&s.call(null,e,t,r)))}}const E=n.newDebug("dcx:http:backoff");function A(e,t,r,s={},i,d={},l=!1){const{disableRetry:h=!1,retryNetworkError:u=!0,responseType:p="text",authCallback:_=null,progressListeners:f=[],initialWait:A=2e3,maxWait:y=32e3,preCallback:D,postCallback:C,preScheduleCallback:I,postScheduleCallback:v,preferRetryAfterHeader:T=!0,pollCodes:b=[],pollHeader:P,pollMethod:R="get",problemWithCode:w={problemType:"",code:null,url:""},modifyHeadersCallback:O=null,skipPollingTimeout:S=!1}=d;let{retryCodes:k=[],timeoutAfter:N=72e3}=d;k=l?[...b,...k]:h||a.isReadableStream(r)?[]:d.retryCodes||a.DEFAULT_RETRY_CODES,E("retry codes",k);const L=d.increase||((e,t,r)=>1===e?r:t*t>y?y:t*t);let M=0,X=0,x=!1;const B=a.now();let j,U,V,H,F=a.now(),Y=0,W=!1,z=!1;const G=[];let q;function K(){E("getSnapshot()",x,M,a.now(),F,Y);const e=x||null!=j?0:M-(a.now()-F);let t=Y;t+=x?a.now()-F:0;const r=(j||a.now())-B;return{count:X,canceled:W,timedOut:z,requests:G,duration:r,totalWaited:t,requestPending:x,waitingFor:e}}function $(){const e=L(X,M,A);return Math.min(e,y)}function J(e){if(e)return t=>e(t,K())}function Z(e){const t=e.getResponseHeader("retry-after");if(T&&t){if(isNaN(t)){const e=Date.parse(t)-Date.now();return E("nextWait from retry-after",e),e<0?$():e}return 1e3*parseInt(e.getResponseHeader("retry-after"))}}function Q(h=M){return c(this,void 0,void 0,(function*(){if(Y>=N){if(E("timed out",Y,N),!a.checkRetriable(H.getStatus(),b))return z=!0,U(H);if(!S)return z=!0,V(new o.DCXError(o.AdobeDCXError.TIMED_OUT,"DCX backoff timed out",void 0,H.getResponse()))}F=a.now(),I&&(yield I(K())),E("retry in ",h),q=setTimeout((()=>{var m;try{E("retry start"),n.log(`Request: ${t.toUpperCase()} ${e} ${null!==(m=null==s?void 0:s["x-request-id"])&&void 0!==m?m:""}`),x=!0,Y+=h,H=new g(Object.assign(Object.assign({},d),{timeout:i,preCallback:J(D),postCallback:J(C)})),G.push(H),X++;for(const e of f)H.onProgress(e);H.send(e,t,r,s,p).then((i=>c(this,void 0,void 0,(function*(){var d,c,h;if(n.log(`Response: ${t.toUpperCase()} ${e} ${null===(d=i.headers)||void 0===d?void 0:d["x-request-id"]} ${i.getStatus()}`),x=!1,!i.isError()&&!a.checkRetriable(i.getStatus(),k)&&(401!==i.getStatus()||null==_)&&("string"!=typeof P||null==b||!a.checkRetriable(i.getStatus(),b))||(null==w?void 0:w.code)===i.getStatus()&&i.getResponseData()&&(null==w?void 0:w.problemType)!==(null===(c=yield i.getResponseDataAsJSON())||void 0===c?void 0:c.type))return j=a.now(),U(i);if(i.isAborted()||W)return j=a.now(),W=!0,U(i);if(!l&&"string"==typeof P&&null!=b&&a.checkRetriable(i.getStatus(),b)){const o=i.getResponseHeader(P.toLowerCase()),n=w.url,a=n&&w.code===i.getStatus()&&w.problemType===(null===(h=i.getResponseData())||void 0===h?void 0:h.type);if(o||a){l=!0,e=a?n:o,t=R,r=void 0,O&&(s=O(s)),k=[...k,...b],Y=0,N*=20;const d=i.getResponseHeader("retry-after");if(T&&d){const e=Z(i);if(null!=e)return M=e,Q(M)}return Q(0)}}if(401===i.getStatus()){if(_){try{s=yield _(e,s)}catch(e){return V(new o.DCXError(o.DCXError.UNAUTHORIZED,"Authentication Failed",i))}return Y+=a.now()-F,Q(0)}return j=a.now(),V(new o.DCXError(o.DCXError.UNAUTHORIZED,"Authentication Failed",i))}if(a.checkRetriable(i.getStatus(),k)||u&&i.getErrorCode()===o.ErrorCodes.NETWORK_ERROR){const e=i.getResponseHeader("retry-after");if(T&&e){const e=Z(i);if(null!=e)return M=e,Q(M)}return M=$(),Q(M)}return j=a.now(),U(i)})))).catch((e=>{V(e)}))}catch(e){V(e)}}),h),v&&(yield v(K()))}))}const ee=new Promise(((e,t)=>{U=e,V=t,Q(0)}));return{getPromise:()=>ee,cancel:function(){E("cancel()"),W=!0,null!=H&&H.abort(),x||(E("abort"),clearTimeout(q),U({getErrorCode:()=>m.ABORTED}))},onProgress:function(e){if(!f.includes(e))return f.push(e),null!=H?H.onProgress&&H.onProgress(e):void 0},getSnapshot:K}}class y{constructor(e,t,r,s,o="text",n,i,a={}){const{descriptor:d}=a;delete a.descriptor;const{cancel:c,getPromise:l,onProgress:h,getSnapshot:u}=A(e,t,r,s,a.timeout,Object.assign(Object.assign(Object.assign(Object.assign({},a),{responseType:o,authCallback:i}),a.retryOptions),{descriptor:d,forceXhr:a.forceXhr,autoParseJson:a.autoParseJson}));this.onProgress=h,"function"==typeof n&&h(((e,t)=>n("progress",{total:t,sentOrReceived:e}))),this._cancel=c,this._promise=l(),this._getSnapshot=u}getSnapshot(){return this._getSnapshot()}getPromise(){return this._promise}cancel(e){this._cancel(e)}}const D=n.newDebug("dcx:http:req");class C{constructor(e){var t;if(this._pausable=!1,this._listeners={progress:[],cancel:[]},this._isStatusValid=e.isStatusValid||o._defaultStatusValidator,this._isExternalRequest=e.isExternalRequest,this._authProvider=e.authProvider,this._id=e.id,this._descriptor=e.descriptor,e.descriptor&&e.descriptor.progress){const t=e.descriptor.progress;this.on("progress",(({sentOrReceived:e,total:r})=>{t.call(void 0,e,r)}))}const r=this._authProvider.applyAuthHeaders(e.url,a.normalizeHeaders(e.headers||{}));this._isExternalRequest&&C._internalOnlyHeaders.forEach((e=>delete r[e])),this._networkRequest=new y(e.url,e.method,e.body,r,e.responseType,(null===(t=e.descriptor)||void 0===t?void 0:t.progress)?this._emit.bind(this):void 0,this._getAuthCb(),e),this._promise=this._networkRequest.getPromise().then((t=>{const r=t.getErrorCode(),s=r||this._isStatusValid(t.getStatus(),t.getResponse());if(r||!0!==s){if(r===m.ABORTED)throw new o.DCXError(o.DCXError.ABORTED,"Aborted");if(r===m.NETWORK)throw new o.DCXError(o.DCXError.NETWORK_ERROR,"Network error",void 0,t.getResponse());if(r===m.TIMEOUT)throw new o.DCXError(o.DCXError.TIMED_OUT,"Timeout",void 0,t.getResponse());if(s instanceof o.DCXError||s instanceof Error)throw new o.DCXError(s.code||o.DCXError.UNEXPECTED_RESPONSE,s._message||s.message,s.underlyingError,t.getResponse());throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,t.getResponse())}const n=this._networkRequest.getSnapshot().requests;return D("resolve",e.id),Object.assign(Object.assign({},t.getResponse()),{xhr:n[n.length-1]})})).catch((t=>{throw D("reject",e.id),t}))}get id(){return this._id}get descriptor(){return this._descriptor}_getAuthCb(){if(!this._authProvider.isNoAuthMode)return this._authCb.bind(this)}_authCb(e,t){return D("_authCb()"),this._authProvider.isAuthorizedURL(e)?this._authProvider.refreshAuth().then((()=>this._authProvider.applyAuthHeaders(e,t))):Promise.reject(new o.DCXError(o.DCXError.UNAUTHORIZED,"URL is not part of authenticationAllowList.",void 0,void 0,{url:e}))}_emit(e,t){this._listeners[e].map((e=>e.call(null,t)))}getPromise(){return this._promise}cancel(e){return this._networkRequest.cancel(e)}on(e,t){var r;"progress"===e&&0===this._listeners[e].length&&(null===(r=this._networkRequest)||void 0===r||r.onProgress(((t,r)=>this._emit(e,{total:r,sentOrReceived:t})))),this._listeners[e].push(t)}}C._internalOnlyHeaders=["x-request-id","x-api-key","authorization"];const I=n.newDebug("dcx:http:map");class v{constructor(){this._map=new Map}addRequest(e,t){return I("addRequest()",e),this._map.set(e,t),t.getPromise().then((t=>{I("then",e),this._map.delete(e)})).catch((t=>{I("catch",e,t),this._map.delete(e)})),e}get(e){return this._map.get(e)}get length(){return this._map.size}has(e){return this._map.has(e)}removeById(e){const t=this._map.get(e);t&&this.remove(t)}remove(e,t){return e&&e.cancel&&e.cancel(t)}clear(e){this._map.forEach((t=>{this.remove(t,e)})),this._map.clear()}removeAllWithToken(e){this._map.forEach((t=>{t.descriptor.token===e&&this.remove(t)}))}}const T=n.newDebug("dcx:http:q"),b=e=>"head"===e.method.toLowerCase();class P{constructor(){this._queue=[],this._later={},this._headEndPtr=0,this._isPriority=b,this._usePriority=!1}push(e,t,r){return c(this,void 0,void 0,(function*(){let s;const o=new Promise((e=>{s=e}));if("number"!=typeof t||t<=0){const t={descriptor:e,notifySent:e=>s(e),notifyCanceled:this._notifyCanceled(s)};return this._push(t),o}const{id:n}=e,i=setTimeout((()=>{this._ready(n)}),t),a=e=>s(e);return this._later[n]={readyTimeout:i,wait:t,descriptor:e,notifySent:a,notifyCanceled:this._notifyCanceled(s),notifyReady:()=>{r&&r.call(null,{wait:t,descriptor:e,notifySent:a})}},o}))}_notifyCanceled(e){return t=>{if(!t)return e({canceled:!0});e({canceled:!0,error:t})}}_push(e){this._usePriority&&this._isPriority(e.descriptor)?this._queue.splice(this._headEndPtr++,0,e):this._queue.push(e)}remove(e){if(e.id in this._later)return T("remove from later",e.id),this._remove(e.id);const t=this._indexOf(e);return T("remove from q",t),t>=0?this._remove(t):void 0}_remove(e,t){if(T("_remove",e),"string"==typeof e){const r=this._later[e];return r.notifyCanceled.call(null,t),r.readyTimeout&&clearTimeout(r.readyTimeout),void delete this._later[e]}this._queue[e].notifyCanceled.call(null,t),this._queue.splice(e,1),e<this._headEndPtr&&this._headEndPtr--}_indexOf(e){const t=!!e.method,r=t&&this._usePriority&&this._isPriority(e),s=r?this._headEndPtr:this._queue.length,o=r||!t?0:this._headEndPtr;for(let t=o;t<o+s;t++)if(e.id===this._queue[t].descriptor.id)return t;return-1}exists(e){return e.id in this._later||this._indexOf(e)>=0}_ready(e){const t=this._later[e],r=t.notifyReady;delete this._later[e],delete t.notifyReady,delete t.readyTimeout,delete t.wait,this._push(t),"function"==typeof r&&r.call(null)}pop(){const e=this._queue.shift();return this._headEndPtr>0&&this._headEndPtr--,e}get length(){return T("length: ",this._queue.length,Object.keys(this._later).length),this._queue.length+Object.keys(this._later).length}clear(e){for(let t=this._queue.length-1;t>=0;t--)this._remove(t,e);this._queue=[];const t=Object.keys(this._later);for(const r in t){const s=t[r];this._remove(s,e)}this._later={}}removeAllWithToken(e){for(let t=this._queue.length-1;t>=0;t--)this._queue[t].descriptor.token===e&&this._remove(t);const t=Object.keys(this._later);for(const r in t){const s=t[r];this._later[s].descriptor.token===e&&this._remove(s)}}}const R=n.newDebug("dcx:http:service"),w=3e5,O="link-2023",S="link-header,absolute-base,long-form-rel";class k{constructor(e,t={}){this.name="AdobeHTTPService",this._requestQueue=new P,this._requestsOutstanding=new v,this._authProvider=void 0,this._isActive=!0,this._preferFetch=!1,this._handlesRedirects=!0,this._withCredentials=!1,this._additionalNodeOptions={},this._retryOptions={},this._serviceGuid=a.generateUuid(),this._reqNum=0,this.featureFlags={},e instanceof h||a.isObject(e)&&a.isAnyFunction(e.onChange)?this._authProvider=e:a.isAnyFunction(e)&&(t.useAuthProvider?(this._authProvider=new h(void 0,void 0,e),this._waitingForAuthentication=!0):(this._authProvider=new h(void 0,void 0,(()=>e.call(null,this))),this._waitingForAuthentication=!0)),this._authProvider?this._authProvider.onChange(this._onAuthChange.bind(this)):(this._authProvider=new h,this._authProvider.resume()),this._maxOutstanding=t.maxOutstanding||5,this._withCredentials=t.crossOriginCredentials||!1,this._timeout=null==t.timeout?u:t.timeout,this._preferFetch=!0===t.preferFetch,this._requestIdPrefix=t.requestIdPrefix,t.server&&(this.server=t.server)}get isActive(){return this._isActive}set isActive(e){this._isActive!==e&&(this._isActive=e,e||this._authProvider.logout(),this._checkQueue())}get crossOriginCredentials(){return this._withCredentials}set crossOriginCredentials(e){this._withCredentials=e}get maxOutstanding(){return this._maxOutstanding}set maxOutstanding(e){this._maxOutstanding=e,this._checkQueue()}get handlesRedirects(){return this._handlesRedirects}get server(){return this._server}set server(e){this._server=e&&e.endsWith("/")?e.substr(0,e.length-1):e}_forceXhr(e,t=!1){this._forcedXhr=e,this._handlesRedirects=!t}_useFetchApi(e){this._fetch=e}setAdditionalHeaders(e){this._additionalHeaders=e||{}}setValidateStatus(e){this._isStatusValid=e}setAdditionalNodeOptions(e){this._additionalNodeOptions=e,a.isNode()&&e&&0===e.maxRedirects&&(this._handlesRedirects=!1)}setRetryOptions(e){this._retryOptions=e}set authenticationAllowList(e){this._authProvider.authenticationAllowList=e}get authenticationAllowList(){return this._authProvider.authenticationAllowList}get authProvider(){return this._authProvider}setApiKey(e){this._authProvider.setApiKey(e)}setTimeout(e){this._timeout=e}setAuthToken(e){e?this._authProvider.setAuthToken(e):this._authProvider.logout()}_onAuthChange(e,t){R("_oAC",e);const r=this._waitingForAuthentication;"unauthenticated"===e?this._waitingForAuthentication=!0:(this._waitingForAuthentication=!1,!1!==r&&this._checkQueue())}resume(){this._waitingForAuthentication=!1,this._authProvider.resume(),this._checkQueue()}setRequestHooks(e,t){this._beforeHook=e,this._afterHook=t}invoke(e="GET",t,r={},n,i={},c){var l;R("invoke",e,t,i);let h=(i=i||{}).autoParseJson||!1,u=i.responseType;if(null!=u&&"void"!==u||(h=null==i.autoParseJson||i.autoParseJson,u=i.responseType="text"),"defaultbuffer"===u&&(u=a.isNode()?i.responseType="buffer":i.responseType="arraybuffer"),"buffer"===u){if("function"!=typeof s)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===u){if("function"!=typeof Blob)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Blob class")}else if(u&&"text"!==u&&"json"!==u&&"arraybuffer"!==u&&"stream"!==u)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Unsupported response type: "+u);!a.endPointOf(t)&&this.server&&(t=`${this.server}/${t.startsWith("/")?t.substr(1,t.length):t}`);const p=a.merge({},r,this._additionalHeaders);if(t.startsWith("https://platform-cs")&&!i.skipLinksDirective){const e=p.directive,t=p["link-options"];p.directive=e?`${e},${O}`:O,p["link-options"]=t?`${t},${S}`:S}p["x-request-id"]=[this._requestIdPrefix,this._serviceGuid,p["x-request-id"],""+this._reqNum++].filter((e=>e)).join("."),i.additionalNodeOptions=Object.assign({},this._additionalNodeOptions||{},i.additionalNodeOptions||{}),i.isStatusValid=i.isStatusValid||this._isStatusValid,i.retryOptions=Object.assign({},this._retryOptions||{},i.retryOptions||{});let _={method:e,href:t,headers:p,token:void 0,body:n,options:i,progress:null===(l=i.reuseRequestDesc)||void 0===l?void 0:l.progress,autoParseJson:h},f=i.reuseRequestDesc;f&&f instanceof d.default&&"props"in f&&(f=f.props),f&&((this._requestQueue.exists(f)||f.id&&null!=this._requestsOutstanding.get(f.id))&&R("requestDesc still in use"),_=a.merge(f,_)),_.id=_.id||a.generateUuid(),c&&("maxRedirects"in i.additionalNodeOptions&&(i.additionalNodeOptions.maxRedirects=0),i.retryOptions&&0!==Object.keys(i.retryOptions).length||(i.retryOptions={disableRetry:!0}));const m=this._getRequestPromise(_);return m.getPromise().then(this._checkQueue.bind(this)).catch(this._checkQueue.bind(this)),a.isAnyFunction(c)&&(R("invoke - cb"),m.then((e=>{R("invoke - cb - resolve ",e.statusCode);try{c(void 0,e,e.response)}catch(e){console.error("[dcx:http] error in success callback",e,e.stack)}})).catch((e=>{R("invoke - cb - reject: ",e);try{c(e,e.response)}catch(e){console.error("[dcx:http] error in failure callback",e,e.stack)}}))),this._checkQueue(),m}_makeRequest(e){R("_makeRequest(): ",e.id);const t=e.options||{},r=(e=>new C(e))(a.pruneUndefined(Object.assign(Object.assign({url:e.href,autoParseJson:e.autoParseJson,descriptor:e},e),{timeout:t.timeout||this._timeout,authProvider:this._authProvider,forceXhr:this._forcedXhr,fetch:this._fetch,responseType:t.responseType,preCallback:this._beforeHook,postCallback:this._afterHook,isStatusValid:t.isStatusValid,additionalNodeOptions:t.additionalNodeOptions,retryOptions:t.retryOptions,isExternalRequest:t.isExternalRequest,preferFetch:this._preferFetch})));return this._requestsOutstanding.addRequest(e.id,r),e.startTime=(new Date).valueOf(),r}_checkQueue(){queueMicrotask(this._checkQueueLoop.bind(this))}_checkQueueLoop(){if(R("_checkQueueLoop()",this._waitingForAuthentication,this.isActive,this._requestsOutstanding.length,"<?",this.maxOutstanding),!this._isActive){R("_cQL inactive");const e=new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state");this._requestsOutstanding.clear(e),this._requestQueue.clear(e)}let e=!0;for(;e&&!this._waitingForAuthentication&&this._requestsOutstanding.length<this.maxOutstanding&&(e=this._requestQueue.pop(),null!=e);){const t=this._makeRequest(e.descriptor);e.notifySent(t)}R("_cQL done")}_getRequestPromise(e){return R("_getRequestPromise()"),new d.default(((t,r,s)=>{if(!this._isActive)return R("_gRP inactive"),r(new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state"));s((()=>{R("_gRP cancel 1",e.id),this._requestQueue.remove(e)}));let n=e.noSoonerThen||null;return n&&(n-=a.now(),n=n<0?0:n>w?w:n),delete e.noSoonerThen,this._requestQueue.push(e,n,this._checkQueue.bind(this)).then((n=>(R("_gRP sent",e.id),n.canceled?(R("_gRP reject 1: ",e.id),r(new o.DCXError(o.DCXError.ABORTED,"Request aborted",n.error))):(s((t=>{R("_gRP cancel 2",e.id,t),n.cancel(new o.DCXError(o.DCXError.ABORTED,"Request aborted",t))})),n.getPromise().then((r=>(R("_gRP resolve 1",e.id,r),t(r)))).catch((t=>(R("_gRP reject 2: ",e.id,t),r(t)))))))).catch(r)}),e)}abort(e){e&&e.cancel?e.cancel():this._requestQueue.exists(e)?this._requestQueue.remove(e):this._requestsOutstanding.removeById(e.id)}abortAllWithToken(e){R("abortAllWithToken()"),this._requestsOutstanding.removeAllWithToken(e),this._requestQueue.removeAllWithToken(e)}}const N=k;t.AdobeNetworkHTTPService=N,t.AuthProvider=h,t.HTTPService=k,t.Xhr=g,t.XhrErrorCodes=m,t.createHTTPService=(e,t)=>new k(e,t||{})},617750:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s,o,n,i,a,d=r(436246);function c(e,r,s="css"){var o,n,i;d.validateParams(["data",r,"object"]),d.validateObject(r,"data",["composite","object"],["response","object"],["error","object",!0]);const{component:a,error:c,composite:h,branch:u,derivationType:p,isBlockTransferred:_}=r,f=(null===(o=r.error)||void 0===o?void 0:o.response)||r.response;let m,g=!1;switch(e){case t.AnalyticsEvent.CreateComposite:g=!0,m=t.AnalyticsEventSubCategory.Create;break;case t.AnalyticsEvent.PushComposite:g=!0,m=t.AnalyticsEventSubCategory.Push;break;case t.AnalyticsEvent.PullComposite:g=!0,m=t.AnalyticsEventSubCategory.MinPull;break;case t.AnalyticsEvent.PullCompositeVersion:g=!0,m=t.AnalyticsEventSubCategory.VersionPull;break;case t.AnalyticsEvent.DownloadComponent:case t.AnalyticsEvent.UploadComponent:d.validateParams(["component",a,"object"]),d.validateObject(a,"data.component",["type","string"]),m=e===t.AnalyticsEvent.DownloadComponent?t.AnalyticsEventSubCategory.Download:t.AnalyticsEventSubCategory.Upload;break;default:m=t.AnalyticsEventSubCategory.Unknown}g&&d.validateParams(["branch",u,"object",!0]);const E={"env.com.name":"dcx-js","env.svc.name":s,"env.com.version":"9.16.0","event.request_id":f.headers["x-request-id"],"event.cloud_id":h.assetId,"custom.content.repository_id":h.repositoryId,"event.type":t.AnalyticsEventType.Success,"event.category":t.AnalyticsEventCategory.CompositeXfer,"event.subcategory":m},A=null===(n=null==c?void 0:c.underlyingError)||void 0===n?void 0:n.code,y=null===(i=null==c?void 0:c.underlyingError)||void 0===i?void 0:i.message;return c&&(E["event.error_code"]=c.code,E["event.error_desc"]=c.message,E["dcx.underlying_error_code"]=A,E["dcx.underlying_error_desc"]=y,E["event.type"]=t.AnalyticsEventType.Error),m===t.AnalyticsEventSubCategory.Unknown?l(E):g?(E["dcx.num_total_components"]=null==u?void 0:u.allComponents().length,E["custom.content.xmp_derivation_type"]=p,c&&(E["dcx.root_error_desc"]=y),l(E)):(E["content.mimetype"]=a.type,c&&(E["dcx.block_transferred"]=null!=_&&_,E["content.type"]=a.type,E["content.size"]=a.length,E["dcx.component_rel"]=a.relationship),l(E))}function l(e){const t={};for(const r in e){const s=e[r];d.isUndefined(s)||Array.isArray(s)||d.isObject(s)||(t[r]=s)}return t}t.AnalyticsEventType=void 0,(s=t.AnalyticsEventType||(t.AnalyticsEventType={}))[s.Success=0]="Success",s[s.Error=1]="Error",t.AnalyticsEventCategory=void 0,(o=t.AnalyticsEventCategory||(t.AnalyticsEventCategory={}))[o.CompositeXfer=0]="CompositeXfer",t.AnalyticsEventSubCategory=void 0,(n=t.AnalyticsEventSubCategory||(t.AnalyticsEventSubCategory={}))[n.Push=0]="Push",n[n.MinPull=1]="MinPull",n[n.VersionPull=2]="VersionPull",n[n.Upload=3]="Upload",n[n.Download=4]="Download",n[n.Create=5]="Create",n[n.Unknown=6]="Unknown",t.AnalyticsEvent=void 0,(i=t.AnalyticsEvent||(t.AnalyticsEvent={})).PushComposite="analyticsPush",i.CreateComposite="analyticsCreate",i.PullComposite="analyticsPull",i.PullCompositeVersion="analyticsPullVersion",i.UploadComponent="analyticsUpload",i.DownloadComponent="analyticsDownload",i.All="*",t.LogLevel=void 0,(a=t.LogLevel||(t.LogLevel={}))[a.Deprecated=0]="Deprecated",a[a.Error=1]="Error",a[a.Warn=2]="Warn",a[a.Log=3]="Log",a[a.Debug=4]="Debug";const h={[t.LogLevel.Deprecated]:"error",[t.LogLevel.Error]:"error",[t.LogLevel.Log]:"log",[t.LogLevel.Warn]:"warn",[t.LogLevel.Debug]:"debug"};class u extends d.EventEmitter{constructor(e){super([t.AnalyticsEvent.CreateComposite,t.AnalyticsEvent.UploadComponent,t.AnalyticsEvent.PushComposite,t.AnalyticsEvent.PullComposite,t.AnalyticsEvent.PullCompositeVersion,t.AnalyticsEvent.DownloadComponent]),this._logLevel=t.LogLevel.Warn,this._prevDebugTime=d.now(),this._debugFormatter=(e,t,r,s)=>`[${e} (+${(1e3*(t-r)).toFixed(0)})] ${s.map((e=>"string"==typeof e?e:JSON.stringify(e))).join(" ")}`,this._debugNamespaces=[],this._debugSkips=[],this.suppressDeprecationWarnings=!1,e&&(this._logCallback=e),this._initNamespaces()}get debugNamespaces(){return this._debugNamespaces}get debugSkips(){return this._debugSkips}set logLevel(e){if(!Object.values(t.LogLevel).includes(e))throw new Error(`Invalid LogLevel, must be one of: ${Object.values(t.LogLevel).join(", ")}.`);this._logLevel=e}get logLevel(){return this._logLevel}on(e,r){if(e!==t.AnalyticsEvent.All)return super.on(e,r);const s=Object.values(t.AnalyticsEvent);let o;for(let e=0,t=s.length;e<t;e++){const t=s[e];o=super.on(t,r)}return o}static getInstance(){return null==u._instance&&(u._instance=new u),u._instance}static newLogger(e){return new u(e)}set logCallback(e){this._logCallback=e}get logCallback(){return this._logCallback}_initNamespaces(){d.isNode()?this.setDebugNamespaces(process.env.DCX_DEBUG||""):d.isObject(globalThis)&&d.isObject(globalThis.dcxjs)&&this.setDebugNamespaces(globalThis.dcxjs.debug||""),this._debugNamespaces.length>0&&(this._logLevel=t.LogLevel.Debug)}_log(e,r,s){try{if(e===u.LEVEL_DEPRECATED)!this.suppressDeprecationWarnings&&this._logLevel>=e&&console.warn(...s);else if("function"==typeof this._logCallback&&this._logLevel>=e)this._logCallback.call(void 0,...s);else if(this._logLevel>=e)if(e===t.LogLevel.Debug){if(this._debugEnabled(r)){const e=this._prevDebugTime;this._prevDebugTime=d.now(),(console.debug||console.log)(this._debugFormatter(r,this._prevDebugTime,e,s))}}else console[h[e]](...s.slice(0,-2))}catch(e){}}log(...e){this._log(t.LogLevel.Log,void 0,e)}warn(...e){this._log(t.LogLevel.Warn,void 0,e)}error(...e){this._log(t.LogLevel.Error,void 0,e)}deprecated(...e){this._log(t.LogLevel.Deprecated,void 0,e)}_debugEnabled(e){if("*"===e[e.length-1])return!0;let t,r;for(t=0,r=this._debugSkips.length;t<r;t++)if(this._debugSkips[t].test(e))return!1;for(t=0,r=this._debugNamespaces.length;t<r;t++)if(this._debugNamespaces[t].test(e))return!0;return!1}setDebugFormatter(e){this._debugFormatter=e}setDebugNamespaces(e){let t;this._debugNamespaces=[],this._debugSkips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(t=0;t<s;t++)r[t]&&("-"===(e=r[t].replace(/\*/g,".*?"))[0]?this._debugSkips.push(new RegExp("^"+e.substr(1)+"$")):this._debugNamespaces.push(new RegExp("^"+e+"$")))}Debug(e){return(...r)=>{this._log(t.LogLevel.Debug,e,r)}}}u.LEVEL_DEBUG=t.LogLevel.Debug,u.LEVEL_LOG=t.LogLevel.Log,u.LEVEL_WARN=t.LogLevel.Warn,u.LEVEL_ERROR=t.LogLevel.Error,u.LEVEL_DEPRECATED=t.LogLevel.Deprecated;const p=()=>{const e=_();return void 0!==e._logCallback?e:u.getInstance()},_=()=>{if("object"==typeof globalThis&&"object"==typeof globalThis.dcxjs&&globalThis.dcxjs.logger&&globalThis.dcxjs.logger.getInstance)return globalThis.dcxjs.logger.getInstance();const e=()=>{};return{log:e,warn:e,error:e,deprecated:e,debug:e,newLogger:_}};var f=p();t.AdobeDCXLogger=u,t.default=f,t.emitAnalyticsEvent=(e,t)=>{const r=p(),s=c(e,t);try{r.emit(e,[s])}catch(e){const t=e instanceof Error?e.message:"Unknown Error";r.error("Error in analytics hook: ",t)}},t.getGlobalLogger=_,t.getGlobalOrLocalLogger=p,t.log=(...e)=>{const t=p();e.forEach(t.log.bind(t))},t.makeAnalyticsEvent=c,t.newDebug=e=>p().Debug(e),t.setLogCallback=e=>{p().logCallback=e}},323:(e,t,r)=>{var s=void 0!==r.g?r.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function o(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}var i=o,a=n;function d(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}"function"==typeof s.setTimeout&&(i=setTimeout),"function"==typeof s.clearTimeout&&(a=clearTimeout);var c,l=[],h=!1,u=-1;function p(){h&&c&&(h=!1,c.length?l=c.concat(l):u=-1,l.length&&_())}function _(){if(!h){var e=d(p);h=!0;for(var t=l.length;t;){for(c=l,l=[];++u<t;)c&&c[u].run();u=-1,t=l.length}c=null,h=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===n||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function f(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];l.push(new m(e,t)),1!==l.length||h||d(_)}function m(e,t){this.fun=e,this.array=t}function g(){}m.prototype.run=function(){this.fun.apply(null,this.array)};var E=g,A=g,y=g,D=g,C=g,I=g,v=g,T=s.performance||{},b=T.now||T.mozNow||T.msNow||T.oNow||T.webkitNow||function(){return(new Date).getTime()},P=new Date,R={nextTick:f,title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:E,addListener:A,once:y,off:D,removeListener:C,removeAllListeners:I,emit:v,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*b.call(T),r=Math.floor(t),s=Math.floor(t%1*1e9);return e&&(r-=e[0],(s-=e[1])<0&&(r--,s+=1e9)),[r,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-P)/1e3}},w="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==r.g?r.g:"undefined"!=typeof self?self:{};var O,S,k=(O=function(e,t){e.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},r=0,s=void 0,o=void 0,n=function(e,t){u[r]=e,u[r+1]=t,2===(r+=2)&&(o?o(p):_())};var i="undefined"!=typeof window?window:void 0,a=i||{},d=a.MutationObserver||a.WebKitMutationObserver,c="undefined"==typeof self&&void 0!==R&&"[object process]"==={}.toString.call(R),l="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function h(){var e=setTimeout;return function(){return e(p,1)}}var u=new Array(1e3);function p(){for(var e=0;e<r;e+=2)(0,u[e])(u[e+1]),u[e]=void 0,u[e+1]=void 0;r=0}var _=void 0;function m(e,t){var r=this,s=new this.constructor(A);void 0===s[E]&&k(s);var o=r._state;if(o){var i=arguments[o-1];n((function(){return O(o,s,i,r._result)}))}else b(r,s,e,t);return s}function g(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(A);return C(t,e),t}_=c?function(){return f(p)}:d?function(){var e=0,t=new d(p),r=document.createTextNode("");return t.observe(r,{characterData:!0}),function(){r.data=e=++e%2}}():l?function(){var e=new MessageChannel;return e.port1.onmessage=p,function(){return e.port2.postMessage(0)}}():void 0===i?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(p)}:h()}catch(e){return h()}}():h();var E=Math.random().toString(36).substring(2);function A(){}var y=void 0;function D(t,r,s){r.constructor===t.constructor&&s===m&&r.constructor.resolve===g?function(e,t){1===t._state?v(e,t._result):2===t._state?T(e,t._result):b(t,void 0,(function(t){return C(e,t)}),(function(t){return T(e,t)}))}(t,r):void 0===s?v(t,r):e(s)?function(e,t,r){n((function(e){var s=!1,o=function(e,t,r,s){try{e.call(t,r,s)}catch(e){return e}}(r,t,(function(r){s||(s=!0,t!==r?C(e,r):v(e,r))}),(function(t){s||(s=!0,T(e,t))}),e._label);!s&&o&&(s=!0,T(e,o))}),e)}(t,r,s):v(t,r)}function C(e,t){if(e===t)T(e,new TypeError("You cannot resolve a promise with itself"));else if(function(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}(t)){var r=void 0;try{r=t.then}catch(t){return void T(e,t)}D(e,t,r)}else v(e,t)}function I(e){e._onerror&&e._onerror(e._result),P(e)}function v(e,t){e._state===y&&(e._result=t,e._state=1,0!==e._subscribers.length&&n(P,e))}function T(e,t){e._state===y&&(e._state=2,e._result=t,n(I,e))}function b(e,t,r,s){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=t,o[i+1]=r,o[i+2]=s,0===i&&e._state&&n(P,e)}function P(e){var t=e._subscribers,r=e._state;if(0!==t.length){for(var s=void 0,o=void 0,n=e._result,i=0;i<t.length;i+=3)s=t[i],o=t[i+r],s?O(r,s,o,n):o(n);e._subscribers.length=0}}function O(t,r,s,o){var n=e(s),i=void 0,a=void 0,d=!0;if(n){try{i=s(o)}catch(t){d=!1,a=t}if(r===i)return void T(r,new TypeError("A promises callback cannot return that same promise."))}else i=o;r._state!==y||(n&&d?C(r,i):!1===d?T(r,a):1===t?v(r,i):2===t&&T(r,i))}var S=0;function k(e){e[E]=S++,e._state=void 0,e._result=void 0,e._subscribers=[]}var N=function(){function e(e,r){this._instanceConstructor=e,this.promise=new e(A),this.promise[E]||k(this.promise),t(r)?(this.length=r.length,this._remaining=r.length,this._result=new Array(this.length),0===this.length?v(this.promise,this._result):(this.length=this.length||0,this._enumerate(r),0===this._remaining&&v(this.promise,this._result))):T(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===y&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var r=this._instanceConstructor,s=r.resolve;if(s===g){var o=void 0,n=void 0,i=!1;try{o=e.then}catch(e){i=!0,n=e}if(o===m&&e._state!==y)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(r===L){var a=new r(A);i?T(a,n):D(a,e,o),this._willSettleAt(a,t)}else this._willSettleAt(new r((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,r){var s=this.promise;s._state===y&&(this._remaining--,2===e?T(s,r):this._result[t]=r),0===this._remaining&&v(s,this._result)},e.prototype._willSettleAt=function(e,t){var r=this;b(e,void 0,(function(e){return r._settledAt(1,t,e)}),(function(e){return r._settledAt(2,t,e)}))},e}();var L=function(){function t(e){this[E]=S++,this._result=this._state=void 0,this._subscribers=[],A!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){C(e,t)}),(function(t){T(e,t)}))}catch(t){T(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var r=this,s=r.constructor;return e(t)?r.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):r.then(t,t)},t}();return L.prototype.then=m,L.all=function(e){return new N(this,e).promise},L.race=function(e){var r=this;return t(e)?new r((function(t,s){for(var o=e.length,n=0;n<o;n++)r.resolve(e[n]).then(t,s)})):new r((function(e,t){return t(new TypeError("You must pass an array to race."))}))},L.resolve=g,L.reject=function(e){var t=new this(A);return T(t,e),t},L._setScheduler=function(e){o=e},L._setAsap=function(e){n=e},L._asap=n,L.polyfill=function(){var e=void 0;if(void 0!==w)e=w;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===r&&!t.cast)return}e.Promise=L},L.Promise=L,L}()},O(S={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&S.path)}},S.exports),S.exports);k.polyfill(),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return this.substr(t||0,e.length)===e})},123e3:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(436246);const o=e=>"[object Function]"===toString.call(e);class n{constructor(e,t){return this._promise=null,this._props={},this._registeredProps=[],this._handlers={cancel:[]},this._done=!1,this._canceled=!1,this._internalKeys=[],this.name="AdobePromise",this._internalKeys=[...Object.keys(this),...Object.keys(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(this))),"_cancelReason"],t&&"object"==typeof t&&this._setProps(t),this._promise=new Promise(((t,r)=>e.call(this,(e=>{this._done||(this._done=!0,t(e))}),(e=>{this._done||(this._done=!0,r(e))}),this._registerCancelHandler.bind(this)))),new Proxy(this,{set:function(e,t,r){if(e._internalKeys.includes(t)){if(!["_promise","_canceled","_cancelReason","_props","_registeredProps"].includes(t))throw new Error("Cannot overwrite internal AdobePromise property.");e[t]=r}else e._registeredProps.includes(t)||e._registeredProps.push(t),e.props[t]=r;return!0},get:function(e,t){return"symbol"==typeof t||e._internalKeys.includes(t)?e[t]:e.props[t]}})}get[Symbol.toStringTag](){return this.name}static reject(e,t){return new i(((t,r)=>Promise.reject(e).catch((e=>{r&&r(e)}))),t)}static resolve(e,t){return new i((t=>{s.isObject(e)&&o(e.then)?e.then((e=>{t(e)})):t(e)}),t)}static allSettled(e,t){return 0===e.length?i.resolve([],t):new i((t=>{const r=[];e.map(((s,o)=>{s.then((e=>{r[o]={status:"fulfilled",value:e}})).catch((e=>{r[o]={status:"rejected",reason:e}})).then((()=>{r.filter((e=>!!e)).length===e.length&&t(r)}))}))}),t)}get canceled(){return this._canceled}getPromise(){return this._promise}_resolveOrReject(e,t){return this._promise.then((r=>this._canceled?t&&t(this._cancelReason):e(r))).catch((e=>t&&t(this._cancelReason||e)))}then(e,t){if(null==e&&null==t)return this;const r=new i(((e,t,r)=>(r&&r((e=>{this.cancel.call(this,e),t&&t(e)})),this._resolveOrReject.call(this,e,t))),this._props);return r._promise=r.getPromise().then((t=>{const s=e&&e(t);if(s instanceof i){const e=s;this.onCancel((t=>e.cancel(t)));for(const t in this.props)null==e.props[t]&&(e.props[t]=this.props[t]);e._setProps(e.props),this._setProps(e.props),r._setProps(e.props)}return s})).catch(t),r}parallel(e,t){return this._promise.then(e,t)}catch(e){return this._promise=this._promise.catch(e),this}finally(e){return this._promise=this._promise.finally(e),this}cancel(e){this._canceled||(this._canceled=!0,this._cancelReason=e,this._callHandlers("cancel",e||new Error("Aborted")))}abort(e){this.cancel(e)}onCancel(e){o(e)&&this._registerCancelHandler(e)}get props(){return this._props}_setProps(e){if(this._props===e)return;this._props=e;const t=[],r=Object.getOwnPropertyDescriptors(i),s=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(e));if(s.constructor.value!==Object)for(const o in s){if(o in r||o in this&&!this._registeredProps.includes(o))continue;t.push(o);const n=s[o],i=Object.assign({},n);delete i.get,delete i.set,(n.get||n.set)&&(delete i.value,delete i.writable,n.get&&(i.get=n.get.bind(e)),n.set&&(i.set=n.set.bind(e))),Object.defineProperty(this,o,i)}for(const s of Object.keys(e))t.push(s),s in r||s in this&&!this._registeredProps.includes(s)||Object.defineProperty(this,s,{get:()=>this._props[s],set:e=>{this._props[s]=e},configurable:!0});return this._registeredProps=t,this}_registerCancelHandler(e){this._handlers.cancel.push(e)}_callHandlers(e,t){this._handlers[e].map((e=>e&&e(t)))}_destroy(){this._handlers.cancel=[]}}const i=n,a=i;t.AdobePromise=a,t.default=i},234230:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(257e3),o=r(413209),n=r(617750),i=r(123e3),a=r(251890),d=r(436246);function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=c(o),h=c(i);function u(e,t,r,s){var o,n=arguments.length,i=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(n<3?o(i):n>3?o(t,r,i):o(t,r))||i);return n>3&&i&&Object.defineProperty(t,r,i),i}class p{constructor(e,t,r,s,o,n){this.id=e,this.etag=t,this.version=r,this.md5=s,this.length=o,this.type=n}}class _{constructor(e,t,r){this.compositeId=e,this.compositeAssetId=t,this.repositoryId=r,this.records={}}addUploadRecord(e,t){d.validateParams(["componentId",e,"string"],["record",t,"object"]),this.records[e]=t}getComponentDescriptor(e){const t=this._checkRAPIComponentParams(e);return JSON.stringify(function(e,t,r,s){try{d.validateObject(s,"UploadRecord",["id","string"],["version","string"],["length","number"],["etag","string"],["type","string"])}catch(e){throw new o.DCXError(o.DCXError.INVALID_STATE,"Invalid record data",e)}const n={versionId:"0",componentId:s.id,cloudAssetId:e,compositeId:t,repositoryId:r,componentRevisionId:s.version,type:s.type,cloudExpiration:void 0,size:s.length,etag:s.etag,hashType:"md5",hashValue:s.md5};return d.pruneUndefined(n)}(this.compositeAssetId,this.compositeId,this.repositoryId,t))}getComponentURL(e,t){const r=this._checkRAPIComponentParams(t);return e.getCompositeComponentUrlForDownload({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,r.length,r.version)}getComponent(e,t,r){const s=this._checkRAPIComponentParams(t);return e.getCompositeComponent({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,s.version,r)}_checkRAPIComponentParams(e){if(!this.repositoryId)throw new o.DCXError(o.DCXError.INVALID_STATE,"Repository ID must be defined.",void 0,void 0,{componentId:e});const t=this.records[e];if(!t)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"UploadRecord does not exist",void 0,void 0,{componentId:e});return t}}function f(e,t,r){return d.validateParams(["compositeId",e,"string",!0],["compositeAssetId",t,"string"],["repositoryId",r,["string","undefined"]]),new _(e,t,r)}function m(e,t,r,s,o,n){return d.validateParams(["componentId",e,"string"],["etag",t,"string"],["version",r,"string"],["md5",s,"string"],["length",o,"number"],["type",n,"string"]),new p(e,t,r,s,o,n)}function g(e,t,r){d.validateParams(["repoUploadResults",t,"object"],["compositeId",r,"string",!0]),d.validateObject(t,"repoUploadResults",["result","object"]);const o=t.asset||t.compositeAsset,{result:n}=t;if(!(o.assetId&&o.repositoryId||o.links||n.links))throw new l.default(l.default.INVALID_PARAMS,"AdobeRepoUploadResult#asset object missing repositoryId or assetId, and links");const i=m(n.id,n.etag,n.revision,n.md5,n.length,n.type);let a;if(o.assetId&&o.repositoryId)a=h.default.resolve(f(r,o.assetId,o.repositoryId));else{d.validateParams(["session",e,"object"]);const t=o.links||n.links,i=s.assertLinksContainAny(t,[s.LinkRelation.PRIMARY,s.LinkRelation.ID,s.LinkRelation.PATH,s.LinkRelation.COMPONENT]),c=d.getLinkHrefTemplated(t,i,{component_id:"manifest"});a=e.headHTTPResource(c).then((e=>{const t=e.headers["repository-id"],s=e.headers["asset-id"];if(!t||!s)throw new l.default(l.default.INVALID_DATA,"Fetched data missing repositoryId or assetId");return f(r,s,t)}))}return a.then((e=>(e.addUploadRecord(n.id,i),e)))}const E=n.newDebug("dcx:repoapisession"),A=n.AdobeDCXLogger.getInstance(),y="+dcx";t.AdobeRepoAPISession=class{constructor(e,t,r){this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._blockUploadThreshold=s.DEFAULT_BLOCK_UPLOAD_THRESHOLD,d.validateParams(["httpService",e,"object"],["server",t,"string"]),this._service=e,this._service._repoAPIBaseUrl=t;const o=d.endPointOf(t);if(!o)throw new l.default(l.default.INVALID_PARAMS,"Could not determine endpoint from: "+t);this._endPoint=o,d.isObject(r)&&d.isAnyFunction(r.getIndexLinks)?this._linksCache=r:this._linksCache=new s.RepositoryLinksCache}get serviceConfig(){return{service:this._service,cache:this._linksCache}}get blockUploadThreshold(){return this._blockUploadThreshold}set blockUploadThreshold(e){d.validateParam("threshold",e,"+number"),this._blockUploadThreshold=e}get blockDownloadThreshold(){return s.getBlockDownloadThreshold()}set blockDownloadThreshold(e){d.validateParam("threshold",e,"+number"),s.setBlockDownloadThreshold(e)}createAsset(e,t,r,o,n,i,a,d,c,l,h){return s.createAsset(this._service,e,t,r,o,n,i,a,d,c,l,h)}createAssetForGuest(e,t,r,o,n,i,a,d,c){return s.createAssetForGuest(this._service,e,t,r,o,n,i,a,d,c)}createComposite(e,t,r,n,i,a,c,h,u,p){if(E("createComposite()"),d.validateParams(["parentDir",e,"object"],["relPath",t,"string"],["contentType",r,"string"]),!r.endsWith(y))throw new l.default(l.default.INVALID_PARAMS,`Composite contentType must end in "${y}"`);if(!s.isMinimalAdobeAsset(e))throw new l.default(l.default.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return this.createAsset(e,t,!0,a&&r.endsWith("dcx")?r+"ucf":r,n,i,a,c,h,u,p).catch((r=>{if(!r.response||409!==r.response.statusCode)throw o.unexpectedResponse("Error creating composite",r,r.response);if(r.response.headers.link||r.response.headers["api-link"]){const t=s.parseLinksFromResponseHeader(r.response);this._linksCache.setValueWithAsset(t,{assetId:r.response.headers["asset-id"]||r.response.headers["x-resource-id"],repositoryId:e.repositoryId})}throw new l.default(l.default.ALREADY_EXISTS,"Composite already exists at "+t,void 0,r.response)}))}copyResources(e,t,r,o,n,i){return s.copyAssetResources(this._service,e,t,r,o,n,i)}getIndexLinks(e){return s.getIndexLinks(this.serviceConfig,e)}getIndexRepository(e){return s.getIndexRepository(this.serviceConfig,e)}getIndexDocument(e){return s.getIndexDocument(this.serviceConfig,e)}getDiscoverableAssets(e={},t){return s.getDiscoverableAssets(this.serviceConfig,e,t)}getDiscoverableRepos(e={},t){return s.getDiscoverableRepos(this.serviceConfig,e,t)}headHTTPResource(e,t){return s.headHTTPResource(this._service,e,t)}headCompositeManifest(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.COMPONENT],t).then((()=>s.headCompositeManifest(this._service,e,t)))}resolveAsset(e,t="id",r,o,n){return s.resolveAsset(this.serviceConfig,e,t,r,o,n)}headPrimaryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],t).then((()=>s.headPrimaryResource(this.serviceConfig,e,t)))}getRepoMetadata(e,t){return e.assetId&&a.setTracingSpanAttribute("assetId",e.assetId),this.useLinkOrResolveResource(e,s.LinkRelation.REPO_METADATA,"json",t).then((e=>({result:s.deserializeAsset(e.response.response),response:e.response})))}updateRepoMetadata(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.REPO_METADATA],t).then((()=>s.updateRepoMetadata(this.serviceConfig.service,e,t)))}getEmbeddedMetadata(e,t="json",r){return d.validateParams(["asset",e,"object"],["format",t,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],r).then((()=>s.getEmbeddedMetadata(this._service,e,t,r)))}putEmbeddedMetadata(e,t,r,o="json",n){return d.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0],["format",o,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],n).then((()=>s.putEmbeddedMetadata(this._service,e,t,r,o,n)))}patchEmbeddedMetadata(e,t,r,o){return d.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],o).then((()=>s.patchEmbeddedMetadata(this._service,e,t,r,o)))}getDirectory(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedChildren(this._service,e,t,r).then((e=>({result:s.directoryTransformer(e.paged.data)[1],paged:e.paged,response:e.response})))))}getDirectoryByURL(e){return s.getDirectoryByURL(this._service,e).then((e=>({response:e.response,result:s.deserializeAsset(e.result)})))}getLinksForAsset(e,t){return s.getLinksForAsset(this.serviceConfig,e,t)}getACLPolicy(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY],t).then((()=>s.getACLPolicy(this._service,e,t)))}getPrimaryResource(e,t,r){const o={};return this._withSourcePromise(o).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],r))).then((()=>s.getPrimaryResource.call(o,this._service,e,t,r)))}updatePrimaryResource(e,t,r,o,n,i,a){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],a).then((()=>s.updatePrimaryResource(this._service,e,t,r,o,n,i,a)))}getRepositoryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.REPOSITORY],t).then((()=>s.getRepositoryResource(this._service,e,t)))}getVersions(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedVersions(this._service,e,t,r).then((e=>({result:s.deserializeVersionSet(e.result),response:e.response,paged:e.paged})))))}getVersionResource(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getVersionResource(this._service,e,t,r).then((e=>({result:s.deserializeVersion(e.result),response:e.response})))))}blockDownloadAsset(e,t,r,o,n,i,a,d){if("string"==typeof e)return s.doBlockDownload(this._service,e,t,r,o,n,i,a,d);const c={};return this._withSourcePromise(c).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY]))).then((()=>s.doBlockDownload.call(c,this._service,e,t,r,o,n,i,a,d)))}fetchLinksIfMissing(e,t,r){return s.fetchLinksIfMissing(this.serviceConfig,e,t,void 0,r)}useLinkOrResolveResource(e,t,r,o){return s.useLinkOrResolveResource(this.serviceConfig,e,t,r,o).then((t=>(e.links!==t.result.links&&(e.links=d.merge(e.links||{},t.result.links),this._linksCache.setValueWithAsset(e.links,e)),t)))}getLinkHrefForAsset(e,t,r="id",s){return this.fetchLinksIfMissing(e,[t],s).then((e=>d.getLinkHref(e,t,r)))}getEffectivePrivileges(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.EFFECTIVE_PRIVILAGES],t).then((()=>s.getEffectivePrivileges(this._service,e,t)))}checkACLPrivilege(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACCESS_CHECK],o).then((()=>s.checkACLPrivilege(this._service,e,t,r,o)))}headAppMetadata(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],t).then((()=>s.headAppMetadata(this.serviceConfig,e,t)))}getAppMetadata(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],r).then((()=>s.getAppMetadata(this._service,e,t,r)))}putAppMetadata(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],o).then((()=>s.putAppMetadata(this._service,e,t,r,o)))}patchAppMetadata(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],o).then((()=>s.patchAppMetadata(this._service,e,t,r,o)))}getCompositeManifestUrl(e,t,r){d.validateParams(["asset",e,"object"],["version",t,"string",!0]);const o=this._getAsAdobeAsset(e);return o.version=t||o.version,this.fetchLinksIfMissing(o,[s.LinkRelation.MANIFEST],r).then((()=>s.getCompositeManifestUrl(this._service,o,t,r)))}getCompositeManifest(e,t,r,o){d.validateParams(["asset",e,"object"],["version",t,"string",!0],["etag",r,"string",!0]);const n=this._getAsAdobeAsset(e);return n.version=t||n.version,this.fetchLinksIfMissing(n,[s.LinkRelation.MANIFEST],o).then((()=>s.getCompositeManifest(this._service,n,t,r,o)))}getManifestAndComponentsByPath(e,t,r,o,n){return s.getManifestAndComponentsByPath(this.serviceConfig.service,e,t,r,o,n)}getRendition(e,t,r,o,n){return this.fetchLinksIfMissing(e,[s.LinkRelation.RENDITION]).then((()=>s.getRendition(this._service,e,t,r,o,n)))}getCompositeComponentUrlForDownload(e,t,r,o,n){var i;const a=this._getAsAdobeAsset(e),d=null!==(i=this._isDCXComponentLike(e)?e.length:r)&&void 0!==i?i:0,{id:c,revision:l}=this._resolveComponentIdAndRevision(e,t,o);return d>this.blockDownloadThreshold?s.getCompositeComponentPresignedUrl(this.serviceConfig,a,c,l,n).then((({response:e,result:t})=>({response:e,isPresignedUrl:!0,url:t}))):this.getCompositeComponentUrl(a,c,l,n).then((e=>({response:void 0,url:e,isPresignedUrl:!1})))}getCompositeComponentUrl(e,t,r,o){const n=this._getAsAdobeAsset(e),{id:i,revision:a}=this._resolveComponentIdAndRevision(e,t,r,!1);return this.fetchLinksIfMissing(n,[s.LinkRelation.COMPONENT],o).then((()=>(d.validateParams(["asset",n,"object"],["componentId",i,"string"],["componentRevision",a,"string",!0]),s.getCompositeComponentUrl(this._service,n,i,a))))}getCompositeComponentByPath(e,t,r,o,n){return s.getCompositeComponentByPath(this._service,this._getAsAdobeAsset(e),t,r,o,n)}getCompositeComponent(e,t,r,o,n,i){const c=this._getAsAdobeAsset(e),{id:l,revision:h}=this._resolveComponentIdAndRevision(e,t,r);return c.assetId&&a.setTracingSpanAttribute("assetId",c.assetId),t&&a.setTracingSpanAttribute("componentId",t),i&&a.setTracingSpanAttribute("componentSize",String(i)),this.fetchLinksIfMissing(c,[s.LinkRelation.COMPONENT],n).then((()=>(d.validateParams(["asset",e,"object"],["componentId",l,"string"],["componentRevision",h,"string"],["responseType",o,"enum",!0,s.STREAMABLE_RESPONSE_TYPES]),s.getCompositeComponent(this._service,c,l,h,o,n,this._isDCXComponentLike(e)?e.length:i))))}putCompositeComponent(e,t,r,o,n,i,c,h,u,p){if(d.validateParams(["asset",e,"object"],["componentId",t,"string"],["contentType",o,"string"],["maybeIsNew",n,"boolean",!0],["size",i,"number",!0],["md5",c,"string",!0]),n&&!d.verifyUuid(t))throw new l.default(l.default.INVALID_PARAMS,"Component id is not a uuid");d.verifyUuid(t)||A.warn("Existing component id is not a uuid");const _=this._getAsAdobeAsset(e);return(_.assetId||_.id)&&a.setTracingSpanAttribute("assetId",_.assetId||_.id),a.setTracingSpanAttribute("componentId",t),i&&a.setTracingSpanAttribute("componentSize",String(i)),this.fetchLinksIfMissing(_,[s.LinkRelation.COMPONENT,s.LinkRelation.BLOCK_UPLOAD_INIT],u).then((()=>s.putCompositeComponent(this.serviceConfig,e,t,r,o,n,i,c,h,u,p)))}getCompositeComponentsUrlsForUpload(e,t,r){return s.getCompositeComponentsUrlsForUpload(this._service,e,t,r)}performBulkRequest(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.BULK_REQUEST],o).then((()=>s.performBulkRequest(this._service,e,t,r,o)))}updateCompositeManifest(e,t,r,o=1,n,i){E("updateCompositeManifest()"),d.validateParams(["asset",e,"object"],["manifest",t,["object","string"]],["overwrite",r,"boolean"],["validationLevel",o,"+number"],["etag",n,"string",!0]);const a=this._getAsAdobeAsset(e);return this.fetchLinksIfMissing(a,[s.LinkRelation.MANIFEST],i).then((()=>s.updateCompositeManifest(this._service,a,t,r,o,n,i)))}patchVersions(e,t,r,o){return d.validateParams(["asset",e,"object"],["patchDoc",t,["string","array"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY],o).then((()=>s.patchVersions(this._service,e,t,r,o)))}patchACLPolicy(e,t,r,o){return d.validateParams(["asset",e,"object"],["policy",t,["string","object"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY],o).then((()=>s.patchACLPolicy(this._service,e,t,r,o)))}deleteACLPolicy(e,t){return d.validateParams(["asset",e,"object"]),this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY],t).then((()=>s.deleteACLPolicy(this._service,e,t)))}copyAsset(e,t,r,o,n,i,a){return s.copyAsset(this.serviceConfig,e,t,r,o,n,i,a)}moveAsset(e,t,r,o,n,i){return a.setTracingSpanAttribute("sourceAsset.assetId",e.assetId),a.setTracingSpanAttribute("targetAsset.assetId",t.assetId),s.moveAsset(this.serviceConfig,e,t,r,o,n,i)}deleteAsset(e,t,r,o){return s.deleteAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r,o).then((t=>(this._linksCache.deleteWithAsset(e),t)))}discardAsset(e,t,r,o){return s.discardAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r,o)}restoreAsset(e,t,r){return s.restoreAsset(this.serviceConfig,e,t,r)}packageAssets(e,t,r,o,n){return s.packageAssets(this.serviceConfig,e,t,r,o,n)}performOperation(e,t){return s.getOpsHref(this.serviceConfig,t).then((r=>s.doOperation(this._service,r,e,t)))}performBatchOperation(e,t){return s.getOpsHref(this.serviceConfig).then((r=>s.doBatchOperation(this._service,r,e,t)))}uploadResultsFromAdobeRepoUploadResult(e,t){return g(this,e,t)}updateCachedAssetLinks(e){if(!e.assetId)throw new l.default(l.default.INVALID_PARAMS,"Asset must contain an assetId");this._linksCache.setValueWithAsset(e.links||e._links,e)}updateCachedIndexLinks(e){if(!e)throw new l.default(l.default.INVALID_PARAMS,"Index LinkSet must not be null");this._linksCache.setIndexLinks(e)}getLinksCache(){return this._linksCache}setLinksCache(e){this._linksCache=e}clearLinksCache(){this._linksCache.clear()}_resolveComponentIdAndRevision(e,t,r,o=!0){var n;if(this._isDCXComponentLike(e))return{revision:e.version,id:e.id};if(!t)throw new l.default(l.default.INVALID_PARAMS,"Missing componentId.");if(!1===o||r)return{revision:r,id:t};if(!s.isAdobeDCXCompositeLike(e)||!t)throw new l.default(l.default.INVALID_PARAMS,"Could not determine component revision");const i=null===(n=e.current)||void 0===n?void 0:n.getComponentWithId(t);if(void 0===(null==i?void 0:i.version))throw new l.default(l.default.INVALID_PARAMS,"Could not determine component revision");return{revision:i.version,id:t}}_isDCXComponentLike(e){return!!d.isObject(e)&&null!=e.owner&&s.isAdobeDCXBranchLike(e.owner)}_withSourcePromise(e){return h.default.resolve(void 0,e)}_getAsAdobeAsset(e){if("object"!=typeof e||Array.isArray(e))throw new l.default(l.default.INVALID_PARAMS,"Invalid asset-like object.");if(s.isMinimalAdobeAsset(e))return e;let t,r={};if(("repositoryId"in e||"assetId"in e||"links"in e||"version"in e)&&(r={repositoryId:e.repositoryId,assetId:e.assetId,links:e.links,version:e.version}),this._isDCXComponentLike(e)&&"state"in e&&delete r.version,s.isAdobeDCXBranchLike(e)&&(t=e._core),this._isDCXComponentLike(e)||t){const s=e,o=t||(s&&s.owner&&s.owner._core?s.owner._core:void 0);if(o){const e=o._getSourceAssetInfoOfComponent(r);e&&"object"==typeof e&&(r.assetId=e.compositeAssetId||r.assetId,r.repositoryId=e.compositeRepositoryId||r.repositoryId,r.links=e.links||r.links,r.version=e.version||r.version)}}const o=e,n=e;return r.assetId=r.assetId?r.assetId:o.owner?o.owner.compositeAssetId:n.compositeAssetId,r.repositoryId=r.repositoryId?r.repositoryId:o.owner?o.owner.compositeRepositoryId:n.compositeRepositoryId,r}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new l.default(l.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}_resolveUrl(e){return d.endPointOf(e)?e:d.appendPathElements(this._service._repoAPIBaseUrl||this._service.server,e)}registerLinks(e,t,r){e=e._links||e;const s={assetId:r||"urn:aaid:faux:"+d.generateUuid(),repositoryId:t||"faux-repo-id"};return this._linksCache.setValueWithAsset(e,s),s}},u([a.trace],t.AdobeRepoAPISession.prototype,"getRepoMetadata",null),u([a.trace],t.AdobeRepoAPISession.prototype,"getAppMetadata",null),u([a.trace],t.AdobeRepoAPISession.prototype,"getCompositeComponent",null),u([a.trace],t.AdobeRepoAPISession.prototype,"putCompositeComponent",null),u([a.trace],t.AdobeRepoAPISession.prototype,"moveAsset",null),t.AdobeRepoAPISession=u([a.traceableAs("AdobeRepoAPISession")],t.AdobeRepoAPISession),t.CURRENT_COMPONENT_DESCRIPTOR_HASH_TYPE="md5",t.CURRENT_COMPONENT_DESCRIPTOR_VERSION="0",t.createRepoAPISession=(e,r,s)=>new t.AdobeRepoAPISession(e,r,s),t.createUploadRecord=m,t.createUploadResults=f,t.uploadResultsFromAdobeRepoUploadResult=g,t.uploadResultsFromComponentDescriptor=function(e){let t;d.validateParams(["decriptor",e,"string"]);try{t=JSON.parse(e)}catch(e){throw new l.default(l.default.INVALID_JSON,"Invalid component descriptor",e)}switch(t.versionId){case"0":case void 0:if(!t.repositoryId)throw new l.default(l.default.INVALID_DATA,"Component descriptor missing repositoryId");try{const e=f(t.compositeId,t.cloudAssetId,t.repositoryId),r=m(t.componentId,t.etag,t.componentRevisionId,t.hashValue,t.size,t.type);return e.addUploadRecord(t.componentId,r),e}catch(e){throw new l.default(l.default.INVALID_DATA,"Invalid component descriptor",e)}default:throw new l.default(l.default.INVALID_DATA,"ComponentDescriptor serialization versionId not valid or not yet handled.")}}},251890:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(436246),o=r(501888);var n=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(o);function i(e,t,r){const s=function(...s){const i=n.default.trace.getTracer("dcx-js","9.16.0").startSpan(e);r&&i.setAttributes(r);const a=n.default.trace.setSpan(n.default.context.active(),i);try{const e=n.default.context.with(a,(()=>t.apply(this,s)));return i.setStatus({code:o.SpanStatusCode.OK}),e&&e instanceof Promise?e.catch((e=>{throw e instanceof Error&&(i.recordException(e),i.setStatus({code:o.SpanStatusCode.ERROR,message:e.message})),e})).finally((()=>{i.end()})):(i.end(),e)}catch(e){throw e instanceof Error&&(i.recordException(e),i.setStatus({code:o.SpanStatusCode.ERROR,message:e.message})),i.end(),e}};return Object.defineProperties(s,{name:{value:t.name},length:{value:t.length}}),s}t.setTracingSpanAttribute=function(e,t){var r;null===(r=n.default.trace.getActiveSpan())||void 0===r||r.setAttribute(e,t||"")},t.telemetrySpan=i,t.trace=function(e,t,r){var o;let n;s.isAnyFunction(e)&&(null===(o=e.prototype)||void 0===o?void 0:o.constructor)?n=e.prototype.constructor:"object"==typeof e&&e.constructor&&(n=e.constructor);const a=r.value;return r.value=function(...e){let r=t;if(n){let e;e=s.isAnyFunction(n.traceableAs)?n.traceableAs():n.name,r=e+"."+r}return i(r,a).apply(this,e)},r},t.traceableAs=function(e){return function(t){t.traceableAs=()=>e}}},436246:(e,t,r)=>{var s=r(501158).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(921769),n=r(413209);const i=e=>a(e)&&(d(e.pipe)||d(e.pipeTo)),a=e=>null!=e&&"object"==typeof e,d=e=>"function"==typeof e,c=e=>Array.isArray(e),l=()=>{try{return"[object process]"===Object.prototype.toString.call(r.g.process)}catch(e){return!1}},h=()=>"object"==typeof self&&self.self===self,u=()=>"browser",p=(...e)=>!e||!Array.isArray(e)||e.length<1?{}:e.reduce(((e,t)=>{const r=a(e)?e:{};if(a(t))for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(r[e]=t[e]);return r})),_=(e,...t)=>{if(!t.length)return e;const r=t.shift();if(a(e)&&a(r))for(const t in r)a(r[t])&&!c(r[t])?(e[t]||Object.assign(e,{[t]:{}}),_(e[t],r[t])):c(e[t])&&c(r[t])?Object.assign(e,{[t]:r[t]}):Object.assign(e,{[t]:r[t]});return _(e,...t)},f=/^(CON|PRN|AUX|NUL|COM\d|LPT\d)(\..+)?$/,m=/[\u0000-\u001F\u0022\u002A\u003A\u003C\u003E\u003F\u005C\u007F\u007C]/,g=(e,t=!1)=>{try{if(e.length>65535)return!1;const r=(t?e.slice(1):e).split("/");if(!r||0===r.length)return!1;for(const e of r){if(e.length<1||e.length>255)return!1;if(m.test(e))return!1;if(e.endsWith(".")||e.endsWith(" "))return!1;if(f.test(e))return!1;if(e.startsWith("dcx")||e.startsWith(".dcx"))return!1;if("manifest"===e||"mimetype"===e)return!1}return!(t&&(!e.startsWith("/")||e.endsWith("/")))}catch(e){return!1}},E=()=>{},A=(e,t,r)=>{const s={};let o,n=Object.keys(e),i=n.length;for(let d=0;d<i;d++){if(o=n[d],!r||!r[o]){const s=e[o],n=t[o];if(typeof s!=typeof n)return!1;if(a(s)&&a(n)){if(!A(s,n,r))return!1}else if(s!==n)return!1}s[o]=!0}n=Object.keys(t),i=n.length;for(let e=0;e<i;e++)if(o=n[e],!s[o])return!1;return!0},y=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),D=e=>{const t=e.match(y)||[];return{scheme:t[2],authority:t[4],path:t[5],query:t[7],fragment:t[9]}},C="0".charCodeAt(0),I="1".charCodeAt(0),v="9".charCodeAt(0),T="a".charCodeAt(0),b="A".charCodeAt(0),P="f".charCodeAt(0),R="F".charCodeAt(0),w=e=>{const t=e.charCodeAt(0);return t>=C&&t<=v||t>=T&&t<=P||t>=b&&t<=R},O=e=>e.length>=3&&"%"===e.charAt(0)&&w(e.charAt(1))&&w(e.charAt(2)),S=e=>{const t=e.charCodeAt(0);return t>=C&&t<=v?t-C:t>=T&&t<=P?10+t-T:t>=b&&t<=R?10+t-b:0},k="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.~",N="0123456789ABCDEF",L=e=>{const t=[];for(let r=0;r<128;++r)t.push(-1!==e.indexOf(String.fromCharCode(r)));return t},M=L(k+":/?#[]@!$&'()*+,;="),X=L(k),x=L(k+"/"),B=(e,t)=>{if(e<128&&t[e])return String.fromCharCode(e);let r="%";return r+=N.charAt(e>>4&15),r+=N.charAt(15&e),r},j=e=>{const t=[];for(let r=0;r<e.length;r++){let s=e.charCodeAt(r);s<128?t.push(s):s<2048?t.push(192|s>>6,128|63&s):s<55296||s>=57344?t.push(224|s>>12,128|s>>6&63,128|63&s):++r<e.length&&(s=65536+((1023&s)<<10|1023&e.charCodeAt(r)),t.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s))}return t},U=(e,t)=>{const r=j(e);let s="";for(let e=0;e<r.length;e++)s+=B(r[e],t);return s},V=e=>(e=e.normalize("NFC"),U(e,X)),H=e=>{e=e.normalize("NFC");let t=0,r="";for(;t<e.length;)O(e.substr(t))?(r+=e.substr(t,3),t+=3):r+=U(e.charAt(t++),M);return r},F=(e,t)=>{let r=0,s="",o=!1,n=!1,i=!1,a=!0,d=!0,c=!1,l="",h="",u=",",p=-1;const _=e=>{if(s+=a?h:c||d?u:",",n&&l&&(a||c||d)&&(s+=V(l),(!i||e.length>0)&&(s+="=")),e){let t;t=o?H(e):V(e),p>0&&(t=((e,t)=>{let r=0;for(;r<e.length&&t>0;){if(O(e.substr(r))){let t=(S(e.substr(r+1))<<4)+S(e.substr(r+2));if(r+=3,!(192&~t))for(;r<e.length&&O(e.substr(r))&&(t=(S(e.substr(r+1))<<4)+S(e.substr(r+2)),r+=3,128==(192&t)););}else++r;--t}return e.substr(0,r)})(t,p)),s+=t}a=!1,d=!1};for(;r<e.length;)if("{"===e.charAt(r)){if(++r<e.length){switch(o=!1,n=!1,h="",u=",",i=!1,e.charAt(r++)){case"+":o=!0;break;case"#":h="#",o=!0;break;case".":h=".",u=".";break;case"/":h="/",u="/";break;case";":h=";",u=";",n=i=!0;break;case"?":h="?",u="&",n=!0;break;case"&":h="&",u="&",n=!0;break;default:--r}for(l="",a=!0,d=!0;r<e.length;)if("}"===e.charAt(r)||","===e.charAt(r)||"*"===e.charAt(r)||":"===e.charAt(r)){if(c=!1,p=-1,"*"===e.charAt(r)){if(c=!0,++r>=e.length)break}else if(":"===e.charAt(r)){if(++r>=e.length)break;for(e.charCodeAt(r)>=I&&e.charCodeAt(r)<=v&&(p=0);r<e.length&&e.charCodeAt(r)>=C&&e.charCodeAt(r)<=v&&p<1e4;)p=10*p+(e.charCodeAt(r++)-C);if(r>=e.length)break}for(;r<e.length&&"}"!==e.charAt(r)&&","!==e.charAt(r);)++r;if(l.length>0&&"*"===l.charAt(l.length-1)&&(c=!0,l=l.substr(0,l.length-1)),l.length>0){const e=t?t[l]:void 0;if(e||""===e)if(Array.isArray(e)){p=-1;for(let t=0;t<e.length;t++)_(String(e[t]))}else if("object"==typeof e&&null!==e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(f=t,m=String(e[t]),s+=a?h:c||d?u:",",n&&l&&a&&!c&&(s+=V(l),(!i||m.length>0)&&(s+="=")),f&&(s+=o?H(f):V(f),s+=c?"=":",",m&&(s+=o?H(m):V(m))),a=!1,d=!1);else _(String(e))}if("}"===e.charAt(r++))break;l="",d=!0}else l+=e.charAt(r++)}}else O(e.substr(r))?(s+=e.substr(r,3),r+=3):s+=U(e.charAt(r++),M);var f,m;return s},Y=(e,t)=>e&&t?e.indexOf(t):-1,W=e=>e?e.search("(text|image|audio|video|ingredient|document|model|application|font)\\/"):-1;function z(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}function G(e){return this instanceof G?(this.v=e,this):new G(e)}function q(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,o=r.apply(e,t||[]),n=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){o[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof G?Promise.resolve(r.value.v).then(d,c):l(n[0][2],r)}catch(e){l(n[0][3],e)}var r}function d(e){a("next",e)}function c(e){a("throw",e)}function l(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}function K(e,t){return e?(null!=t&&(e=e.slice(0,t)),(new TextDecoder).decode(e)):""}function $(e){return(new TextEncoder).encode(e)}const J=[/^(?!^501$|^507$)^(5\d{2})$|429|423$/],Z=(e,t)=>{return"object"==typeof(r=e)&&"function"==typeof r.test?e.test(t.toString()):t===e;var r},Q=/^([^:]+):(.*)$/,ee=/^\s+|\s+$/g,te=(e,t,r)=>c(t)?new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' type must be one of: [${t.join(",")}].${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`):new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' must be of type '${t}'.${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`),re=(e,t,r,s=!1,o=[])=>{if(s&&null==t)return!0;if(c(r)){for(const n in r){const i=r[n];try{return re(e,t,i,s,o),!0}catch(e){}}throw te(e,r,o)}if("null"===r&&null!==t||"undefined"===r&&void 0!==t||"nullish"===r&&null!=t)throw te(e,r,o);if("null"===r||"undefined"===r||"nullish"===r)return!0;if(!s&&null==t)throw te(e,r,o);if(r.endsWith("[]")){if(!c(t))throw te(e,r,o);return t.forEach(((t,s)=>{re(`${e}[${s}]`,t,r.substr(0,r.length-2))})),!0}let n=r.toLowerCase();switch(r){case"integer":case"+number":case"-number":n="number"}if("array"===n){if(!c(t))throw te(e,r,o)}else if("enum"!==n){if(typeof t!==n)throw te(e,r,o);if("integer"===r&&("number"!=typeof t||!Number.isInteger(t)))throw te(e,r,o);if("+number"===r&&("number"!=typeof t||t<0))throw te(e,r,o);if("-number"===r&&("number"!=typeof t||t>0))throw te(e,r,o)}if(o.length>0){const s=o.length;let n=!1;for(let e=0;e<s;e++)if(o[e]===t){n=!0;break}if(!n)throw te(e,r,o)}return!0};function se(...e){return e.map((e=>re(...e)))}function oe(e,t){const r={};for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&void 0!==e[t]&&(r[t]=1);for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&delete r[e];return Object.keys(r)}function ne(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function ie(e,t,r,s=ie){if(e===t)return[];const o=c(e),n=c(t);return o&&n?function(e,t,r,s){const o={"0,0":{operations:[],cost:0}},n=isNaN(e.length)||e.length<=0?0:e.length,i=isNaN(t.length)||t.length<=0?0:t.length,a=function r(n,i){const a=`${n},${i}`;let d=o[a];if(void 0===d){if(n>0&&i>0&&!s(e[n-1],t[i-1],new ce).length)d=r(n-1,i-1);else{const s=[];if(n>0){const e=r(n-1,i),t={op:"remove",index:n-1};s.push(ne(e,t))}if(i>0){const e=r(n,i-1),o={op:"add",index:n-1,value:t[i-1]};s.push(ne(e,o))}if(n>0&&i>0){const o=r(n-1,i-1),a={op:"replace",index:n-1,original:e[n-1],value:t[i-1]};s.push(ne(o,a))}d=s.sort(((e,t)=>e.cost-t.cost))[0]}o[a]=d}return d}(n,i).operations,[d]=a.reduce((([e,t],o)=>{if(function(e){return"add"===e.op}(o)){const s=o.index+1+t,i=s<n+t?String(s):"-",a={op:o.op,path:r.add(i).toString(),value:o.value};return[e.concat(a),t+1]}if(function(e){return"remove"===e.op}(o)){const s={op:o.op,path:r.add(String(o.index+t)).toString()};return[e.concat(s),t-1]}const i=r.add(String(o.index+t)),a=s(o.original,o.value,i);return[e.concat(...a),t]}),[[],0]);return d}(e,t,r,s):!o&&!n&&a(e)&&a(t)?function(e,t,r,s){const o=[];return oe(e,t).forEach((e=>{o.push({op:"remove",path:r.add(e).toString()})})),oe(t,e).forEach((e=>{o.push({op:"add",path:r.add(e).toString(),value:t[e]})})),function(e){const t=e.length,r={};for(let s=0;s<t;s++){const t=e[s];for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&(r[e]=(r[e]||0)+1)}for(const e in r)r[e]<t&&delete r[e];return Object.keys(r)}([e,t]).forEach((n=>{o.push(...s(e[n],t[n],r.add(n)))})),o}(e,t,r,s):[{op:"replace",path:r.toString(),value:t}]}function ae(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function de(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}class ce{constructor(e=[""]){this.tokens=e}static fromJSON(e){const t=e.split("/").map(ae);if(""!==t[0])throw new n.DCXError(n.DCXError.INVALID_DATA,`Invalid JSON Pointer: ${e}`);return new ce(t)}toString(){return this.tokens.map(de).join("/")}evaluate(e){let t=null,r="",s=e;for(let e=1,o=this.tokens.length;e<o;e++)t=s,r=this.tokens[e],s=(t||{})[r];return{parent:t,key:r,value:s}}get(e){return this.evaluate(e).value}set(e,t){let r=e;for(let e=1,t=this.tokens.length-1,s=this.tokens[e];e<t;e++)r=(r||{})[s];r&&(r[this.tokens[this.tokens.length-1]]=t)}push(e){this.tokens.push(e)}add(e){const t=this.tokens.concat(String(e));return new ce(t)}}class le{get operations(){return this._operations}constructor(e=[]){this._operations=e}getDocument(){return JSON.stringify(this._operations)}add(e,t){return se(["path",e,"string"]),this._operations.push({op:"add",path:e,value:t}),this}addToList(e,t,r){if(se(["path",e,"string"]),"number"!=typeof r&&"end"!==r&&"-"!==r)throw new n.DCXError(n.DCXError.INVALID_PARAMS,'Index must be a number, or either "end"/"-" to append to end.');return this._operations.push({op:"add",value:t,path:`${e.endsWith("/")?e:e+"/"}${"end"===r?"-":r}`}),this}remove(e){return se(["path",e,"string"]),this._operations.push({op:"remove",path:e}),this}replace(e,t){return se(["path",e,"string"]),this._operations.push({op:"replace",path:e,value:t}),this}move(e,t){return se(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"move",from:e,path:t}),this}copy(e,t){return se(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"copy",from:e,path:t}),this}}function he(e,t){return{property:e,issue:t}}function ue(e){const t=[];if("object"!=typeof e||null==e||c(e))return t.push(he("*","Operation not an object.")),t;switch("string"!=typeof e.path&&t.push(he("path","Missing or invalid.")),e.op){case"remove":break;case"add":case"replace":null==e.value&&t.push(he("value","Missing or invalid. Required for add/replace."));break;case"move":case"copy":"string"!=typeof e.from&&t.push(he("from","Missing or invalid. Required for move/copy."));break;default:t.push(he("op","Missing or invalid."))}return!(t.length>0)||t}function pe(e,t={mode:"id"}){let r=e[0],s=0;for(const o of e){let e=0;for(const r in o)r in t&&o[r]===t[r]&&e++;e>s&&(s=e,r=o)}return r}function _e(e){if(!a(e))throw new Error("Expecting object");const t={};for(const r in e)null!=e[r]&&(t[r]=e[r]);return t}const fe=/^utf-?8|ascii|utf-?16-?le|ucs-?2|base-?64|latin-?1$/i,me=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,ge=/\s|\uFEFF|\xA0/,Ee=/\r?\n[\x20\x09]+/g,Ae=/[;,"]/,ye=/[;,"]|\s/;function De(e){return e.replace(me,"")}function Ce(e){return ge.test(e)}function Ie(e,t){for(;Ce(e[t]);)t++;return t}function ve(e){return ye.test(e)}class Te{constructor(e){this.refs=[],e&&this.parse(e)}rel(e){const t=[];for(let r=0;r<this.refs.length;r++)this.refs[r].rel===e&&t.push(this.refs[r]);return t}get(e,t){e=e.toLowerCase();const r=[];for(let s=0;s<this.refs.length;s++)this.refs[s][e]===t&&r.push(this.refs[s]);return r}set(e){return this.refs.push(e),this}has(e,t){e=e.toLowerCase();for(let r=0;r<this.refs.length;r++)if(this.refs[r][e]===t)return!0;return!1}parse(e,t=0){let r=t?e.slice(t):e;r=De(r).replace(Ee,"");let s=1;const o=r.length;let n=0,i=null;for(;n<o;)if(1===s){if(Ce(r[n])){n++;continue}if("<"!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);{const e=r.indexOf(">",n);if(-1===e)throw new Error("Expected end of URI delimiter at offset "+n);i={uri:r.slice(n+1,e)},this.refs.push(i),n=e,s=2}n++}else if(2===s){if(Ce(r[n])){n++;continue}if(";"===r[n])s=4,n++;else{if(","!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);s=1,n++}}else{if(4!==s)throw new Error('Unknown parser state "'+s+'"');{if(";"===r[n]||Ce(r[n])){n++;continue}const e=r.indexOf("=",n);if(-1===e)throw new Error("Expected attribute delimiter at offset "+n);const t=De(r.slice(n,e)).toLowerCase();let a="";if(n=e+1,n=Ie(r,n),'"'===r[n])for(n++;n<o;){if('"'===r[n]){n++;break}"\\"===r[n]&&n++,a+=r[n],n++}else{let e=n+1;for(;!Ae.test(r[e])&&e<o;)e++;a=r.slice(n,e),n=e}if(i&&i[t]&&Pe(t));else if(i&&"*"===t[t.length-1])i[t]=we(a);else if(a="rel"===t||"type"===t?a.toLowerCase():a,i&&null!=i[t]){const e=i[t];c(e)?e.push(a):i[t]=[i[t],a]}else{if(!i)throw new Error("Unexpected null ref");i[t]=a}switch(r[n]){case",":s=1;break;case";":s=4}n++}}return i=null,this}toString(){const e=[];let t,r="";for(let s=0;s<this.refs.length;s++)t=this.refs[s],r=Object.keys(this.refs[s]).reduce((function(e,r){return"uri"===r?e:e+"; "+Oe(r,t[r])}),"<"+t.uri+">"),e.push(r);return e.join(", ")}}const be=e=>fe.test(e),Pe=e=>"rel"===e||"type"===e||"media"===e||"title"===e||"title*"===e,Re=e=>e.replace(/"/g,'\\"'),we=e=>{const t=/([^']+)?(?:'([^']+)')?(.+)/.exec(e)||[];return{language:t[2].toLowerCase(),encoding:be(t[1])?null:t[1].toLowerCase(),value:be(t[1])?decodeURIComponent(t[3]):t[3]}},Oe=(e,t)=>Array.isArray(t)?t.map((t=>Oe(e,t))).join("; "):"*"===e[e.length-1]||"string"!=typeof t?((e,t)=>{const r=(t.encoding||"utf-8").toUpperCase(),o=t.language||"en";let n="";return n=s.isBuffer(t.value)&&be(r)?t.value.toString(r):s.isBuffer(t.value)?t.value.toString("hex").replace(/[0-9a-f]{2}/gi,"%$1"):encodeURIComponent(t.value),e+"="+r+"'"+o+"'"+n})(e,t):((e=>"rel"===e||"type"===e||"anchor"===e)(e)?t=ve(t)?'"'+Re(t)+'"':Re(t):ve(t)&&(t='"'+(t=(t=encodeURIComponent(t)).replace(/%20/g," ").replace(/%2C/g,",").replace(/%3B/g,";"))+'"'),e+"="+t);function Se(e,t,r,s="id"){const o=Me(e)[t];if(o){if(Array.isArray(o)){const e=o.filter((e=>e.mode===s));return e.length>0?e[0][r]:o.length>0?o[0][r]:void 0}return o[r]}}function ke(e,t,r="id"){const s=Me(e),o=s[t];let i;if(a(o)&&"string"==typeof o.href?i=o.href:Array.isArray(o)&&(i=Se(s,t,"href",r)),"string"!=typeof i)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Missing or invalid link href.");return i}function Ne(e,t,r,s="id"){const o=ke(Me(e),t,s);return F(o,_e(r))}const Le=(e,t=0)=>(new Te).parse(e,t);function Me(e){return a(e)?"_links"in e?e._links:"links"in e?e.links:e:{}}let Xe;const xe=()=>{if(Xe)return Xe;const e=l();return Xe=e&&a(r.g.performance)&&d(r.g.performance.now)?r.g.performance:e&&a(r.g.perf_hooks)&&a(r.g.perf_hooks.performance)&&d(r.g.perf_hooks.performance.now)?r.g.perf_hooks.performance:h()&&a(self.performance)&&d(self.performance.now)?self.performance:Date,Xe},Be=()=>xe().now(),je=e=>z(void 0,void 0,void 0,(function*(){return new Promise((t=>setTimeout(t,e)))})),Ue=Object.freeze({__proto__:null,Link:Te,getLinkProperty:Se,getLinkHref:ke,getLinkHrefTemplated:Ne,parse:Le});t.DEFAULT_RETRY_CODES=J,t.EventEmitter=class{constructor(e){this._handlers={},e.forEach((e=>{this._handlers[e]=[]}))}on(e,t){return this._handlers[e].push(t)-1}emit(e,t){this._handlers[e].forEach((e=>{d(e)&&e(...t)}))}removeHandler(e,t){delete this._handlers[e][t]}removeAllHandlers(e){e?this._handlers[e]=[]:this._handlers={}}},t.JSONPatchPointer=ce,t.Link=Te,t.LinkUtils=Ue,t.SDKType=u,t.WatchProxy=function(e){if(e.__watch_proxy__)return e;if("watchProperty"in e)throw new Error("Cannot proxy object, watchProperty already exists.");let t={};const r=((e,r)=>{t[e]=t[e]||[],t[e].push(r)}).bind({listeners:t}),s={set:function(e,r,s){try{r in t&&c(t[r])&&t[r].map((t=>t.call(void 0,s,e[r],e)))}catch(e){throw e}return e[r]=s,!0}},{proxy:o,revoke:n}=Proxy.revocable(e,s);return Object.defineProperty(o,"__watch_proxy__",{value:!0,enumerable:!1,configurable:!0}),Object.defineProperty(o,"revokeWatchProxy",{value:()=>(n(),t={},delete e.__watch_proxy__,delete e.revokeWatchProxy,delete e.watchProperty,e),enumerable:!1,configurable:!0}),Object.defineProperty(o,"watchProperty",{value:r,enumerable:!1,configurable:!0}),o},t._toUTF8Array=j,t.appendPathElements=(...e)=>{if(!e||!Array.isArray(e))return"";const t=[],r=e.length;for(let s=0;s<r;s++){let o=e[s];"string"==typeof o&&""!==o&&(0===s&&1!==o.length||"/"===o.charAt(0)&&(o=o.slice(1)),s!==r-1&&"/"===o.charAt(o.length-1)&&(o=o.slice(0,o.length-1)),t.push(o))}return t.join("/")},t.arrayBufferToString=K,t.assert=(e,t)=>{if(!1===e())throw new n.DCXError(n.DCXError.INVALID_PARAMS,t)},t.asyncIterableFromStream=function(e){return q(this,arguments,(function*(){const t=e.getReader();try{for(;;){const{done:e,value:r}=yield G(t.read());if(e)return yield G(void 0);yield yield G(r)}}finally{t.releaseLock()}}))},t.checkRetriable=function(e,t=J){return!!e&&(Array.isArray(t)?t.some((t=>Z(t,e))):Z(t,e))},t.chunkArray=function(e,t){return e.reduce(((e,r,s)=>(s%t==0?e.unshift([r]):e[0].push(r),e)),[]).reverse()},t.combineInPlace=function(...e){if(e.length<2)return;const t=e.shift();p(t,...e),e.map((e=>{Object.assign(t,e)}))},t.concatUint8Arrays=function(e,t){const r=new Uint8Array(e.length+t.length);return r.set(e,0),r.set(t,e.length),r},t.consumeStream=(e,t,r)=>{e.on("data",r||E),e.on("end",t||E)},t.createJSONPatch=function(e,t,r){const s=new ce;return(r?function(e){return function t(r,s,o){const n=e(r,s,o);return c(n)?n:ie(r,s,o,t)}}(r):ie)(e,t,s)},t.createPatchDocumentBuilder=function(e){return new le(e)},t.dataToBuffer=function(e){return"string"==typeof e?$(e):e},t.deepCopy=e=>JSON.parse(JSON.stringify(e)),t.endPointOf=e=>{const t=D(e),r=t.scheme,s=t.authority,o="https"===r?443:"http"===r?80:-1;let n;return r&&s&&(n=(r+"://"+s).toLowerCase(),o>=0&&s.indexOf(":")<0&&(n=n+":"+o)),n},t.ensureRelativeHrefStartsWithSlash=e=>{if(e){const t=D(e),r=t.scheme,s=t.authority;r||s||"/"!==e.charAt(0)&&(e="/"+e)}return e},t.escapeURLPath=e=>(String.prototype.normalize?e=e.normalize("NFC"):console.warn("String.normalize not found while escaping URL path. You may be missing a polyfill."),e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),U(e,x)),t.expandURITemplate=F,t.flatCopy=e=>{const t={},r=Object.keys(e),s=r.length;for(let o=0;o<s;o++){const s=r[o];t[s]=e[s]}return t},t.generateUuid=()=>o.v4(),t.getDomainFromURL=e=>{if(!e||"string"!=typeof e)return e;const t=(e=(e=(e=(e=e.indexOf("//")>-1?e.split("/")[2]:e.split("/")[0]).split("?")[0]).split("/")[0]).split(":")[0]).split(".");return t.slice(Math.max(t.length-2,0)).join(".")},t.getFirstRegexpCapture=(e,t)=>{if(!e||"string"!=typeof e||!t)return"";let r;return r="string"==typeof t?e.match(t):t.exec(e),r?r[1]:""},t.getLinkHref=ke,t.getLinkHrefTemplated=Ne,t.getLinkProperty=Se,t.getPerformance=xe,t.getStartIdxOfMimeType=W,t.getSuffixIdxOfMimeType=Y,t.hexVal=S,t.isAnyFunction=d,t.isArray=c,t.isArrayBuffer=e=>a(e)&&d(e.constructor)&&"ArrayBuffer"===e.constructor.name&&d(e.slice),t.isArrayBufferView=e=>a(e)&&d(e.constructor)&&"DataView"===e.constructor.name&&a(e.buffer)&&d(e.buffer.slice),t.isBrowser=h,t.isBrowserSDK=()=>!0,t.isBuffer=e=>a(e)&&d(e.constructor)&&"Buffer"===e.constructor.name&&d(e.slice),t.isDefined=e=>null!=e,t.isHexChar=w,t.isJsonContentType=e=>{if("string"!=typeof e)return!1;const t=e.toLowerCase().split("application/");if(t.length<2)return!1;const r=t[1].split(";")[0].trim();return"json"===r||r.endsWith("+json")},t.isNode=l,t.isNodeReadableStream=e=>i(e)&&d(e.on),t.isObject=a,t.isPctEncoding=O,t.isPromise=e=>null!=e&&a(e)&&d(e.then),t.isReadableStream=i,t.isUndefined=e=>null==e,t.isValidAbsolutePath=e=>g(e,!0),t.isValidAdobeURN=e=>/^urn:aaid:[a-zA-Z]{2}:[a-zA-Z0-9]{2,6}:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e),t.isValidPath=g,t.isVoid=e=>null==e,t.isWHATWGReadableStream=e=>i(e)&&d(e.pipeTo),t.isWebWorker=()=>h()&&!!self.WorkerGlobalScope,t.merge=p,t.mergeDeep=_,t.noOp=E,t.normalizeHeaders=e=>{if(null===e||"object"!=typeof e)return{};const t={};for(const[r,s]of Object.entries(e))t[r.toLowerCase()]=c(s)?s.join(";"):s;return t},t.now=Be,t.objectFromEntries=function(e){const t={};for(const[r,s]of e)t[r]=s;return t},t.objectsEqual=A,t.parse=Le,t.parseHeaders=e=>{const t={},r=e.split(/\r?\n/);let s,o;for(let e=0;e<r.length;++e){const n=r[e];if(n.length>0){const e=n.charCodeAt(0);if(!s||9!==e&&32!==e){const e=Q.exec(n);e&&e.length>1&&(s=e[1].toLowerCase(),o=e[2]||"",o=o.replace(ee,""),t[s]?t[s]=t[s]+","+o:t[s]=o)}else t[s]=t[s]+" "+n.replace(ee,"")}}return t},t.parseURI=D,t.provideLink=function(e,t={},r){const s="function"==typeof t.selector?t.selector:pe,o=Array.isArray(e)?s(e,r):e;if(!o)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Could not select appropriate link for usage");return o.templated?"function"==typeof t.expander?t.expander(o.href,r):F(o.href,r):o.href},t.pruneUndefined=_e,t.removeLeadingSlashForPath=e=>(e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),e),t.retriesWithDelayOnError=function e(t,r,s,o,i){return z(this,void 0,void 0,(function*(){return t().catch((a=>z(this,void 0,void 0,(function*(){var d,c,l;if(Be()-s.startTime>=s.timeoutAfter)throw new n.DCXError(n.DCXError.TIMED_OUT,"request aborted due to timeout");o||(o=null===(d=a.response)||void 0===d?void 0:d.response.type);const h=i||1e3*parseInt(null===(c=a.response)||void 0===c?void 0:c.headers["retry-after"],10)||2e3;if((null===(l=a.response)||void 0===l?void 0:l.statusCode)===r&&a.response.response.type===o)return yield je(h),e(t,r,s,o,i);throw a}))))}))},t.safeGet=function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]},t.sleep=je,t.stringToBuffer=$,t.timeStamp=(e=!1)=>{let t=(new Date).getTime();return e&&(t-=t%1e3),t},t.validateJSONPatchDocument=function(e){if(!c(e))return[he("doc","Invalid type.")];const t=[];return e.forEach(((e,r)=>{const s=ue(e);!0!==s&&s.forEach((e=>{e.property=`doc[${r}].${e.property}`,t.push(e)}))})),!(t.length>0)||t},t.validateJSONPatchOperation=ue,t.validateObject=function(e,t,...r){if(t=t?" "+t+" ":" ",!e||"object"!=typeof e)throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid.`);try{r.forEach((t=>{re(t[0],e[t[0]],t[1],t[2]||!1,t[3]||[])}))}catch(e){throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid. ${e.message.replace("Param","Property")}`,e)}},t.validateParam=re,t.validateParams=se,t.verifyUuid=e=>o.validate(e),t.verifyandGetSnapshotMimetype=e=>{const t=K(e,100),r=Y(t,"+dcxucf"),s=W(t);return r>-1&&s>-1?t.substring(s,r+7):""},t.withRetries=function e(t,r=3){return t().catch((s=>{if(r)return e(t,r-1);throw s}))}},777522:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(436246);class o{constructor(e){this._data=e}getElementsByTagName(e){return this._data.children.filter((t=>"string"!=typeof t&&t.tagName===e)).map(i)}}class n extends o{constructor(e){super(e),this._data=e}setAttribute(e,t){this._data.attributes[e]=t}getAttribute(e){return this._data.attributes[e]}appendChild(e,t={},r=[]){const s={tagName:e,attributes:t,children:r};return this._data.children.push(s),i(s)}}function i(e){return new n(e)}class a extends o{constructor(e){super(e)}parse(e){const t=function(e,t={}){let r=t.pos||0;const s=!!t.keepComments,o=!!t.keepWhitespace,n="<".charCodeAt(0),i=">".charCodeAt(0),a="-".charCodeAt(0),d="/".charCodeAt(0),l="!".charCodeAt(0),h="'".charCodeAt(0),u='"'.charCodeAt(0),p="[".charCodeAt(0),_="]".charCodeAt(0);function f(t){const c=[];for(;e[r];)if(e.charCodeAt(r)===n){if(e.charCodeAt(r+1)===d){const s=r+2;if(r=e.indexOf(">",r),-1===e.substring(s,r).indexOf(t)){const t=e.substring(0,r).split("\n");throw new Error("Unexpected close tag\nLine: "+(t.length-1)+"\nColumn: "+(t[t.length-1].length+1)+"\nChar: "+e[r])}return r+1&&(r+=1),c}if(e.charCodeAt(r+1)===l){if(e.charCodeAt(r+2)===a){const t=r;for(;-1!==r&&(e.charCodeAt(r)!==i||e.charCodeAt(r-1)!==a||e.charCodeAt(r-2)!==a||-1===r);)r=e.indexOf(">",r+1);-1===r&&(r=e.length),s&&c.push(e.substring(t,r+1))}else{if(e.charCodeAt(r+2)===p&&e.charCodeAt(r+8)===p&&"cdata"===e.substr(r+3,5).toLowerCase()){const t=e.indexOf("]]>",r);-1===t?(c.push(e.substr(r+9)),r=e.length):(c.push(e.substring(r+9,t)),r=t+3);continue}{const t=r+1;r+=2;let s=!1;for(;(e.charCodeAt(r)!==i||!0===s)&&e[r];)e.charCodeAt(r)===p?s=!0:!0===s&&e.charCodeAt(r)===_&&(s=!1),r++;c.push(e.substring(t,r))}}r++;continue}const o=A();c.push(o),"?"===o.tagName[0]&&(c.push(...o.children),o.children=[])}else{const e=m();(o||e.trim().length>0)&&c.push(e),r++}return c}function m(){const t=r;return r=e.indexOf("<",r)-1,-2===r&&(r=e.length),e.slice(t,r+1)}function g(){const t=r;for(;-1==="\r\n\t>/= ".indexOf(e[r])&&e[r];)r++;return e.slice(t,r)}const E=t.noChildNodes||["img","br","input","meta","link","hr"];function A(){r++;const t=g(),s={};let o=[];for(;e.charCodeAt(r)!==i&&e[r];){const n=e.charCodeAt(r);if(n>64&&n<91||n>96&&n<123){const n=g();let a,d=e.charCodeAt(r);for(;d&&d!==h&&d!==u&&!(d>64&&d<91||d>96&&d<123)&&d!==i;)r++,d=e.charCodeAt(r);if(d===h||d===u){if(a=y(),-1===r)return{tagName:t,attributes:s,children:o}}else a=null,r--;s[n]=a}r++}if(e.charCodeAt(r-1)!==d)if("script"===t){const t=r+1;r=e.indexOf("<\/script>",r),o=[e.slice(t,r)],r+=9}else if("style"===t){const t=r+1;r=e.indexOf("</style>",r),o=[e.slice(t,r)],r+=8}else-1===E.indexOf(t)?(r++,o=f(t)):r++;else r++;return{tagName:t,attributes:s,children:o}}function y(){const t=e[r],s=r+1;return r=e.indexOf(t,s),e.slice(s,r)}function D(){const r=new RegExp("\\s"+t.attrName+"\\s*=['\"]"+t.attrValue+"['\"]").exec(e);return r?r.index:-1}let C;if(void 0!==t.attrValue)for(t.attrName=t.attrName||"id",C=[];-1!==(r=D());)r=e.lastIndexOf("<",r),-1!==r&&C.push(A()),e=e.substr(r),r=0;else C=t.parseNode?A():f("");return t.simplify?c(Array.isArray(C)?C:[C]):C}(e);return this._data={children:s.isArray(t)?t:[t]},this}getElementsByTagName(e){return super.getElementsByTagName(e)}toString(){return function(e,t=!1){let r="",s=0;function o(e){if(s+=1,e){t&&e.length>0&&"string"!=typeof e[0]&&(r+="\r\n");for(let t=0;t<e.length;t++)"string"==typeof e[t]?r+=e[t].trim():n(e[t]);t&&e.length>0&&"string"!=typeof e[0]&&!r.endsWith("\r\n")&&(r+="\r\n")}s-=1}function n(e){r+=t?"<".padStart(s)+e.tagName:"<"+e.tagName;for(const t in e.attributes)null===e.attributes[t]?r+=" "+t:-1===e.attributes[t].indexOf('"')?r+=" "+t+'="'+e.attributes[t].trim()+'"':r+=" "+t+"='"+e.attributes[t].trim()+"'";"?"!==e.tagName[0]?(r+=">",o(e.children),t&&r.endsWith("\r\n")?r+="</".padStart(s)+e.tagName+">\r\n":r+=t?"</"+e.tagName+">\r\n":"</"+e.tagName+">"):r+=t?"?>\r\n":"?>"}return o(e),r}(this._data.children)}}function d(e){return(new a).parse(e)}function c(e){const t={};if(!e.length)return"";if(1===e.length&&"string"==typeof e[0])return e[0];e.forEach((function(e){if("object"!=typeof e)return;t[e.tagName]||(t[e.tagName]=[]);const r=c(e.children);t[e.tagName].push(r),Object.keys(e.attributes).length&&(r._attributes=e.attributes)}));for(const e in t)1===t[e].length&&(t[e]=t[e][0]);return t}function l(e){return s.isObject(e)&&s.isArray(e.patchDocument)?e.patchDocument:[]}const h="dcx-js";function u(e,t=h,r=(new Date).toISOString(),o=s.generateUuid()){const n=l(this),i=_(o,e,t,r);return s.createPatchDocumentBuilder(n).add("/xmpMM:History/@list/-",i).replace("/xmpMM:InstanceID",o).replace("/xmp:ModifyDate",r).replace("/xmp:MetadataDate",r).operations}function p(e,t,r){const o=l(this);return s.createPatchDocumentBuilder(o).add(`/${e}:${t}`,r).operations}function _(e,t,r,s){return{"stEvt:action":t,"stEvt:when":s,"stEvt:softwareAgent":r,"stEvt:instanceID":e}}function f(e=h,t,r=s.generateUuid(),o=(new Date).toISOString()){return`<rdf:li\n    stEvt:action="${t}"\n    stEvt:instanceID="xmp.iid:${r}"\n    stEvt:when="${o}"\n    stEvt:softwareAgent="${e}"/>`}function m(e=h,t=s.generateUuid(),r=(new Date).toISOString(),o,n){return o||(o=[f(e,"created",t,r)]),`<x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="Adobe XMP Core 7.1.2">\n        <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">\n            <rdf:Description rdf:about=""\n            xmlns:xmp="http://ns.adobe.com/xap/1.0/"\n            xmlns:xmpMM="http://ns.adobe.com/xap/1.0/mm/"\n            ${n?'xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#"':""}\n            xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#"\n            xmpMM:OriginalDocumentID="xmp.did:${t}"\n            xmp:ModifyDate="${r}"\n            xmp:MetadataDate="${r}"\n            xmp:CreatorTool="${e}"\n            xmp:CreateDate="${r}"\n            xmpMM:DocumentID="xmp.did:${t}"\n            xmpMM:InstanceID="xmp.iid:${t}">\n                <xmpMM:History>\n                    <rdf:Seq>\n                        ${o.join("\n")}\n                    </rdf:Seq>\n                </xmpMM:History>\n                ${n||""}\n            </rdf:Description>\n        </rdf:RDF>\n    </x:xmpmeta>`}function g(e,t,r){const s=e.getElementsByTagName(t),o=e.getAttribute(t);s.length<1&&null==o&&e.setAttribute(t,r)}t.XMLElement=n,t.XMLParser=a,t.appendHistoryEvent=u,t.deleteProperty=function(e,t){const r=l(this);return s.createPatchDocumentBuilder(r).remove(`/${e}:${t}`).operations},t.initializeXMPJSON=function(e=h,t=s.generateUuid(),r=(new Date).toISOString()){return{"xmp:ModifyDate":r,"xmp:MetadataDate":r,"xmp:CreatorTool":e,"@context":{xmpMM:"http://ns.adobe.com/xap/1.0/mm/",stEvt:"http://ns.adobe.com/xap/1.0/sType/ResourceEvent#",xmp:"http://ns.adobe.com/xap/1.0/"},"xmpMM:DocumentID":`xmp.did:${t}`,"xmpMM:History":{"@list":[{"stEvt:softwareAgent":e,"stEvt:action":"created","stEvt:when":r,"stEvt:instanceID":`xmp.iid:${t}`}]},"xmp:CreateDate":r,"@id":"","xmpMM:InstanceID":`xmp.iid:${t}`,"xmpMM:OriginalDocumentID":`xmp.did:${t}`}},t.initializeXMPXML=m,t.makeDerivedWithAction=function(e=h,t,r=s.generateUuid(),o=(new Date).toISOString()){const n=l(this),i=s.createPatchDocumentBuilder(n).add("/@context/stRef","http://ns.adobe.com/xap/1.0/sType/ResourceRef#").add("/@context/xmpMM","http://ns.adobe.com/xap/1.0/mm/").add("/xmpMM:DerivedFrom",{}).copy("/xmpMM:DocumentID","/xmpMM:DerivedFrom/stRef:documentID").copy("/xmp:ModifyDate","/xmpMM:DerivedFrom/stRef:lastModifyDate").copy("/xmpMM:InstanceID","/xmpMM:DerivedFrom/stRef:instanceID").copy("/xmpMM:OriginalDocumentID","/xmpMM:DerivedFrom/stRef:originalDocumentID").replace("/xmpMM:InstanceID",r).replace("/xmpMM:DocumentID",r);return u.call({patchDocument:i.operations},t,e,o,r)},t.makeDerivedWithXML=function(e,t,r,o=(new Date).toISOString()){return e||t||r||(e=s.generateUuid()),`<xmpMM:DerivedFrom\n        stRef:documentID="xmp.did:${t||r||e}"\n        stRef:instanceID="xmp.iid:${r||t||e}"\n        stRef:originalDocumentID="xmp.did:${e||t||r}"\n        stRef:lastModifyDate="${o}"/>`},t.makeHistoryEventXML=f,t.parseXML=d,t.registerNamespace=function(e,t){const r=l(this);return s.createPatchDocumentBuilder(r).add(`/@context/${t}`,e).operations},t.repairXMPXML=function(e,t=h,r=s.generateUuid(),o=(new Date).toISOString()){const n=d(e),i=n.getElementsByTagName("x:xmpmeta");if(i.length<1)return m(t,r,o);const a=i[0].getElementsByTagName("rdf:RDF");if(a.length<1)return m(t,r,o);const c=a[0].getElementsByTagName("rdf:Description");if(c.length<1)return m(t,r,o);const l=c[0];return g(l,"xmp:ModifyDate",o),g(l,"xmp:MetadataDate",o),g(l,"xmp:CreatorTool",t),g(l,"xmp:CreateDate",o),g(l,"xmpMM:DocumentID",`xmp.did:${r}`),g(l,"xmpMM:InstanceID",`xmp.iid:${r}`),g(l,"xmpMM:OriginalDocumentID",`xmp.did:${r}`),function(e){const t=["xmpMM:History","rdf:Seq"];let r=e;for(;t.length>0;){const e=t.shift(),s=r.getElementsByTagName(e);r=s.length>0?s[0]:r.appendChild(e)}}(l),n.toString()},t.setCreatorTool=function(e){return p.call(this,"xmp","CreatorTool",e)},t.setProperty=p,t.updateLastHistoryEvent=function(e,t,r){const o=l(this);if(null==e&&null==t&&null==r)return o;const n=s.createPatchDocumentBuilder(o);let i=_(s.generateUuid(),e,t,r);i=s.pruneUndefined(i);for(const e in i)n.replace(`/xmpMM:History/@list/-/${e}`,i[e]);return n.operations}}}]);
//# sourceMappingURL=vendor-startup-dcx.ce59b63b5896c286163e.js.map